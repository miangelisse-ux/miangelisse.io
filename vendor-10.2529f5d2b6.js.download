"use strict";(window.webpackChunkweb=window.webpackChunkweb||[]).push([["12743"],{933552:function(e,t,a){a.d(t,{N:()=>s});var r=a(834370),n=a(588582),o=a(101887);function s(e){let{whiteboardApp:t}=e;return(0,r.useEffect)(()=>(t.start(),()=>{t.destroy()}),[]),r.createElement("div",{className:"app"},r.createElement(n.V,{gmlRender:t.application.gmlRender,auxiliaryGmlRender:t.auxiliaryApplication.gmlRender}),r.createElement(o.C,{inputManager:t.inputManager,auxiliaryApp:t.auxiliaryApplication}))}},396757:function(e,t,a){a.d(t,{o:()=>r});function r(e){throw Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}},189799:function(e,t,a){a.d(t,{f:()=>n,t:()=>r});var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}},292993:function(e,t,a){a.d(t,{p:()=>r});var r={exports:{}}},268073:function(e,t,a){a.d(t,{Z:()=>o});var r=a(189799),n=(0,a(304780).s)(),o=(0,r.f)(n)},286479:function(e,t,a){a.d(t,{Z:()=>o});var r=a(189799),n=(0,a(689274).s)(),o=(0,r.f)(n)},717568:function(e,t,a){a.d(t,{Z:()=>o});var r=a(189799),n=(0,a(880399).s)(),o=(0,r.f)(n)},224833:function(e,t,a){a.d(t,{p:()=>r});var r={exports:{}}},291418:function(e,t,a){a.d(t,{Z:()=>o});var r=a(189799),n=(0,a(596334).s)(),o=(0,r.f)(n)},101120:function(e,t,a){a.d(t,{p:()=>r});var r={exports:{}}},249238:function(e,t,a){a.d(t,{p:()=>r});var r={exports:{}}},741074:function(e,t,a){a.d(t,{k:()=>eY});var r,n,o,s,i,d,l=a(451935);class c{exec(e,t){this.executeData(e,t)}execRemote(e,t,a){this.executeData(e,t)}}var h=a(78485),u=a(421385);class p extends c{type=l.U.Comment;executeData(e,t){if(e.act===u.T.AddComment){if(t.commentManager.cacheComment){let a=t.commentManager.cacheComment;a.commentID=e.commentID,t.commentManager.addOrUpdateComment(a),e.nodeID=a.nodeID,e.x=a.x,e.y=a.y}t.commentManager.clearCacheComment()}else t.commentManager.applyCommentOp(e);let a=t.commentManager.getAllCommentShowMessage();t.auxiliaryManager.addOrUpdateAuxiliaryDomState(h.l.ShowCommentPins,a)}}var g=a(797615);class f extends c{type=l.U.Resource;exec(e,t){e.resourceType===g._g.Drive&&e.refId&&t.idGenerator.loadResourceId(e.refId)}}class m{executors=new Map;messageExecutors=new Map([[l.U.Comment,new p],[l.U.Resource,new f]]);constructor(e,t){for(let a of(this.execCtx=t,e))this.executors.set(a.type,a)}execUnOrder(e){let t=this.messageExecutors.get(e.type);if(!t)return void console.error("execUnOrder \u7F3A\u4E4F\u5BF9\u5E94\u7684\u6D88\u606F\u5904\u7406\u5668,\u5DF2\u5FFD\u7565\u8BE5\u6D88\u606F");t.exec(e.data,this.execCtx)}execRemoteUnOrder(e,t,a){let r=this.messageExecutors.get(t);if(!r)return void console.error("execUnOrder \u7F3A\u4E4F\u5BF9\u5E94\u7684\u6D88\u606F\u5904\u7406\u5668,\u5DF2\u5FFD\u7565\u8BE5\u6D88\u606F");r.execRemote(e,this.execCtx,a)}exec(e){let t=this.executors.get(e.type);if(!t)return void console.error("\u7F3A\u4E4F\u5BF9\u5E94\u7684\u6D88\u606F\u5904\u7406\u5668,\u5DF2\u5FFD\u7565\u8BE5\u6D88\u606F");t.exec(e,this.execCtx)}execRemote(e,t,a){let r=this.executors.get(t);if(!r)return void console.error("\u7F3A\u4E4F\u5BF9\u5E94\u7684\u6D88\u606F\u5904\u7406\u5668,\u5DF2\u5FFD\u7565\u8BE5\u6D88\u606F");r.execRemote(e,this.execCtx,a)}}var M=a(595258);class w{undoStack=[];redoStack=[];callback=M.Z;add(e){let t=e.reverse();this.undoStack.push(t),this.redoStack=[],this.callback(this.undoStack.length>0,this.redoStack.length>0)}undo(e){let t=this.undoStack.pop()||null;if(!t)return null;for(let a of t.actionLogs)e.exec(a);return this.redoStack.push(t.reverse()),this.callback(this.undoStack.length>0,this.redoStack.length>0),t}redo(e){let t=this.redoStack.pop()||null;if(!t)return null;for(let a of t.actionLogs)e.exec(a);return this.undoStack.push(t.reverse()),this.callback(this.undoStack.length>0,this.redoStack.length>0),t}}class x{exec(e,t){let a=e.data,r=this.reserveLog(a,t);this.executeData(a,t),e.reverseLog=r}execRemote(e,t,a){this.executeData(e,t)}}var C=a(298809),y=a(534301),T=a(161921),S=a(456323),v=a(976780);class R{add(e,t){let a=t.nodeManager.getNode(e.parentId||"")||t.nodeManager.root,r=t.gmlRender.canvas.getContext("2d"),n=S.j.load(e.id,e.props,r,a,e.zIndex,t.auxiliaryManager.globalConfig);try{a.children.splice(e.zIndex,0,n)}catch(e){console.error("\u63D2\u5165\u4F4D\u7F6E\u9519\u8BEF\uFF0C\u964D\u7EA7\u5230\u6700\u540E\u4E00\u4F4D\u63D2\u5165"),a.children.push(n)}n.afterNodeInit?.(t.nodeManager),n.afterUpdateProps?.(),t.idGenerator.loadNode(e.id,e.zIndex),t.nodeManager.addNode(n),this.afterAdd(n,t),e.path=n.getPath(!1)}updateRelatedComments(e,t){if(t.commentManager.nodeHasComments(e.id)){let e=t.commentManager.getAllCommentShowMessage();t.auxiliaryManager.addOrUpdateAuxiliaryDomState(h.l.ShowCommentPins,e)}}updateRelatedMention(e,t){let a=T.I.getInstance(),r=a.getAllMentionUsers(),n=e.getProp(v.d.Text);n&&a.updateMentionUserFromPropsAndNotify({props:n,preMentionUser:r,auxiliaryManager:t.auxiliaryManager})}}var b=a(140512);class O extends R{enable(e){return e.type===g.Jq.MindMapNode}afterAdd(e,t){this.updateRelatedComments(e,t),this.updateRelatedMention(e,t),this.handleMindMap(e,t)}handleMindMap(e,t){let{parentId:a}=e.mindMapProps;if(a){let r=t.nodeManager.getNode(a);if(e.mindMapParent=r,r){e.mindMapRoot=r.mindMapRoot||r,r.mindMapChildren.push(e),t.mindMapManager.add(e.mindMapRoot),b.R.updateMindMapZIndex(r);return}}e.mindMapRoot=e,t.mindMapManager.add(e)}}class k extends R{enable(e){return!0}afterAdd(e,t){this.updateRelatedComments(e,t),this.updateRelatedMention(e,t)}}var D=a(808687);class N extends x{type=l.U.AddNode;handlers=[new O,new k];handleAdd(e,t){for(let a of this.handlers)if(a.enable(e))return void a.add(e,t)}executeData(e,t){let a=0===t.nodeManager.nodeMap.size,r=new Set;for(let a of e){if(t.nodeManager.getNode(a.id)){console.error(`\u{8BE5}\u{8282}\u{70B9}\u{5DF2}\u{5B58}\u{5728}\u{FF0C}\u{91CD}\u{590D}\u{521B}\u{5EFA}\u{8282}\u{70B9}\u{9519}\u{8BEF}\u{FF1A}${JSON.stringify(a)}`);continue}this.handleAdd(a,t),r.add(a.parentId||"")}t.renderManager.addContentDrawTask(),a&&this.updateEmptyState(t),D.D.batchUpdateChildrenZIndex(r,t.nodeManager)}execRemote(e,t){this.executeData(e,t),t.translateManager.onNodePropsUpdate(e.map(e=>({nodeId:e.id,props:e.props})))}reserveLog(e,t){let a=[];for(let t=e.length-1;t>-1;t--){let r=e[t];a.push({id:r.id})}return new C.q(a)}updateEmptyState(e){y.v.notifyNodeEmptyState(e.auxiliaryManager,{isCanvasEmpty:0===e.nodeManager.nodeMap.size})}}var U=a(334918);class E{remove(e,t,a,r){this.onRemove(t,a),this.removeNode(e,t,a,r),this.removeRelatedComments(t,a),this.refreshAuxiliary(t,a)}dumpNode(e,t){let a=t.nodeManager.getParentNodeByParentId(e.parent?.id||"").children.findIndex(t=>t.id===e.id),r=e.serializeTo();return{id:e.id,type:e.type,zIndex:a,props:r.propList,parentId:e.parent?.id}}reserveData(e,t){let a=[],r=this.dumpNode(e,t);for(let n of(a.push(r),e.children))a.push(...this.reserveData(n,t));return a}removeNode(e,t,a,r){let n=t.parent?t.parent:a.nodeManager.root,o=n.children.findIndex(e=>e.id===t.id);o>-1&&n.children.splice(o,1),e.index=o,r.add(n.id||""),a.nodeManager.removeNode(t)}removeRelatedComments(e,t){if(t.commentManager.nodeHasComments(e.id)){let e=t.commentManager.getAllCommentShowMessage();t.auxiliaryManager.addOrUpdateAuxiliaryDomState(h.l.ShowCommentPins,e)}}refreshAuxiliary(e,t){t.collaborationManager.hasNodeSelect(e.id)&&t.collaborationManager.redraw()}}class I extends E{onRemove(e,t){if(e.mindMapParent){let t=e.mindMapParent.mindMapChildren.findIndex(t=>t.id===e.id);e.mindMapParent.mindMapChildren.splice(t,1)}t.nodeManager.mindMapRoots.delete(e.id)}enable(e){return e.type===g.Jq.MindMapNode}reserveData(e,t){let a=[];return a.push(this.dumpNode(e,t)),a}}class P extends E{onRemove(e,t){}enable(e){return!0}}class A extends x{type=l.U.RemoveNode;removeHandlers=[new I,new P];handleRemove(e,t,a,r){for(let n of this.removeHandlers)if(n.enable(t))return void n.remove(e,t,a,r)}executeData(e,t){let a=new Set,r=t.nodeManager.nodeMap.size>0;for(let r of e){let e=t.nodeManager.nodeMap.get(r.id);if(!e){console.error(`node \u{4E0D}\u{5B58}\u{5728}\u{FF01}${JSON.stringify(r)}`);continue}this.handleRemove(r,e,t,a)}t.renderManager.addContentDrawTask(),r&&this.updateEmptyState(t),D.D.batchUpdateChildrenZIndex(a,t.nodeManager)}handleReserveLog(e,t,a){for(let r of this.removeHandlers)if(r.enable(e))return void a.push(...r.reserveData(e,t))}reserveLog(e,t){let a=[];for(let r=e.length-1;r>-1;r--){let n=e[r],o=t.nodeManager.nodeMap.get(n.id);if(!o){console.error(`node(${n.id}) \u{4E0D}\u{5B58}\u{5728}!`);continue}this.handleReserveLog(o,t,a)}return new U.C(a)}updateEmptyState(e){y.v.notifyNodeEmptyState(e.auxiliaryManager,{isCanvasEmpty:0===e.nodeManager.nodeMap.size})}}var L=a(513665);class q extends x{type=l.U.UpdateNode;executeData(e,t){if(!e.id)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let a=t.nodeManager.nodeMap.get(e.id);if(!a)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(a.updateNodeProps(e.props),a.type===g.Jq.Connector&&t.nodeManager.updateNodeLink(a),D.D.afterUpdateGraphic(a,t.nodeManager),a.type===g.Jq.MindMapNode){let r=e.props.find(e=>e.type===v.d.MindMap);if(r){let{parentId:e}=r;if(void 0!==e){let{mindMapParent:r}=a;if(""===e){if(r){let e=r.mindMapChildren.findIndex(e=>e.id===a.id);-1!==e&&r.mindMapChildren.splice(e,1)}a.mindMapParent=null,a.mindMapRoot=a}else{let n=t.nodeManager.getNode(e);if(n!==r){if(r){let e=r.mindMapChildren.findIndex(e=>e.id===a.id);-1!==e&&r.mindMapChildren.splice(e,1)}a.mindMapParent=n,n&&(a.mindMapRoot=n.mindMapRoot,n.mindMapChildren.push(a))}}}}}D.D.afterUpdateGraphic(a,t.nodeManager),a.type===g.Jq.MindMapNode&&t.mindMapManager.add(a.mindMapRoot);let r=T.I.getInstance(),n=r.getAllMentionUsers(),o=e.props.find(e=>e.type===v.d.Text);o&&r.updateMentionUserFromPropsAndNotify({props:o,preMentionUser:n,auxiliaryManager:t.auxiliaryManager}),this.redraw(a,t)}execRemote(e,t){this.executeData(e,t),t.translateManager.onNodePropsUpdate([{nodeId:e.id,props:e.props}])}reserveLog(e,t){if(!e.id)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let a=t.nodeManager.nodeMap.get(e.id);if(!a)throw Error("node \u4E0D\u5B58\u5728\uFF01");let r=a.serializeTo(),n={id:r.id,props:r.propList};return new L.x(n)}redraw(e,t){if(t.renderManager.addContentDrawTask(),t.auxiliaryManager.selectManager.include(e)){if(t.auxiliaryManager.selectManager.focusCallBack){let e=[...t.auxiliaryManager.selectManager.selectNodes];t.auxiliaryManager.selectManager.focusCallBack(e)}t.auxiliaryManager.updateSelectGraphic(),t.renderManager.addAuxiliaryDrawTask()}t.collaborationManager.hasNodeSelect(e.id)&&t.collaborationManager.redraw();let a=t.commentManager.getNodeComments(e.id);if(0===a.length)return;for(let e of a)t.commentManager.addOrUpdateComment(e.comment);let r=t.commentManager.getAllCommentShowMessage();t.auxiliaryManager.addOrUpdateAuxiliaryDomState(h.l.ShowCommentPins,r)}}var G=a(455360);class _ extends x{type=l.U.Start;executeData(e,t){}reserveLog(e,t){return new G.q}}var Z=a(944379);class J extends x{type=l.U.End;executeData(e,t){}reserveLog(e,t){return new Z.M}}var H=a(175005),B=a(616755);class V extends x{type=l.U.SelectNode;executeData(e,t){let a=new Set;for(let r of e.idList){let e=t.nodeManager.nodeMap.get(r);e&&a.add(e)}if(e.selectType===B.Q.Node){let e=[...t.auxiliaryManager.selectManager.selectNodes];1===e.length&&(e[0].type===g.Jq.Table||e[0].type===g.Jq.TableER||e[0].type===g.Jq.TableUML)&&e[0].tableStatus.clear(),t.setSelectNodes(a);return}if(1!==a.size){t.setSelectNodes(a),console.warn("\u8868\u683C\u9009\u4E2D\u6D88\u606F\u6709\u95EE\u9898\uFF0C\u964D\u7EA7\u5230\u9009\u4E2D\u8282\u70B9");return}let r=[...a][0];if(r.type!==g.Jq.Table&&r.type!==g.Jq.TableER&&r.type!==g.Jq.TableUML){t.setSelectNodes(a),console.warn("\u8868\u683C\u9009\u4E2D\u6D88\u606F\u6709\u95EE\u9898\uFF0C\u964D\u7EA7\u5230\u9009\u4E2D\u8282\u70B9");return}if(e.selectType===B.Q.Row){r.tableStatus.setTableRows(e.rowCols),t.setSelectNodes(a);return}if(e.selectType===B.Q.Col){r.tableStatus.setTableCols(e.rowCols),t.setSelectNodes(a);return}if(e.selectType===B.Q.Cell){r.tableStatus.setTableCells(e.cells),t.setSelectNodes(a);return}}reserveLog(e,t){let{selectManager:a}=t.auxiliaryManager;if(1===a.selectNodes.size){let e=[...a.selectNodes][0];if(e.type===g.Jq.Table||e.type===g.Jq.TableER||e.type===g.Jq.TableUML){if(e.tableStatus.selectRows.length>0){let t={idList:[e.id],cells:[],rowCols:[...e.tableStatus.selectRows],selectType:B.Q.Row};return new H.O(t)}if(e.tableStatus.selectCols.length>0){let t={idList:[e.id],cells:[],rowCols:[...e.tableStatus.selectCols],selectType:B.Q.Col};return new H.O(t)}if(e.tableStatus.selectCells.length>0){let t={idList:[e.id],cells:[...e.tableStatus.selectCells],rowCols:[],selectType:B.Q.Cell};return new H.O(t)}}}let r={idList:[...a.selectNodes].map(e=>e.id),cells:[],rowCols:[],selectType:B.Q.Node};return new H.O(r)}execRemote(e,t,a){t.collaborationManager.updateCollaboratorSelectData(a.userId,e)}}var F=a(541340);class z extends x{type=l.U.MoveNode;executeData(e,t){let a=[];for(let r of e.idList){let e=t.nodeManager.nodeMap.get(r);e&&a.push(e)}if(0===a.length)throw Error("node \u4E0D\u5B58\u5728\uFF01");for(let r of a){let a=r.getProp(v.d.Base);if(!a){console.error("node\u7C7B\u578B\u4E3Anode,\u4F46\u662Fbase props\u4E0D\u5B58\u5728.");continue}let n=a.clone();n.x+=e.dx,n.y+=e.dy,r.updateNodeProps([n]),D.D.afterUpdateGraphic(r,t.nodeManager),r.type===g.Jq.MindMapNode&&t.mindMapManager.add(r.mindMapRoot),this.redraw(r,t)}}redraw(e,t){if(t.renderManager.addContentDrawTask(),t.auxiliaryManager.selectManager.include(e)){if(t.auxiliaryManager.selectManager.focusCallBack){let e=[...t.auxiliaryManager.selectManager.selectNodes];t.auxiliaryManager.selectManager.focusCallBack(e)}t.auxiliaryManager.updateSelectGraphic(),t.renderManager.addAuxiliaryDrawTask()}t.collaborationManager.hasNodeSelect(e.id)&&t.renderManager.addAuxiliaryDrawTask();let a=t.commentManager.getNodeComments(e.id);if(0===a.length)return;for(let e of a)t.commentManager.addOrUpdateComment(e.comment);let r=t.commentManager.getAllCommentShowMessage();t.auxiliaryManager.addOrUpdateAuxiliaryDomState(h.l.ShowCommentPins,r)}reserveLog(e,t){return new F.d({idList:e.idList,dx:-e.dx,dy:-e.dy})}}var Q=a(800866);class W extends x{type=l.U.Relation;executeData(e,t){let{toIndex:a,toPath:r,id:n}=e,o=t.nodeManager.getNode(n);if(!o)return void console.error("\u8BE5\u8282\u70B9\u4E0D\u5B58\u5728\uFF01id:",n,"relation:",JSON.stringify(e));if(!r||0===r.length){let e=o.parent.children.indexOf(o);o.parent.children.splice(e,1),o.parent=t.nodeManager.root,t.nodeManager.root.children.splice(a,0,o),this.sortChildren(o.parent.children),t.renderManager.addContentDrawTask();return}let s=r[r.length-1],i=t.nodeManager.getNode(s);if(!i)return void console.error("\u79FB\u52A8\u81F3\u76EE\u6807\u8282\u70B9\u4E0D\u5B58\u5728\uFF01\u76EE\u6807\u8282\u70B9id:",n,"relation:",JSON.stringify(e));if(o.parent){let e=o.parent.children.indexOf(o);o.parent.children.splice(e,1)}o.parent=i,a<i.children.length?i.children.splice(a,0,o):i.children.push(o),this.sortChildren(i.children),t.renderManager.addContentDrawTask()}sortChildren(e){for(let t=0;t<e.length;t++)e[t].zIndex=t}reserveLog(e,t){let a={fromIndex:e.toIndex,toIndex:e.fromIndex,fromPath:e.toPath,toPath:e.fromPath,id:e.id};return new Q.h(a)}}var $=a(219231),j=a(561347),Y=a(224365),K=a(457063),X=a(678014);class ee extends x{type=l.U.TableCellUpdate;executeData(e,t){let{infos:a,id:r}=e;if(!r)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let n=t.nodeManager.nodeMap.get(r);if(!n)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(!(n instanceof $.D))throw Error("node \u7C7B\u578B\u4E0D\u6B63\u786E\uFF01");if(0===a.length)return;let o=n.tableProps,s=0,i=0;for(let e of a){let{i:t,j:a}=e,r=o.cellMatrix.getCell(t,a);if(e.rowSpan&&e.colSpan){let{rowSpan:t,colSpan:a}=e;r.rowSpan=t,r.colSpan=a,i++}else{let r=this.updateCellInfo(n,e);if(!r)continue;o.cellMatrix.cells[t][a]=r,s++}}if(o.cellMatrix.updateRefCells(),s>0||i>0){let e={type:v.d.Table,cellMatrix:o.cellMatrix};n.updateNodeProps([e]),D.D.afterUpdateGraphic(n,t.nodeManager),X.v.addNodeDrawTask(n,t)}}execRemote(e,t){this.executeData(e,t),t.translateManager.onTableCellPropsUpdate({nodeId:e.id,cellInfos:e.infos})}reserveLog(e,t){if(!e.id)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let a=t.nodeManager.nodeMap.get(e.id);if(!a)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(!(a instanceof $.D))throw Error("node \u7C7B\u578B\u4E0D\u6B63\u786E\uFF01");let r=[],{tableProps:n}=a;for(let t of e.infos){if(!n.validRowColIndex(t.i,t.j))throw Error(`\u{751F}\u{6210}\u{9006}\u{6D88}\u{606F}\u{9519}\u{8BEF}\u{FF0C}\u{5355}\u{5143}\u{683C}i,j\u{9519}\u{8BEF}\u{FF1A}${t.i},${t.j}`);let e=n.cellMatrix.getCell(t.i,t.j),a=this.reserveUpdateCellInfo(t,e,n);r.push(a)}let o={id:e.id,infos:r};return new K.g(o)}reserveUpdateCellInfo(e,t,a){let{i:r,j:n,theme:o,children:s,color:i,textProps:d,alpha:l,textTransformProps:c,rowSpan:h,colSpan:u}=e,p={i:r,j:n};return o&&(p.theme=t.themeProps),i&&(p.color=t.color||""),l&&(p.alpha=t.alpha),d&&(p.textProps=t.textProps?.clone()||void 0),c&&(p.textTransformProps=t.textTransformProps||void 0),h&&(p.rowSpan=t.rowSpan),u&&(p.colSpan=t.colSpan),p}updateCellInfo(e,t){let{i:a,j:r,theme:n,children:o,color:s,textProps:i,alpha:d,textTransformProps:l,rowSpan:c,colSpan:h}=t,u=e.tableProps;if(!u.validRowColIndex(a,r)){let{rows:e,columns:t}=u;return console.error("\u8868\u683C\u5355\u5143\u683C\u66F4\u65B0\u51FA\u9519\uFF0C\u8868\u683Ci,j\u9519\u8BEF:",a,r,"\u8868\u683Crows length:",e.length,"columns length:",t.length),null}let p=u.cellMatrix.getCell(a,r);if(p.overrideCell=!0,n){let e={...p.themeProps,...n};p.themeProps=e}return void 0!==s&&(p.color=s),i&&(p.textProps||(p.textProps=new j.l),p.textProps.update(i)),l&&(p.textTransformProps||(p.textTransformProps=new Y._),p.textTransformProps.update(l)),void 0!==d&&(p.alpha=d),c&&(p.rowSpan=c),h&&(p.colSpan=h),o&&(p.children=o),p}}class et{updateTableCell(e,t){let{theme:a,color:r,textProps:n,alpha:o,textTransformProps:s}=e,i=!1;if(a){let e={...t.themeProps,theme:a};t.themeProps=e,i=!0}return r&&(t.color=r,i=!0),n&&(t.textProps||(t.textProps=new j.l),t.textProps.update(n),i=!0),s&&(t.textTransformProps||(t.textTransformProps=new Y._),t.textTransformProps.update(s),i=!0),void 0!==o&&(t.alpha=o,i=!0),{overrideCell:i,tableCell:t}}}class ea extends et{handle(e,t,a){let{index:r,length:n}=t,{rows:o,columns:s}=e.tableProps;if(r<0||r>=s.length)return console.error("\u8868\u683C\u5355\u5143\u683C\u66F4\u65B0\u51FA\u9519\uFF0C\u8868\u683Cindex\u9519\u8BEF:",r,"\u8868\u683Crows length:",o.length,"is row:true"),null;if(void 0!==n){s[r]=n;let t={type:v.d.Table,columns:s};e.updateNodeProps([t]),D.D.afterUpdateGraphic(e,a.nodeManager),X.v.addNodeDrawTask(e,a)}}}class er extends et{handle(e,t,a){let{index:r,length:n}=t,{rows:o,columns:s}=e.tableProps;if(r<0||r>=o.length)return console.error("\u8868\u683C\u5355\u5143\u683C\u66F4\u65B0\u51FA\u9519\uFF0C\u8868\u683Cindex\u9519\u8BEF:",r,"\u8868\u683Crows length:",o.length,"is row:true"),null;if(void 0!==n){o[r]=n;let t={type:v.d.Table,rows:o};e.updateNodeProps([t]),D.D.afterUpdateGraphic(e,a.nodeManager),X.v.addNodeDrawTask(e,a)}}}var en=a(106969);class eo extends x{type=l.U.TableRowColUpdate;rowAssist=new er;colAssist=new ea;executeData(e,t){let{rowCols:a,id:r,isRow:n}=e;if(!r)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let o=t.nodeManager.nodeMap.get(r);if(!o)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(!(o instanceof $.D))throw Error("node \u7C7B\u578B\u4E0D\u6B63\u786E\uFF01");if(0!==a.length)for(let e of a)this.updateRowColInfo(o,e,n,t)}updateRowColInfo(e,t,a,r){a?this.rowAssist.handle(e,t,r):this.colAssist.handle(e,t,r)}reserveLog(e,t){if(!e.id)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let a=t.nodeManager.nodeMap.get(e.id);if(!a)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(!(a instanceof $.D))throw Error("node \u7C7B\u578B\u4E0D\u6B63\u786E\uFF01");return e.isRow?this.reserveRowLog(a,e):this.reserveColLog(a,e)}reserveRowLog(e,t){let{rows:a}=e.tableProps,{rowCols:r}=t,n=[];for(let e of r){let{index:t,length:r}=e;if(t<0||t>=a.length){console.error("\u9519\u8BEF\u7684\u64CD\u4F5C\u6570\u636E\uFF0Cindex",t,"rows length:",a.length);continue}let o={index:t,length:a[t]};n.push(o)}let o={id:t.id,isRow:!0,rowCols:n};return new en.V(o)}reserveColLog(e,t){let{columns:a}=e.tableProps,{rowCols:r}=t,n=[];for(let e of r){let{index:t}=e;if(t<0||t>=a.length){console.error("\u9519\u8BEF\u7684\u64CD\u4F5C\u6570\u636E\uFF0Cindex",t,"columns length:",a.length);continue}let r={index:t,length:a[t]};n.push(r)}let o={id:t.id,isRow:!1,rowCols:n};return new en.V(o)}}var es=a(589405),ei=a(567524);class ed extends x{type=l.U.TableRowColAdd;executeData(e,t){let a,{id:r,isRow:n}=e;if(!r)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let o=t.nodeManager.nodeMap.get(r);if(!o)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(!(o instanceof $.D))throw Error("node \u7C7B\u578B\u4E0D\u6B63\u786E\uFF01");a=n?this.insertRows(o,e):this.insertCols(o,e),o.updateNodeProps([a]),D.D.afterUpdateGraphic(o,t.nodeManager),X.v.addNodeDrawTask(o,t)}insertCols(e,t){let{index:a,num:r,isRow:n,length:o}=t,{rows:s,columns:i,cellMatrix:d}=e.tableProps,l=[];for(let e=0;e<r;e++)l.push(o);let c=[...i];c.splice(a,0,...l);for(let e=0;e<s.length;e++){let t=[];for(let n=0;n<r;n++)t.push(new ei.V(e,a+n));d.cells[e].splice(a,0,...t)}return d.updateCellIJ(),{type:v.d.Table,cellMatrix:d,columns:c}}insertRows(e,t){let{num:a,length:r}=t,n=void 0===t.index?0:t.index,{columns:o,rows:s,cellMatrix:i}=e.tableProps,d=[];for(let e=0;e<a;e++)d.push(r);let l=[...s];l.splice(n,0,...d);for(let e=0;e<a;e++){let t=[];for(let a=0;a<o.length;a++)t.push(new ei.V(n+e,a));i.cells.splice(n,0,t)}return i.updateCellIJ(),{type:v.d.Table,cellMatrix:i,rows:l}}reserveLog(e,t){let{index:a,num:r,isRow:n}=e,o=[];for(let e=0;e<r;e++)o.push(a+e);let s={indexList:o,isRow:n,id:e.id};return new es.O(s)}}var el=a(131326),ec=a(805433);class eh extends x{type=l.U.TableRowColRemove;executeData(e,t){let a,{id:r,indexList:n,isRow:o}=e;if(!r)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let s=t.nodeManager.nodeMap.get(r);if(!s)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(!(s instanceof $.D))throw Error("node \u7C7B\u578B\u4E0D\u6B63\u786E\uFF01");a=o?this.deleteRow(s,e):this.deleteCol(s,e),s.updateNodeProps([a]),D.D.afterUpdateGraphic(s,t.nodeManager),X.v.addNodeDrawTask(s,t)}deleteRow(e,t){let{indexList:a}=t,{rows:r,columns:n,cellMatrix:o}=e.tableProps,s=new Set(a),i=[],d=new el.p;for(let e=0;e<r.length;e++){if(s.has(e))continue;let t=r[e];i.push(t);let a=[];for(let t=0;t<n.length;t++){let r=o.getCell(e,t);a.push(r)}d.cells.push(a)}return d.updateCellIJ(),{type:v.d.Table,cellMatrix:d,rows:i}}deleteCol(e,t){let{indexList:a}=t,{rows:r,columns:n,cellMatrix:o}=e.tableProps,s=new Set(a),i=[],d=new el.p,l=[];for(let e=0;e<n.length;e++){if(s.has(e))continue;let t=n[e];i.push(t);let a=[];for(let t=0;t<r.length;t++){let r=o.getCell(t,e);a.push(r)}l.push(a)}return d.cells=ec.G.matrixTranspose(l),d.updateCellIJ(),{type:v.d.Table,cellMatrix:d,columns:i}}reserveLog(e,t){if(!e.id)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let a=t.nodeManager.nodeMap.get(e.id);if(!a)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(!(a instanceof $.D))throw Error("node \u7C7B\u578B\u9519\u8BEF!");let r=a.tableProps.clone(),n={id:a.id,props:[r]};return new L.x(n)}}var eu=a(281042);class ep extends x{type=l.U.MindMapRelation;executeData(e,t){if(!e.id)throw Error("\u6570\u636E\u9519\u8BEF\uFF0C\u7F3A\u5C11id");let a=t.nodeManager.nodeMap.get(e.id);if(!a)throw Error("node \u4E0D\u5B58\u5728\uFF01");if(a.type!==g.Jq.MindMapNode)throw Error("node \u7C7B\u578B\u9519\u8BEF\uFF0C\u4E0D\u662F\u601D\u7EF4\u5BFC\u56FEMindNode\u8282\u70B9\uFF1Aid"+a.id);let r=this.getMindMapParent(e.fromParent,t),n=this.getMindMapParent(e.toParent,t);if(r===n)return;if(r){let e=r.mindMapChildren.findIndex(e=>e.id===a.id);-1!==e&&r.mindMapChildren.splice(e,1)}a.mindMapProps.parentId="",a.mindMapParent=null,n&&(a.mindMapProps.parentId=n.id,a.mindMapParent=n,-1===n.mindMapChildren.findIndex(e=>e.id===a.id)&&n.mindMapChildren.push(a));let o=b.R.getMindMapRoot(a);if(a.mindMapRoot=o,t.renderManager.addContentDrawTask(),t.renderManager.addContentDrawTask(),t.auxiliaryManager.selectManager.include(a)){if(t.auxiliaryManager.selectManager.focusCallBack){let e=[...t.auxiliaryManager.selectManager.selectNodes];t.auxiliaryManager.selectManager.focusCallBack(e)}t.auxiliaryManager.updateSelectGraphic(),t.renderManager.addAuxiliaryDrawTask()}}getMindMapParent(e,t){if(e&&e.length>0){let a=e[e.length-1],r=t.nodeManager.getNode(a);if(r&&r.type===g.Jq.MindMapNode)return r}return null}reserveLog(e,t){return new eu.$({id:e.id,fromParent:e.toParent,toParent:e.fromParent})}}let eg=[new N,new A,new q,new z,new V,new W,new ep,new _,new J,new ee,new eo,new ed,new eh];var ef=a(655128);(r=s||(s={})).online="online",r.offline="offline",r.weakline="weakline";class em{state=s.online;changeState(e){let t=this.state;if(t!==e){if(t===s.offline&&e===s.online){this.offlineToOnlineCb(this.state),this.state=e;return}if(t===s.online&&e===s.offline){this.onlineToOfflineCb(this.state),this.state=e;return}}}}class eM{dbVersion=1;db=null;init(){let e=this.open();this.onError(e),this.onSuccess(e),this.onUpgradeneeded(e)}delete(e){return new Promise((t,a)=>{try{let r=this.openTable().delete(e);r.onerror=()=>{a(Error("index db error: \u6570\u636E\u5199\u5165\u5931\u8D25"))},r.onsuccess=()=>{t()}}catch(e){a(Error("index db error:"+e.target.error))}})}get(e){return new Promise((t,a)=>{try{this.openTable().get(e).onsuccess=e=>{let a=e.target.result;a?t(a):t(null)}}catch(e){a(e)}})}getByIndex(e,t){return new Promise((a,r)=>{try{let r=this.openTable().index(e).openCursor(IDBKeyRange.only(t)),n=[];r.onsuccess=e=>{let t=e.target.result;t?(n.push(t.value),t.continue()):a(n)}}catch(e){r(e)}})}set(e,t){return new Promise((e,a)=>{try{let r=this.openTable().add(t);r.onerror=e=>{console.error("index db \u65E0\u6CD5\u542F\u7528. error msg:",e.target.error),a(Error("\u6570\u636E\u5199\u5165\u5931\u8D25"+e.target.error))},r.onsuccess=()=>{e()}}catch(e){a(e)}})}open(){return window.indexedDB.open("whiteboard_x",this.dbVersion)}onError(e){e.onerror=e=>{console.error("index db \u65E0\u6CD5\u542F\u7528. error msg:",e.target.error)}}onSuccess(e){e.onsuccess=e=>{console.log("index db\u79BB\u7EBF\u6570\u636E\u5E93\u6210\u529F\u521B\u5EFA"),this.db=e.target.result}}onUpgradeneeded(e){e.onupgradeneeded=e=>{console.log("index db onUpgradeneeded");let t=e.target.result;t.createObjectStore(this.tableName,{keyPath:this.primaryKey}).createIndex("refIndex","refId",{unique:!1}),this.db=t}}openTable(){return this.db.transaction(this.tableName,"readwrite").objectStore(this.tableName)}}class ew extends eM{tableName="ws_request_table";primaryKey="packId"}class ex{working=!0;constructor(){this.wsRequestTable=new ew}init(){this.wsRequestTable.init()}stop(){}save(e,t,a){this.wsRequestTable.set(e.packId,e).then(()=>{t()}).catch(e=>{this.working=!1,console.error("offline index db set data error.",e),a()})}loadOfflineData(e){return new Promise((t,a)=>{this.wsRequestTable.getByIndex("refIndex",e).then(e=>{e.forEach(e=>e.isOffline=!0),t(e)}).catch(t=>{console.error("\u8BFB\u53D6\u672C\u5730\u79BB\u7EBF\u6570\u636E\u51FA\u9519\uFF0CrefId:",e,"error:",t),a(t)})})}deleteOfflineData(e){return new Promise((t,a)=>{this.wsRequestTable.delete(e.packId).then(()=>{t()}).catch(t=>{console.error("\u5220\u9664\u672C\u5730\u79BB\u7EBF\u6570\u636E\u51FA\u9519\uFF0CpackId:",e.packId,"error:",t),a(t)})})}}var eC=a(98837);class ey{transform(e){return e}}(n=i||(i={}))[n.Order=0]="Order",n[n.DeviceOrder=1]="DeviceOrder",n[n.UnOrder=2]="UnOrder";var eT=a(184318);class eS{constructor(){this.head=eT.G.generateLink(),this.tail=this.head.next}size(){let e=this.head.next,t=0;for(;e&&e!==this.tail;)t++,e=e.next;return t}first(){let e=this.head.next;return e===this.tail?null:e.data}last(){let e=this.tail.prev;return e===this.head?null:e.data}isEmpty(){return this.head.next===this.tail}enqueue(e){let t=new eT.G(e);this.tail.prev.add(t)}dequeue(){let e=this.head.next;return e===this.tail?null:(this.head.next=e.next,e.next.prev=this.head,e.next=null,e.prev=null,e.data)}}var ev=a(284169);class eR extends eS{addPkg(e){if(this.head.next===this.tail)return void this.head.add(new eT.G(e));if(e.createTime>this.tail.prev.data.createTime)return void this.tail.prev.add(new eT.G(e));let t=this.head.next;for(;t?.data&&t!==this.tail;){if(e.createTime<t.data.createTime)return void this.head.add(new eT.G(e));t=t.next}}enqueue(e){let t=this.last();if(!t||t.data.type!==e.data.type||!t.data.nodeOperations||0===t.data.nodeOperations.length||!e.data.nodeOperations||0===e.data.nodeOperations.length||t.data.nodeOperations[0].type!==e.data.nodeOperations[0].type)return void super.enqueue(e);this.mergeOperations(t,e.data.nodeOperations)}mergeOperations(e,t){let a=e.data.nodeOperations,r=a[a.length-1];for(let e of t)this.canMergeUpdateNodeOperation(r,e)||(a.push(e),r=e)}canMergeUpdateNodeOperation(e,t){if(!e.nodeUpdate?.cap||!t.nodeUpdate?.cap)return!1;let a=e.nodeUpdate.paths,r=t.nodeUpdate.paths;if(1!==a.length||1!==r.length)return!1;let n=a[0].path,o=r[0].path;if(n[n.length-1]!==o[o.length-1])return!1;if(this.mergeDifferenceUpdateCap(e,t))return!0;if(e.nodeUpdate.type!==g.Cs.Replace||t.nodeUpdate.type!==g.Cs.Replace)return!1;let s=e.nodeUpdate.cap,i=t.nodeUpdate.cap,d={...s,...i};return i.baseV2&&(d.baseV2={...s.baseV2,...i.baseV2}),i.theme&&(d.theme={...s.theme,...i.theme}),i.textV2&&(d.textV2={...s.textV2,...i.textV2}),e.nodeUpdate.cap=d,!0}mergeDifferenceUpdateCap(e,t){if(e.nodeUpdate?.type!==g.Cs.Difference||t.nodeUpdate?.type!==g.Cs.Difference)return!1;let a=e.nodeUpdate.cap,r=t.nodeUpdate.cap;if(!a.baseV2||!r.baseV2)return!1;let n=(0,ev.Z)(r.baseV2.x)?r.baseV2.x:0,o=(0,ev.Z)(r.baseV2.y)?r.baseV2.y:0;return e.nodeUpdate.cap.baseV2.x+=n,e.nodeUpdate.cap.baseV2.y+=o,!0}}class eb extends eS{addPkg(e){if(this.head.next===this.tail)return void this.head.add(new eT.G(e));if(e.seq>this.tail.prev.data.seq)return void this.tail.prev.add(new eT.G(e));let t=this.head.next;for(;t?.data&&t!==this.tail;){if(e.seq<t.data.seq)return void this.head.add(new eT.G(e));t=t.next}}addOps(e){for(let t of e)this.addPkg(t)}}class eO{constructor(){this.localActionCache=new eR,this.remoteActionCache=new eb}}class ek{constructor(e,t){this.networkManager=t,this.remoteManager=e}destroy(){}offlineToOnline(){}onlineToOffline(){}}class eD extends ek{type=i.Order;allowedActionType=new Set([g.Us.BatchNode,g.Us.Theme,g.Us.BatchRelation,g.Us.NodeV2,g.Us.Comment]);static batch=5;isDestroy=!1;isSaving=!1;isFetchingMiss=!1;working=!0;get currentSeq(){return this.networkManager.docState.currentSeq}get remoteActionCache(){return this.actionCache.remoteActionCache}constructor(e,t){super(e,t),this.actionCache=new eO,this.otManager=new ey,this.tickerRun()}enable(e){return!!this.allowedActionType.has(e)}enableDownLink(e){if(!e.seq)return!1;if(e.oversize)return!0;let t=e.payload.body.data;return!!t&&void 0!==t.type&&this.enable(t.type)}offlineToOnline(){let e=`${this.networkManager.docState.docxToken}_${this.networkManager.docState.whiteboardToken}`;this.networkManager.offlineManager.loadOfflineData(e).then(e=>{e.forEach(e=>{this.actionCache.localActionCache.addPkg(e)})}).catch(()=>{console.error("\u79BB\u7EBF\u5207\u6362\u5230\u5728\u7EBF\u72B6\u6001\uFF0C\u8BFB\u53D6\u672C\u5730\u79BB\u7EBF\u6570\u636E\u5931\u8D25\uFF01")})}send(e){let t={packId:`${this.networkManager.docState.docxToken.slice(0,4)}:${this.networkManager.docState.whiteboardToken.slice(0,4)}:${Date.now()}`,data:e,createTime:Date.now(),refId:`${this.networkManager.docState.docxToken}_${this.networkManager.docState.whiteboardToken}`};this.actionCache.localActionCache.enqueue(t)}onMessage(e){if(e.oversize)return void this.getHttpDownlinkPkg(this.currentSeq+1,e.seq,this.networkManager.docState.whiteboardToken);this.actionCache.remoteActionCache.enqueue(e)}doFetchMiss(){let e=this.actionCache.remoteActionCache.first();return!!e&&!!(this.currentSeq+1<e.seq)&&(!!this.isFetchingMiss||(this.getHttpDownlinkPkg(this.currentSeq+1,e.seq-1,this.networkManager.docState.whiteboardToken),!0))}getHttpDownlinkPkg(e,t,a){this.isFetchingMiss=!0,eC.O.fetchMissOp({startSeq:e,endSeq:t,encoding:1,blockToken:a}).then(e=>{this.isFetchingMiss=!1,e&&this.actionCache.remoteActionCache.addOps(e)})}tickerRun=()=>{this.isDestroy||(this.sendOnTick(),this.consumeOnTick(),requestAnimationFrame(this.tickerRun))};sendOnTick=()=>{if(!this.networkManager.offlineManager.working&&!this.working||this.isSaving)return;let e=this.actionCache.localActionCache.dequeue();if(e?.data){if(this.isSaving=!0,this.working&&this.networkManager.networkState.state===s.online)return void this.networkManager.webSocketManager.sendMessage(e.data,this.currentSeq,t=>this.sendSuccessCallback(t,e),()=>this.sendErrCallback(e));this.networkManager.offlineManager.save(e,()=>{this.isSaving=!1},()=>{this.isSaving=!1})}};sendSuccessCallback(e,t){if(void 0===e.code||0===e.code){let a;a=e.httpStatus?e.data:e,this.networkManager.docState.currentSeq=a.seq,this.isSaving=!1,this.networkManager.offlineManager.deleteOfflineData(t)}else console.error("Error: \u53D1\u9001\u6D88\u606F\u5931\u8D25\uFF1A\u670D\u52A1\u7AEF\u62A5\u9519\uFF1A",function(e){try{let t=e.meta.originResponse.data.msg;return{code:e.code,data:e.data,httpStatus:e.httpStatus,reason:t}}catch(t){return e}}(e),t),this.sendErrCallback(t)}sendErrCallback(e){this.isSaving=!1,this.networkManager.networkState.changeState(s.offline),this.actionCache.localActionCache.addPkg(e),this.working=!1}consumeOnTick=()=>{try{if(this.remoteActionCache.isEmpty())return;if(this.currentSeq===this.remoteActionCache.first().seq)return void this.remoteActionCache.dequeue();if(this.doFetchMiss())return;for(let e=0;e<eD.batch;e++){let e=this.remoteActionCache.dequeue();if(e?.payload.body.data){let t=e.payload.body.data;this.enable(t.type)&&(t=this.otManager.transform(t),this.remoteManager.exec(t,e.payload.meta),this.networkManager.docState.currentSeq=e.seq)}}}catch(e){console.error(e)}};destroy(){this.isDestroy=!0}}class eN extends ek{type=i.DeviceOrder;allowedActionType=new Set([g.Us.Select]);currentSeq=0;deviceSeqMap=new Map;messageQueue=[];nextSendMessage=void 0;nextSendMessageErrorCount=0;isSendingMessage=!1;retryTimer=0;isSendMesssageEnable(){return!this.isSendingMessage&&this.networkManager.networkState.state!==s.offline&&(!!this.nextSendMessage||0!==this.messageQueue.length)}addMessageQueue(e){let t=this.messageQueue.map(e=>e.type).indexOf(e.type);-1!==t?this.messageQueue.splice(t,1,e):this.messageQueue.push(e)}consumeMessageQueue(){if(this.retryTimer&&clearTimeout(this.retryTimer),this.retryTimer=0,!this.isSendMesssageEnable())return;this.isSendingMessage=!0;let e=this.nextSendMessage||this.messageQueue.shift();this.networkManager.webSocketManager.sendMessage(e,this.currentSeq,()=>this.handleMessageConsumeSuccess(),()=>this.handleMessageConsumeError())}handleMessageConsumeSuccess(){this.isSendingMessage=!1,this.nextSendMessage=void 0,this.nextSendMessageErrorCount=0,this.currentSeq++,this.consumeMessageQueue()}handleMessageConsumeError(){this.isSendingMessage=!1,this.nextSendMessageErrorCount++,this.nextSendMessageErrorCount>3&&(this.nextSendMessageErrorCount=0,this.nextSendMessage=void 0),this.retryTimer=setTimeout(()=>{this.consumeMessageQueue()},1e4)}enable(e){return!!this.allowedActionType.has(e)}enableDownLink(e){if(e.oversize)return!1;let t=e.payload.body.data;return!!t&&void 0!==t.type&&this.enable(t.type)}send(e){this.addMessageQueue(e),this.consumeMessageQueue()}onMessage(e){!e.oversize&&e.payload.body.data&&this.handleDeviceOrderMsg(e.payload.body.data,e.payload.meta)}getDeviceOrderActionSeq(e){return this.deviceSeqMap.get(e)||0}offlineToOnline(){this.consumeMessageQueue()}async getCollaboratorsDeviceOrderInfo({exclusiveUserIds:e=[]}){let t=await eC.O.fetchAllDeviceOrderMsgs(this.networkManager.docState.whiteboardToken);t&&Object.keys(t).forEach(a=>{let r;if(e.includes(a))return;let n=t[a]?.memberData;if(!n)return;let o="";if(Object.keys(n).forEach(e=>{let t=(n[e]?.data).Select;t&&(!r||t.updatedAt>Number(r.updatedAt))&&(r=t,o=e)}),r){let{seq:e,select:t}=r;t&&this.handleDeviceOrderMsg({type:g.Us.Select,selectRequest:t},{userId:a,deviceId:o,seq:e,type:g.Us.Select})}})}handleDeviceOrderMsg(e,t){let{userId:a,deviceId:r,seq:n=0}=t;a&&r&&(this.getDeviceOrderActionSeq(r)>n||(this.deviceSeqMap.set(r,n),this.remoteManager.exec(e,t)))}}class eU extends ek{type=i.UnOrder;enableDownLink(e){return!0}enable(e){return!0}send(e,t,a){this.networkManager.webSocketManager.sendMessage(e,0,t,a)}onMessage(e){!e.oversize&&e.payload.body.data&&this.remoteManager.exec(e.payload.body.data,e.payload.meta)}}class eE{get orderChannel(){return this.messageChannels[0]}get deviceOrderChannel(){return this.messageChannels[1]}constructor(e,t){this.messageChannels=[new eD(e,t),new eN(e,t),new eU(e,t)]}init(){}sendOrderMsg(e){this.orderChannel.send(e)}sendUnOrderMsg(e,t,a){this.messageChannels[2].send(e,t,a)}sendDeviceOrderMsg(e,t,a){this.deviceOrderChannel.send(e)}async getCollaboratorsDeviceOrderInfo({exclusiveUserIds:e}){return this.deviceOrderChannel.getCollaboratorsDeviceOrderInfo({exclusiveUserIds:e})}onMessage(e){for(let t of this.messageChannels)if(t.enableDownLink(e))return void t.onMessage(e)}offlineToOnline(){for(let e of this.messageChannels)e.offlineToOnline()}onlineToOffline(){for(let e of this.messageChannels)e.onlineToOffline()}addLocalOfflineData(e){this.orderChannel.actionCache.localActionCache.addPkg(e)}destroy(){for(let e of this.messageChannels)e.destroy()}}(o=d||(d={}))[o.Join=0]="Join",o[o.Leave=1]="Leave",o[o.Heartbeat=2]="Heartbeat";class eI{networkManager=null;intervalId=-1;lastActiveTime=-1;constructor(e){this.docState=e}init(e){this.networkManager=e}sendHeartBeat=()=>{this.sendPing(this.heartbeatRoomData())};sendHeartStart=()=>{this.sendPing(this.heartStartRoomData())};sendHeartEnd=()=>{this.sendPing(this.heartEndRoomData())};sendPing(e){if(!this.networkManager)return;let t={roomRequest:e,type:g.Us.Room};this.networkManager.sendUnOrderMsg(t,this.succCallback,()=>{this.errCallback(t)})}heartbeatRoomData(){return{act:d.Heartbeat,ClientVersion:8.3}}heartEndRoomData(){return{act:d.Leave,ClientVersion:8.3}}heartStartRoomData(){return{act:d.Join,ClientVersion:8.3}}destroy(){clearInterval(this.intervalId)}succCallback=()=>{this.lastActiveTime=Date.now()};errCallback(e){console.error("\u5FC3\u8DF3\u6D88\u606F\u53D1\u9001\u5931\u8D25",JSON.stringify(e))}}var eP=a(620998);class eA extends eP.c{init(e){}onClose(e){}onMessage(e){}onOpen(e){}sendMessage(e,t,a){}getDeviceId(){return"mock-id"}}class eL{constructor(e,t){this.networkState=new em,this.docState=t,this.offlineManager=new ex,this.heatBeat=new eI(this.docState),this.webSocketManager=new eA(this),this.channelManager=new eE(e,this)}registerUpdateSocketManager(e){this.webSocketManager=e}init(){this.webSocketManager.init(this.channelManager),this.heatBeat.init(this),this.offlineManager.init(),this.registerNetworkStateChange()}registerNetworkStateChange(){this.networkState.offlineToOnlineCb=()=>{this.channelManager.offlineToOnline()},this.networkState.onlineToOfflineCb=()=>{this.channelManager.onlineToOffline()}}addAction(e){let t={data:e.data,type:e.type},a=ef.C.getInstance().convert(t);if(a){if(a.type===g.Us.Select)return void this.channelManager.sendDeviceOrderMsg(a,M.Z,M.Z);this.channelManager.sendOrderMsg(a)}}sendUnOrderMsg(e,t,a){this.channelManager.sendUnOrderMsg(e,t,a)}async getCollaboratorsDeviceOrderInfo({exclusiveUserIds:e}){return this.channelManager.getCollaboratorsDeviceOrderInfo({exclusiveUserIds:e})}updateNodeSet=new Set([l.U.MoveNode,l.U.UpdateNode]);canMergeActionType(e,t){return!!(e===t||this.updateNodeSet.has(e)&&this.updateNodeSet.has(t))}destroy(){this.webSocketManager.destroy(),this.channelManager.destroy()}}class eq{actionLogs=[];constructor(e=[]){this.actionLogs=e}reverse(){let e=new eq;for(let t=this.actionLogs.length-1;t>-1;t--){let a=this.actionLogs[t];e.actionLogs.push(a.reverse())}return e}}class eG{cacheLogs=[];duringGroup=!1;add(e){e.type===l.U.Start&&(this.duringGroup=!0),this.cacheLogs.push(e),e.type===l.U.End&&(this.duringGroup=!1)}getActionGroup(){if(this.duringGroup)return null;let e=new eq(this.cacheLogs);return this.cacheLogs=[],e}}var e_=a(402041),eZ=a(501458);class eJ{constructor(e){this.executor=e}executeData(e,t,a){if(!e.themeRequest)return;let r=void 0===e.themeRequest.theme?0:e.themeRequest.theme;for(let[,e]of(t.docState.globalTheme=r,t.nodeManager.nodeMap)){let t=e.themeProps,n=e.getProp(v.d.ShapeType),o=eZ.M.convertShapeCategory(e.type,n?.shapeCode);if(t){let n=[];if(e.type===g.Jq.Connector){let e=e_.P.getConnectColor(t.fillColorCode,r),a=e_.P.getConnectStyle(t.connectWidthCode,o,r),s={type:v.d.Border,borderColor:e,lineDashType:a};n.push(s)}else{let e={type:v.d.Color,color:"#000000"};n.push(e)}let s={id:e.id,props:n};this.executor.execRemote(s,l.U.UpdateNode,a)}}}}var eH=a(12506);class eB{constructor(e){this.executor=e}executeData(e,t,a){if(e.nodeOperations&&0!==e.nodeOperations.length)for(let r of e.nodeOperations)for(let e of eH.l.getInstance().convert(r,{globalTheme:t.docState.globalTheme,nodeManager:t.nodeManager,isDark:t.docState.isDark,resources:[]}))this.executor.execRemote(e.data,e.type,a)}}class eV{constructor(e){this.executor=e}executeData(e){if(!e.commentOp)return;let t={data:e.commentOp,type:l.U.Comment};this.executor.execUnOrder(t)}}class eF{constructor(e){this.executorManager=e}executeData(e,t,a){if(!e.roomRequest)return;let r={data:{...e.roomRequest,act:void 0===e.roomRequest.act?g.P1.Join:e.roomRequest.act},type:l.U.Room};this.executorManager.execRemoteUnOrder(r.data,r.type,a)}}class ez{constructor(e){this.executorManager=e}executeData(e,t,a){if(!e.collaborationRequest)return;let r={data:e.collaborationRequest,type:l.U.Collaboration};this.executorManager.execRemoteUnOrder(r.data,r.type,a)}}class eQ{constructor(e){this.executorManager=e}executeData(e,t,a){if(!e.pointerMove)return;let r={data:e.pointerMove,type:l.U.PointMove};this.executorManager.execRemoteUnOrder(r.data,r.type,a)}}class eW{constructor(e){this.executorManager=e}executeData(e,t,a){if(!e.selectRequest)return;let r={idList:e.selectRequest.nextIds||[],selectType:B.Q.Node,cells:[],rowCols:[]};switch(void 0===e.selectRequest.selectType&&(e.selectRequest.selectType=g.zo.NormalFocus),e.selectRequest.selectType){case g.zo.NormalFocus:break;case g.zo.Cell:r.cells=e.selectRequest.cells,r.selectType=B.Q.Cell;break;case g.zo.Row:r.rowCols=e.selectRequest.rowCols.map(e=>e.i),r.selectType=B.Q.Row;break;case g.zo.Col:r.rowCols=e.selectRequest.rowCols.map(e=>e.i),r.selectType=B.Q.Col}this.executorManager.execRemote(r,l.U.SelectNode,a)}}class e${constructor(e){this.executorManager=e}executeData(e,t,a){if(!e.docRequest?.revertDoc)return;let r={data:{...e.docRequest},type:l.U.DocRevert};this.executorManager.execRemoteUnOrder(r.data,r.type,a)}}class ej{batch=5;executors=new Map;constructor(e,t){this.execCtx=t,this.executors.set(g.Us.Theme,new eJ(e)),this.executors.set(g.Us.NodeV2,new eB(e)),this.executors.set(g.Us.Comment,new eV(e)),this.executors.set(g.Us.Room,new eF(e)),this.executors.set(g.Us.Collaboration,new ez(e)),this.executors.set(g.Us.Cursor,new eQ(e)),this.executors.set(g.Us.Select,new eW(e)),this.executors.set(g.Us.DocRevert,new e$(e))}exec(e,t){try{if(void 0===t.type)return;let a=this.executors.get(t.type);if(!a)return void console.error("\u7F3A\u4E4F\u5BF9\u5E94\u7684\u6D88\u606F\u5904\u7406\u5668,\u5DF2\u5FFD\u7565\u8BE5\u6D88\u606F");a.executeData(e,this.execCtx,t)}catch(e){console.error(e)}}}class eY{constructor(e,t){this.actionGroupCache=new eG,this.undoManager=new w,this.executor=new m(eg,t),this.remoteExecutor=new ej(this.executor,t),this.networkManager=new eL(this.remoteExecutor,e),this.docState=e}start(){this.networkManager.init(),this.docState.deviceId=this.networkManager.webSocketManager.getDeviceId()}execActionWithoutUndoStack(e){this.executor.exec(e),this.networkManager.addAction(e)}execActionWithoutNetwork(e){this.executor.exec(e)}execAction(e){this.executor.exec(e),this.networkManager.addAction(e),this.actionGroupCache.add(e);let t=this.actionGroupCache.getActionGroup();t&&this.undoManager.add(t)}async execUnOrderAction(e,t=!0){if(this.executor.execUnOrder(e),t)return new Promise((t,a)=>{let r=ef.C.getInstance().convert(e);r&&this.networkManager.sendUnOrderMsg(r,t,a)})}loadRemoteOpsWithInitial(e){for(let t of e){let e=t.payload.body.data;this.remoteExecutor.exec(e,t.payload.meta),this.docState.seq=t.seq}}loadOfflineOpsWithInitial(){}undo(){let e=this.undoManager.undo(this.executor);if(e)for(let t of e.actionLogs)this.networkManager.addAction(t)}redo(){let e=this.undoManager.redo(this.executor);if(e)for(let t of e.actionLogs)this.networkManager.addAction(t)}destroy(){this.networkManager.destroy()}}},816458:function(e,t,a){a.d(t,{H:()=>r});class r{reverseLog=null;constructor(e){this.data=e}reverse(){if(!this.reverseLog)throw Error("\u6570\u636E\u9519\u8BEF\uFF01");return this.reverseLog}}},616755:function(e,t,a){var r,n;a.d(t,{Q:()=>r}),(n=r||(r={}))[n.Node=0]="Node",n[n.Cell=1]="Cell",n[n.Row=2]="Row",n[n.Col=3]="Col"},455360:function(e,t,a){a.d(t,{q:()=>o});var r=a(451935),n=a(944379);class o{type=r.U.End;reverse(){return new n.M}clone(){return new o}data=null;reverseLog=null}},944379:function(e,t,a){a.d(t,{M:()=>o});var r=a(451935),n=a(455360);class o{type=r.U.Start;data=null;reverseLog=null;reverse(){return new n.q}clone(){return new o}}},281042:function(e,t,a){a.d(t,{$:()=>o});var r=a(816458),n=a(451935);class o extends r.H{type=n.U.MindMapRelation;clone(){return new o({id:this.data.id,fromParent:[...this.data.fromParent],toParent:[...this.data.toParent]})}}},334918:function(e,t,a){a.d(t,{C:()=>o});var r=a(451935),n=a(816458);class o extends n.H{type=r.U.AddNode;clone(){return new o(JSON.parse(JSON.stringify(this.data)))}}},541340:function(e,t,a){a.d(t,{d:()=>o});var r=a(451935),n=a(816458);class o extends n.H{type=r.U.MoveNode;clone(){return new o(JSON.parse(JSON.stringify(this.data)))}}},800866:function(e,t,a){a.d(t,{h:()=>o});var r=a(816458),n=a(451935);class o extends r.H{type=n.U.Relation;clone(){return new o(JSON.parse(JSON.stringify(this.data)))}}},298809:function(e,t,a){a.d(t,{q:()=>i});var r,n,o=a(451935),s=a(816458);(r=n||(n={})).Line="Line",r.Node="Node";class i extends s.H{type=o.U.RemoveNode;clone(){return new i(JSON.parse(JSON.stringify(this.data)))}}},175005:function(e,t,a){a.d(t,{O:()=>s});var r=a(451935),n=a(616755),o=a(816458);class s extends o.H{type=r.U.SelectNode;static selectNode(e){return new s({idList:e,cells:[],rowCols:[],selectType:n.Q.Node})}static selectTableRowCol(e,t,a=!1){return new s({idList:[e],cells:[],rowCols:t,selectType:a?n.Q.Row:n.Q.Col})}static selectTableCell(e,t){return new s({idList:[e],cells:t,rowCols:[],selectType:n.Q.Cell})}clone(){return new s(JSON.parse(JSON.stringify(this.data)))}}},513665:function(e,t,a){a.d(t,{x:()=>o});var r=a(451935),n=a(816458);class o extends n.H{type=r.U.UpdateNode;clone(){return new o(JSON.parse(JSON.stringify(this.data)))}}},457063:function(e,t,a){a.d(t,{g:()=>s});var r=a(816458),n=a(451935),o=a(513665);class s extends r.H{type=n.U.TableCellUpdate;clone(){let e=JSON.stringify(this.data);return new o.x(JSON.parse(e))}}},942795:function(e,t,a){a.d(t,{o:()=>s});var r=a(816458),n=a(451935),o=a(513665);class s extends r.H{type=n.U.TableRowColAdd;clone(){let e=JSON.stringify(this.data);return new o.x(JSON.parse(e))}}},589405:function(e,t,a){a.d(t,{O:()=>s});var r=a(816458),n=a(451935),o=a(513665);class s extends r.H{type=n.U.TableRowColRemove;clone(){let e=JSON.stringify(this.data);return new o.x(JSON.parse(e))}}},106969:function(e,t,a){a.d(t,{V:()=>s});var r=a(816458),n=a(451935),o=a(513665);class s extends r.H{type=n.U.TableRowColUpdate;clone(){let e=JSON.stringify(this.data);return new o.x(JSON.parse(e))}}},451935:function(e,t,a){var r,n;a.d(t,{U:()=>r}),(n=r||(r={}))[n.Start=0]="Start",n[n.End=1]="End",n[n.AddNode=2]="AddNode",n[n.AddLink=3]="AddLink",n[n.RemoveLink=4]="RemoveLink",n[n.RemoveNode=5]="RemoveNode",n[n.UpdateNode=6]="UpdateNode",n[n.SelectNode=7]="SelectNode",n[n.MoveNode=8]="MoveNode",n[n.Relation=9]="Relation",n[n.MindMapRelation=10]="MindMapRelation",n[n.TableCellUpdate=11]="TableCellUpdate",n[n.TableRowColUpdate=12]="TableRowColUpdate",n[n.TableRowColAdd=13]="TableRowColAdd",n[n.TableRowColRemove=14]="TableRowColRemove",n[n.Comment=15]="Comment",n[n.Resource=16]="Resource",n[n.PointMove=17]="PointMove",n[n.Room=18]="Room",n[n.Collaboration=19]="Collaboration",n[n.DocRevert=20]="DocRevert"},382125:function(e,t,a){a.d(t,{O:()=>r}),a(451935),a(805433),a(937093),a(976780),a(150630),a(335342),a(138743),a(298809),a(616755),a(590554),a(649356),a(842327),a(116141),a(871058),a(577304),a(962629),a(908877),a(899329),a(579537),a(290583),a(52957),a(255237),a(874772),a(575077),a(463954),a(827555),a(589549),a(769972),a(228760),a(103046),a(923183),a(95265),a(536599),a(281255),a(384764),a(939780),a(783499),a(783444),a(437861),a(132874),a(614405),a(903362),a(69624),a(970262),a(569250),a(562563),a(195706),a(514664),a(223922),a(288899),a(37645),a(75670),a(754405),a(755928),a(797379),a(962743),a(793720),a(977106),a(492663),a(152039),a(409397),a(291418),a(799473),a(788277),a(141171),a(266187),a(546185),a(146485),a(547310),a(15921),a(213909),a(718077),a(78485),a(694611),a(72765),a(943451),a(119498),a(640285);let r=40},788277:function(){var e,t,a,r,n,o,s,i,d,l,c,h;(s=e||(e={}))[s.CapInfo=0]="CapInfo",s[s.Shape=1]="Shape",s[s.Filter=2]="Filter",s[s.ConnectorShape=3]="ConnectorShape",s[s.Table=4]="Table",s[s.TableCell=5]="TableCell",s[s.DeleteRowCol=6]="DeleteRowCol",s[s.SetSameWidthHeight=7]="SetSameWidthHeight",s[s.SetTitle=8]="SetTitle",s[s.AddConnectorText=9]="AddConnectorText",s[s.EnterTypesetting=10]="EnterTypesetting",s[s.QuitTypesetting=11]="QuitTypesetting",s[s.Align=12]="Align",s[s.Group=13]="Group",s[s.Copy=14]="Copy",s[s.Duplicate=15]="Duplicate",s[s.OrderNode=16]="OrderNode",s[s.CopyPasteFormat=17]="CopyPasteFormat",s[s.Flip=18]="Flip",s[s.MergeCell=19]="MergeCell",s[s.SplitCell=20]="SplitCell",s[s.Rotate=21]="Rotate",s[s.LockUnlock=22]="LockUnlock",s[s.SectionCreate=23]="SectionCreate",s[s.SectionRemove=24]="SectionRemove",s[s.Hyperlink=25]="Hyperlink",s[s.UnlockAll=26]="UnlockAll",s[s.AddChildNode=27]="AddChildNode",s[s.FoldUnfold=28]="FoldUnfold",(i=t||(t={}))[i.NODES=0]="NODES",i[i.SHAPES=1]="SHAPES",i[i.ICONS=2]="ICONS",(d=a||(a={}))[d.SVG=1]="SVG",d[d.IMAGE=2]="IMAGE",(l=r||(r={}))[l.LEFT=0]="LEFT",l[l.HORIZONTAL_CENTER=1]="HORIZONTAL_CENTER",l[l.RIGHT=2]="RIGHT",l[l.TOP=3]="TOP",l[l.VERTICAL_CENTER=4]="VERTICAL_CENTER",l[l.BOTTOM=5]="BOTTOM",l[l.DISTRIBUTE_HORIZONTAL=6]="DISTRIBUTE_HORIZONTAL",l[l.DISTRIBUTE_VERTICAL=7]="DISTRIBUTE_VERTICAL",(c=n||(n={}))[c.SendToBack=0]="SendToBack",c[c.SendBackward=1]="SendBackward",c[c.BringToFront=2]="BringToFront",c[c.BringForward=3]="BringForward",(h=o||(o={}))[h.SET_TITLE=0]="SET_TITLE",h[h.SET_SAME_WIDTH_HEIGHT=1]="SET_SAME_WIDTH_HEIGHT",h[h.ADD_CONNECTOR_TEXT=2]="ADD_CONNECTOR_TEXT",h[h.ENTER_TYPESETTING=3]="ENTER_TYPESETTING",h[h.QUIT_TYPESETTING=4]="QUIT_TYPESETTING",h[h.HYPERLINK_CUD=5]="HYPERLINK_CUD",h[h.GROUP=6]="GROUP",h[h.UNGROUP=7]="UNGROUP",h[h.COPY=8]="COPY",h[h.DUPLICATE=9]="DUPLICATE",h[h.COPY_FORMAT=10]="COPY_FORMAT",h[h.PASTE_FORMAT=11]="PASTE_FORMAT",h[h.FLIP_H=12]="FLIP_H",h[h.FLIP_V=13]="FLIP_V",h[h.ROTATE=14]="ROTATE",h[h.MERGE_CELL=15]="MERGE_CELL",h[h.SPLIT_CELL=16]="SPLIT_CELL",h[h.LOCK_UNLOCK=17]="LOCK_UNLOCK",h[h.SECTION_CREATE=18]="SECTION_CREATE",h[h.SECTION_REMOVE=19]="SECTION_REMOVE",h[h.UNLOCK_ALL=20]="UNLOCK_ALL",h[h.ADD_CHILD_NODE=21]="ADD_CHILD_NODE",h[h.FOLD_UNFOLD=22]="FOLD_UNFOLD",h[h.FOLD_UNFOLD_ALL=23]="FOLD_UNFOLD_ALL"},620998:function(e,t,a){a.d(t,{c:()=>r});class r{constructor(e){this.networkState=e.networkState,this.docState=e.docState}disconnected(){}destroy(){}}},750019:function(e,t,a){var r,n,o=a(620998);a(215702),a(595258),(r=n||(n={})).http="http",r.socket="socket",o.c},60102:function(e,t,a){a.d(t,{z:()=>y});var r=a(678014),n=a(808687),o=a(797615),s=a(49104),i=a(805433);class d{getPadding(e){return i.G.getPadding(e)}afterZoom(e,t,a){let{x:r,y:n,scale:o}=e,{contentRender:s,auxiliaryRender:i,nodeManager:d}=t;s.setTransform(r,n,o),i.setTransform(r,n,o),d.afterScale(o)}}var l=a(73428),c=a(334905);class h extends d{type=s.c.ZoomToTop;handle(e,t){let{contentRender:a,nodeManager:r}=e;if(!r.nodeMap.size)return;let n=l.U.rectNode2Rect(r.getNodesBounds()),o=a.canvas.getBoundingClientRect(),{rightPadding:s,leftPadding:i}=this.getPadding(t?.padding),d=n.width,h=o.width-i-s,u=Math.min(Math.max(Math.min(h/d,o.height/n.height),c.vL),1),p=n.x+.5*d-(i+.5*h)/u,g=n.y;this.afterZoom({x:p,y:g,scale:u},e,t)}}class u extends d{type=s.c.ZoomToSelect;handle(e,t){let{contentRender:a,nodeManager:r,selectManager:n}=e;if(!r.nodeMap.size)return;let o=n.getSelectBounds(),s=a.canvas.getBoundingClientRect(),{x:d,y:c,scale:h}=i.G.computeViewportInfo(l.U.rectNode2Rect(o),s,t?.padding);this.afterZoom({x:d,y:c,scale:h},e,t)}}class p extends d{type=s.c.ZoomToFit;handle(e,t){let{contentRender:a,nodeManager:r}=e;if(!r.nodeMap.size)return;let n=r.getNodesBounds(),o=a.canvas.getBoundingClientRect(),{x:s,y:d,scale:c}=i.G.computeViewportInfo(l.U.rectNode2Rect(n),o,t?.padding);this.afterZoom({x:s,y:d,scale:c},e,t)}}class g extends d{type=s.c.ZoomToOrigin;handle(e,t){let{contentRender:a,nodeManager:r}=e;if(!r.nodeMap.size)return;let n=l.U.rectNode2Rect(r.getNodesBounds()),{topPadding:o,bottomPadding:s,rightPadding:i,leftPadding:d}=this.getPadding(t?.padding),c=a.canvas.getBoundingClientRect(),h=(c.width-d-i)/n.width,u=(c.height-o-s)/n.height,p=h<u?h:u,g=n.x-d/p,f=n.y-o/p;this.afterZoom({x:g,y:f,scale:p},e,t)}}class f extends d{handle(e,t){if(!t)throw Error("scale param error");if(void 0===t.scale)throw Error("ZoomToScale Error, the scale is null!");let{contentRender:a,auxiliaryRender:r,nodeManager:n}=e,{scale:o}=t;a.scaleToCenter(o),r.scaleToCenter(o),n.afterScale(o)}}class m extends d{type=s.c.ZoomToFitRect;handle(e,t){let{contentRender:a}=e;if(!t?.rect)return;let r=a.canvas.getBoundingClientRect(),{x:n,y:o,scale:s}=i.G.computeViewportInfo(t.rect,r);this.afterZoom({x:n,y:o,scale:s},e,t)}}class M extends d{type=s.c.ZoomToCoordinate;handle(e,t){if(!t)throw Error("scale param error");if(void 0===t.scale)throw Error("ZoomToScale Error, the scale is null!");if(void 0===t.x)throw Error("ZoomToScale Error, the x is null!");if(void 0===t.y)throw Error("ZoomToScale Error, the y is null!");let{contentRender:a,auxiliaryRender:r,nodeManager:n}=e,{x:o,y:s,scale:i}=t;a.setTransform(o,s,i),r.setTransform(o,s,i),n.afterScale(i)}}class w{constructor(){this.zoomHandlerMap=new Map([[s.c.ZoomToTop,new h],[s.c.ZoomToSelect,new u],[s.c.ZoomToFit,new p],[s.c.ZoomToOrigin,new g],[s.c.ZoomToScale,new f],[s.c.ZoomToFitRect,new m],[s.c.ZoomToCoordinate,new M]])}zoom(e,t,a){let r=this.zoomHandlerMap.get(e);if(!r)return void console.error("\u9519\u8BEF\u7684Zoom mode:",e);r.handle(t,a)}}var x=a(78485);class C{getNodesImageOfflineCanvas(e,t,a="",r=[]){let n=document.createElement("canvas"),o=e.map(e=>e.getRectNode()),s=i.G.getBounds(o,"cache"),{topPadding:d,leftPadding:l,rightPadding:c,bottomPadding:h}=i.G.getPadding(r),u=s.maxX+c,p=s.minX-l,g=s.maxY+h,f=s.minY-d,m=u-p,M=g-f;n.width=t*m,n.height=t*M;let w=n.getContext("2d");for(let r of(w.scale(t,t),w.translate(-p,-f),a&&(w.save(),w.fillStyle=a,w.fillRect(p,f,m,M),w.restore()),e))r.drawOnGLCtx(w);return n}getImageOfflineCanvas(e,t,a,r=""){let n=document.createElement("canvas"),{minX:o,maxY:s,minY:i,maxX:d}=t,l=d-o,c=s-i,h=e.searchNodes(o,i,d,s);n.width=a*l,n.height=a*c;let u=n.getContext("2d");for(let e of(u.scale(a,a),u.translate(-o,-i),r&&(u.save(),u.fillStyle=r,u.fillRect(o,i,l,c),u.restore()),h))e.drawOnGLCtx(u);return n}exportToImageBlob(e,t,a,r=""){return new Promise(n=>{this.getImageOfflineCanvas(e,t,a,r).toBlob(e=>{n(e)})})}exportToImageData(e,t,a,r=""){let{minX:n,maxY:o,minY:s,maxX:i}=t;return this.getImageOfflineCanvas(e,t,a,r).getContext("2d").getImageData(0,0,i-n,o-s)}}class y{isDestroy=!1;needRenderContent=!1;needRenderAuxiliary=!1;constructor(e,t,a,r,n){this.gmlRender=e,this.nodeManager=t,this.auxiliaryManager=a,this.commentManager=n,this.docState=r,this.zoomWorker=new w,this.imageWorker=new C}start(){this.tickerRun()}addContentDrawTask(){this.needRenderContent=!0}addAuxiliaryDrawTask(){this.needRenderAuxiliary=!0}zoomAndSynDraw(e,t){let a={contentRender:this.gmlRender,auxiliaryRender:this.auxiliaryManager.gmlRender,nodeManager:this.nodeManager,selectManager:this.auxiliaryManager.selectManager};this.zoomWorker.zoom(e,a,t),this.contentDirectDraw(),this.auxiliaryManager.redraw(),this.commentManager.refreshAllCommentShowInfo();let r=this.commentManager.getAllCommentShowMessage();this.auxiliaryManager.addOrUpdateAuxiliaryDomState(x.l.ShowCommentPins,r);let n={type:"viewport",data:this.getViewportInfo()};this.auxiliaryManager.addOrUpdateAuxiliaryDomState(x.l.Viewport,n)}zoom(e,t){let a={contentRender:this.gmlRender,auxiliaryRender:this.auxiliaryManager.gmlRender,nodeManager:this.nodeManager,selectManager:this.auxiliaryManager.selectManager};this.zoomWorker.zoom(e,a,t),this.addContentDrawTask(),this.addAuxiliaryDrawTask(),this.commentManager.refreshAllCommentShowInfo();let r=this.commentManager.getAllCommentShowMessage();this.auxiliaryManager.addOrUpdateAuxiliaryDomState(x.l.ShowCommentPins,r);let n={type:"viewport",data:this.getViewportInfo()};this.auxiliaryManager.addOrUpdateAuxiliaryDomState(x.l.Viewport,n)}exportToImgBlob(e,t=1,a=""){return this.imageWorker.exportToImageBlob(this.nodeManager,e,t,a)}exportToImageData(e,t=1,a=""){return this.imageWorker.exportToImageData(this.nodeManager,e,t,a)}getImageOfflineCanvas(e,t=1,a=""){return this.imageWorker.getImageOfflineCanvas(this.nodeManager,e,t,a)}getNodesImageOfflineCanvas(e,t,a="",r=[]){return this.imageWorker.getNodesImageOfflineCanvas(e,t,a,r)}exportToNodesImgBlob(e,t=1,a="",r=[]){return new Promise(n=>{this.getNodesImageOfflineCanvas(e,t,a,r).toBlob(e=>{n(e)})})}redrawOnCacheRefreshed(e){let t=e.filter(e=>e.isAsync());if(0!==t.length)for(let e of t)e.refreshCache().then(()=>{let t=e.getRectNode(),a=n.D.computeDirtyDrawGraphics(this.nodeManager,t);this.gmlRender.dirtyDraw(t,a,this.docState.showGrid)})}contentDirectDraw(){let e=this.gmlRender.getViewPortBounds(),t=this.nodeManager.tree.search(e),a=new Set,n=[];for(let e of t){let t=this.nodeManager.nodeMap.get(e.id);t&&a.add(t),t&&(t.type===o.Jq.Section||t.type===o.Jq.Table)&&n.push(t)}let s=[...a];s=r.v.sortGraphicsV2(s);let i=this.docState.showGrid&&!this.docState.isBlockMode();return this.gmlRender.directDraw(e,s,i),this.collectSectionTitleDraw(n),s}redrawWithinViewBounds(){this.contentDirectDraw(),this.needRenderAuxiliary&&this.auxiliaryManager.redraw()}tickerRun=()=>{if(!this.isDestroy){if(this.needRenderContent){let e=this.contentDirectDraw();this.needRenderContent=!1,this.redrawOnCacheRefreshed(e)}if(this.needRenderAuxiliary){let e=this.auxiliaryManager.animationGraphics.size>0;this.auxiliaryManager.redraw(),e?this.needRenderAuxiliary=!0:this.needRenderAuxiliary=!1}this.auxiliaryManager.redrawAuxiliaryDom(),requestAnimationFrame(this.tickerRun)}};collectSectionTitleDraw(e){0!==e.length&&(this.auxiliaryManager.updateTitleGraphics(e),this.addAuxiliaryDrawTask())}getViewportInfo(){let{a:e,e:t,f:a}=this.gmlRender.globalTransform;return{x:t,y:a,scale:e/window.devicePixelRatio}}reset(){this.gmlRender.reset()}destroy(){this.gmlRender.reset(),this.isDestroy=!0}}},678014:function(e,t,a){a.d(t,{v:()=>n});var r=a(428202);class n{static addTreeChildToList(e,t,a){for(let r of e){a.push(r);let e=t.get(r);e&&e.length>0&&this.addTreeChildToList(e,t,a)}}static makeSortGraphic(e){let t=[e],a=e.parent;for(;a&&a.id!==r.r.id;)t.unshift(a),a=a.parent;return{graphics:t}}static sortGraphicsV2(e){let t=e.map(this.makeSortGraphic);return t.sort((e,t)=>{let a=Math.min(e.graphics.length,t.graphics.length);for(let r=0;r<a;r++){let a=e.graphics[r],n=t.graphics[r];if(a!==n){if(a.zIndex>n.zIndex)return 1;return -1}}return e.graphics.length-t.graphics.length}),t.map(e=>e.graphics[e.graphics.length-1])}static addNodeDrawTask(e,t){t.renderManager.addContentDrawTask(),t.auxiliaryManager.selectManager.include(e)&&(t.auxiliaryManager.updateSelectGraphic(),t.renderManager.addAuxiliaryDrawTask())}}},49104:function(e,t,a){var r,n;a.d(t,{c:()=>r}),(n=r||(r={}))[n.ZoomToScale=0]="ZoomToScale",n[n.ZoomToFit=1]="ZoomToFit",n[n.ZoomToSelect=2]="ZoomToSelect",n[n.ZoomToTop=3]="ZoomToTop",n[n.ZoomToOrigin=4]="ZoomToOrigin",n[n.ZoomToFitRect=5]="ZoomToFitRect",n[n.ZoomToCoordinate=6]="ZoomToCoordinate"},624621:function(e,t,a){var r,n;a.d(t,{o:()=>r}),(n=r||(r={}))[n.ContextMenu=0]="ContextMenu",n[n.DbClickShapeMenu=1]="DbClickShapeMenu",n[n.QuickShapeMenu=2]="QuickShapeMenu",n[n.IPadPasteMenu=3]="IPadPasteMenu",n[n.NONE=4]="NONE"}}]);