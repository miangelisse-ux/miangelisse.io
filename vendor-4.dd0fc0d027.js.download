/*! For license information please see vendor-4.dd0fc0d027.js.LICENSE.txt */
(window.webpackChunkweb=window.webpackChunkweb||[]).push([["15252"],{412123:function(e,t,n){"use strict";n.r(t),n.d(t,{X_COMMAND_HEADERS:()=>u,RETRY_ERROR_CODES:()=>h,FEATURE_GATE_NAME:()=>a,NetworkState:()=>s,ChannelState:()=>o,IO:()=>eb});var i,r,o,s,a,c,h=[1015,9998];(i=o||(o={})).http="http",i.socket="socket",(r=s||(s={})).online="online",r.offline="offline",r.weakline="weakline";var u={"x-command":"api.rce.pandora"};(a||(a={})).REQUEST_MELTDOWN_AJAX_ENABLE="request_meltdown_ajax_enable";var l=n(179314),p=n(176777),f=n(702e3),d=n(180536),g=n(936094),y=n(647631),v=n(801216),m=n(759590),b=n(569833),k=n(165733),E=n(488882),I=n.n(E),O=n(258028),_="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function w(e){var t=function(e){void 0===e&&(e=20);for(var t="",n=0;n<e;n++){var i=Math.floor(Math.random()*_.length);t+=_[i]}return t}(32),n=I()(e+t);return Number((parseInt(n=Math.floor(6*Math.random())+1+(n=n.slice(8,24)).slice(1),16)+"").slice(0,14))}function T(e){try{var t=new WeakSet;return JSON.stringify(e,function(e,n){var i;return(i=typeof n,null==n||"object"!==i&&"function"!==i)?n:t.has(n)?"[Circular]":(t.add(n),n instanceof Error)?String(n.message):n})}catch(t){return String(e)}}function C(e){return e<=65535?2:4}function S(e){return e<=127?1:e<=2047?2:e<=65535?3:4}var N=n(71642),P=n(504957),H=n(686090),x=n(483574),A=n(873833),R=n(839711),M=n(34602),L=n(715822),F=n(340600),q=n(628023),D=n(720878),$=n(429917),B=n(626622),U=n(864757),j=n(192243),W=n(164287),G=n(539397),Z=function(e,t){return(Z=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function V(e,t){function n(){this.constructor=e}Z(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var K=function(){return(K=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function z(e,t,n,i){return new(n||(n=Promise))(function(r,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((i=i.apply(e,t||[])).next())})}function J(e,t){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){var c=[o,a];if(n)throw TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&c[0]?i.return:c[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,c[1])).done)return r;switch(i=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,i=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===c[0]||2===c[0])){s=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(6===c[0]&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],i=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var X=function(){function e(){this.destroy$=new N.x}return e.prototype.takeUntil=function(){return(0,F.R)(this.destroy$)},e.prototype.from=function(e){return(0,P.D)(e).pipe(this.takeUntil())},e.prototype.toPromise=function(e){var t=this;return new Promise(function(n,i){var r,o=!1;t.from(e).subscribe(function(e){o=!0,r=e},i,function(){o&&n(r)})})},e.prototype.destroy=function(){this.destroy$.next(),this.destroy$.complete()},e}(),Q=function(){function e(e,t,n){var i=this;this.pingable=e,this.options=t,this.logger=n,this.rxOp=new X,this.reset$=new N.x,this.pongTimedOut$=new N.x,this.pingCount=0,this.lastPongAt=0,this.firstPingAt=0,this.isReceivedPong=!1,this.reset$.pipe(this.rxOp.takeUntil()).subscribe(function(e){return i.resetImpl(e)})}return e.prototype.getPingCount=function(){return this.pingCount},e.prototype.reset=function(e){this.reset$.next(e)},e.prototype.resetImpl=function(e){this.pingCount=0,e&&this.pingLoop()},e.prototype.pingLoop=function(){return z(this,void 0,void 0,function(){var e;return J(this,function(t){switch(t.label){case 0:this.firstPingAt=Date.now(),t.label=1;case 1:return this.isReceivedPong&&(this.firstPingAt=Date.now()),this.pingable.ping()&&(this.pingCount+=1,this.isReceivedPong=!1),this.isPongTimedOut()&&this.pongTimedOut$.next(),e=(0,H.H)(this.options.pingInterval).pipe((0,F.R)(this.reset$)),[4,this.rxOp.toPromise(e)];case 2:return t.sent(),[3,1];case 3:return[2]}})})},e.prototype.isPongTimedOut=function(){return Date.now()-this.firstPingAt>this.options.pongTimeout},e.prototype.onPongMessage=function(){this.lastPongAt=Date.now(),this.isReceivedPong=!0,this.logger.logPingPongTime(this.lastPongAt-this.firstPingAt)},e.prototype.destroy=function(){this.reset$.complete(),this.pongTimedOut$.complete(),this.rxOp.destroy()},e}(),Y=function(){function e(t,n){this.options=t,this.logger=n,this.connectionId=e.genNextConnectionId(),this.rxOp=new X,this.ws=null,this.message$=new N.x,this.close$=new N.x,this.error$=new N.x}return e.genNextConnectionId=function(){var e=this.nextConnectionId;return this.nextConnectionId+=1,e},e.prototype.getIsDestroyed=function(){return this.rxOp.destroy$.isStopped},e.prototype.getReadyState=function(){return this.ws?this.ws.readyState:null},e.prototype.getEndPoint=function(){return this.options.endPoint},e.prototype.getDeviceId=function(){return this.options.deviceId},e.prototype.connect=function(){return z(this,void 0,void 0,function(){var e,t,n,i,r=this;return J(this,function(o){switch(o.label){case 0:return this.logger.logBeforeConnectTo(this.connectionId,this.options.endPoint),e=Date.now(),(t=new WebSocket(this.options.url,this.options.protocols)).binaryType=this.options.binaryType,n=(0,x.T)((0,A.R)(t,"open").pipe((0,q.h)("OPEN")),(0,H.H)(this.options.connectTimeout).pipe((0,q.h)("TIMEOUT")),(0,A.R)(t,"error").pipe((0,q.h)("ERROR"))).pipe((0,L.q)(1),(0,D.B)()),this.logger.logConnecting(this.connectionId),n.subscribe(function(n){r.logConnectTime(n,e),r.getIsDestroyed()&&r.closeWebSocket(t)}),[4,this.rxOp.toPromise(n)];case 1:return i=o.sent(),this.logger.logConnectResult(this.connectionId,i,t.readyState),"OPEN"===i&&(this.ws=t,this.registerWebSocketEvents(t)),[2,i]}})})},e.prototype.logConnectTime=function(e,t){var n=Date.now();"OPEN"===e&&this.logger.logConnectTime(this.connectionId,n-t)},e.prototype.registerWebSocketEvents=function(e){(0,A.R)(e,"message").pipe(this.rxOp.takeUntil()).subscribe(this.message$),(0,A.R)(e,"close").pipe(this.rxOp.takeUntil()).subscribe(this.close$),(0,A.R)(e,"error").pipe(this.rxOp.takeUntil()).subscribe(this.error$)},e.prototype.send=function(e){var t=Object.prototype.toString.call(e).slice(8,-1);return this.logger.logConnectionSend(this.connectionId,this.getReadyState(),t),!!this.canSend(this.ws)&&(this.ws.send(e),!0)},e.prototype.canSend=function(e){return null!==e&&e.readyState===WebSocket.OPEN},e.prototype.destroy=function(){this.logger.logConnectionDestroy(this.connectionId,null!==this.ws),this.message$.complete(),this.close$.complete(),this.error$.complete(),this.rxOp.destroy(),this.closeWebSocket(this.ws),this.ws=null},e.prototype.closeWebSocket=function(e){null!==e&&e.close()},e.nextConnectionId=0,e}(),ee=function(){function e(e,t,n){this.factory=e,this.options=t,this.logger=n,this.stopRaceOp=new X,this.stopSwitchOp=new X,this.activeConnection$=new R.X(null),this.newActiveConnection$=this.activeConnection$.asObservable().pipe((0,$.T)(1),(0,D.B)()),this.ticketManager=this.factory.getTicketManager(),this.lastEndPoint=null,this.message$=new N.x,this.close$=new N.x,this.error$=new N.x}return e.prototype.getActiveConnection=function(){return this.activeConnection$.getValue()},e.prototype.switch=function(){return z(this,void 0,void 0,function(){var e;return J(this,function(t){switch(t.label){case 0:if(this.logger.logBeforeSwitch(this.options.endPoints.length),this.options.endPoints.length<=1)return[2,null];return this.stopRaceAndSwitch(),[4,this.switchImpl()];case 1:return e=t.sent(),this.logger.logAfterSwitch(null!==e),this.stopRaceAndSwitch(),null!==e&&this.setNewActiveConnection(e),[2,e]}})})},e.prototype.switchImpl=function(){return z(this,void 0,void 0,function(){var e,t,n,i,r,o,s=this;return J(this,function(a){switch(a.label){case 0:e=this.options.endPoints.filter(function(e){return e!==s.lastEndPoint}),null!==this.lastEndPoint&&e.unshift(this.lastEndPoint),t=0,n=e,a.label=1;case 1:if(!(t<n.length))return[3,4];return i=n[t],r=this.factory.createSwitchRetryController(),this.logger.logBeforeSwitchingToEndPoint(i),[4,this.tryCreatingConnectionWithRetry(i,r,this.stopSwitchOp)];case 2:if(o=a.sent(),this.logger.logAfterSwitchingToEndPoint(i,null!==o),null===o)return[3,3];return[2,o];case 3:return t++,[3,1];case 4:return[2,null]}})})},e.prototype.race=function(){return z(this,void 0,void 0,function(){var e;return J(this,function(t){switch(t.label){case 0:return this.logger.logBeforeRace(),this.stopRaceAndSwitch(),[4,this.raceImpl()];case 1:return e=t.sent(),this.logger.logAfterRace(),this.stopRaceAndSwitch(),this.setNewActiveConnection(e),[2,e]}})})},e.prototype.raceImpl=function(){return z(this,void 0,void 0,function(){var e,t=this;return J(this,function(n){var i;return e=this.stopRaceOp.from(this.options.endPoints).pipe((0,B.z)(function(e){var n=t.factory.createRaceRetryController();return t.tryCreatingConnectionWithRetry(e,n,t.stopRaceOp)}),(i=function(e){return null!==e},function(e){return e.pipe((0,M.h)(i),(0,L.q)(1))})),[2,this.stopRaceOp.toPromise(e)]})})},e.prototype.tryCreatingConnectionWithRetry=function(e,t,n){return z(this,void 0,void 0,function(){var i,r,o,s;return J(this,function(a){switch(a.label){case 0:n.destroy$.pipe((0,L.q)(1)).subscribe(function(){return t.destroy()}),a.label=1;case 1:if(!t.canRetry())return[3,5];return[4,n.toPromise(t.timeout())];case 2:return a.sent(),this.logger.logBeforeLoadingTicket(),[4,n.toPromise(this.ticketManager.loadTicket())];case 3:if(r=(i=a.sent()).ticket,o=i.isFromCache,this.logger.logAfterLoadingTicket(null!==r,o),null===r)return[3,1];return o||t.reset(),[4,n.toPromise(this.tryCreatingConnection(e,r,n))];case 4:if(null===(s=a.sent()))return[3,1];return[2,s];case 5:return[2,null]}})})},e.prototype.tryCreatingConnection=function(e,t,n){return z(this,void 0,void 0,function(){var i,r,o;return J(this,function(s){switch(s.label){case 0:return i=this.factory.createWebSocketConnection(e,t),r=n.destroy$.pipe((0,q.h)(null)),[4,(0,x.T)(i.connect(),r).pipe((0,L.q)(1)).toPromise()];case 1:if("OPEN"===(o=s.sent()))return[2,i];return null===o&&this.logger.logConnectionDestroyedByStopOp(i.connectionId),i.destroy(),[2,null]}})})},e.prototype.refresh=function(){return z(this,void 0,void 0,function(){return J(this,function(e){switch(e.label){case 0:return this.destroyActiveConnection(),[4,this.switch()];case 1:if(null!==e.sent())return[3,3];return[4,this.race()];case 2:e.sent(),e.label=3;case 3:return[2]}})})},e.prototype.destroyActiveConnection=function(){var e=this.getActiveConnection();null!==e&&(e.destroy(),this.activeConnection$.next(null))},e.prototype.setNewActiveConnection=function(e){var t=this,n=this.getActiveConnection();null!==n&&n.destroy(),this.activeConnection$.next(e),this.lastEndPoint=e.getEndPoint(),e.message$.pipe((0,F.R)(this.newActiveConnection$)).subscribe(function(e){return t.message$.next(e)}),e.error$.pipe((0,F.R)(this.newActiveConnection$)).subscribe(function(e){return t.error$.next(e)}),e.close$.pipe((0,F.R)(this.newActiveConnection$)).subscribe(function(e){t.destroyActiveConnection(),t.close$.next(e)})},e.prototype.stopRaceAndSwitch=function(){this.stopRaceOp.destroy$.next(),this.stopSwitchOp.destroy$.next()},e.prototype.reset=function(){this.destroyActiveConnection(),this.stopRaceAndSwitch()},e.prototype.destroy=function(){this.destroyActiveConnection(),this.activeConnection$.complete(),this.message$.complete(),this.close$.complete(),this.error$.complete(),this.stopRaceOp.destroy(),this.stopSwitchOp.destroy()},e}(),et=function(){function e(e){this.strategy=e,this.rxOp=new X,this.retryIndex=-1,this.timeoutPromise=null}return e.prototype.canRetry=function(){return this.retryIndex<this.strategy.maxRetryTimes},e.prototype.timeout=function(){return z(this,void 0,void 0,function(){var e;return J(this,function(t){return(e=this.strategy.getRetryInterval(this.retryIndex),this.retryIndex>=this.strategy.maxRetryTimes||null===e)?(this.retryIndex=this.strategy.maxRetryTimes,[2]):(null===this.timeoutPromise&&(this.timeoutPromise=this.timeoutImpl(e)),[2,this.timeoutPromise])})})},e.prototype.timeoutImpl=function(e){return z(this,void 0,void 0,function(){return J(this,function(t){switch(t.label){case 0:return[4,this.rxOp.toPromise((0,H.H)(e))];case 1:return t.sent(),this.timeoutPromise=null,this.retryIndex=(this.retryIndex+1)%this.strategy.maxRetryTimes,[2]}})})},e.prototype.reset=function(){this.rxOp.destroy$.next(),-1!==this.retryIndex&&(this.retryIndex=0),this.timeoutPromise=null},e.prototype.destroy=function(){this.reset(),this.rxOp.destroy()},e}(),en={nested:{protocol:{nested:{Frame:{fields:{seqid:{rule:"required",type:"uint64",id:1},logid:{rule:"required",type:"uint64",id:2},service:{rule:"required",type:"int32",id:3},method:{rule:"required",type:"int32",id:4},headers:{rule:"repeated",type:"ExtendedEntry",id:5},payloadEncoding:{type:"string",id:6},payloadType:{type:"string",id:7},payload:{type:"bytes",id:8},LogIDNew:{type:"string",id:9}},nested:{ExtendedEntry:{fields:{key:{rule:"required",type:"string",id:1},value:{rule:"required",type:"string",id:2}}}}}}}}},ei=function(){function e(e){this.config=e,this.package=null,this.lookupType="protocol.Frame"}return e.prototype.pack=function(e,t){var n=this.formatMessage(e,t.headers),i=this.parseBytesFields(n,function(e){return W.Base64.encode(String(e))}),r=this.getPackage(),o=r.verify(i);if(o)throw Error(o);var s=r.create(i);return r.encode(s).finish()},e.prototype.unpack=function(e){var t=this.getPackage(),n=t.decode(new G.util.Array(e)),i=t.toObject(n,{longs:String,enums:String,bytes:String});return this.parseBytesFields(i,function(e){var t=W.Base64.decode(String(e));try{return JSON.parse(t)}catch(e){return t}})},e.prototype.getServiceId=function(e){return this.config.serviceId},e.prototype.formatMessage=function(e,t){return void 0===t&&(t={}),{seqid:1,logid:1,service:this.getServiceId(e),method:1,payloadType:"json",headers:Object.keys(t).map(function(e){return{key:e,value:t[e]}}),payload:JSON.stringify(e)}},e.prototype.parseBytesFields=function(e,t){var n=this.getPackage().fields,i={};for(var r in n)!0===n[r].bytes?i[r]=t(e[r]):i[r]=e[r];return i},e.prototype.getPackage=function(){var e=this.lookupType;return this.package||(this.package=G.Root.fromJSON(en).root.lookupType(e)),this.package},e}(),er=function(){function e(e){this.retryIntervalAfterLastRetry=e,this.isFirstRetry=!0,this.maxRetryTimes=3}return e.prototype.getRetryInterval=function(e){return -1===e?this.retryIntervalAfterLastRetry?0:Math.floor(40*Math.random()*1e3):this.isFirstRetry||0!==e?(this.isFirstRetry=!1,Math.floor(10*Math.random()*1e3)+5e3*e):this.retryIntervalAfterLastRetry},e}(),eo=function(){function e(e,t,n,i){this.ticketManager=e,this.webSocketConfig=t,this.frontierConfig=n,this.logger=i}return e.prototype.createWebSocketConnection=function(e,t){return new Y(this.makeWebSocketOptions(e,t),this.logger)},e.prototype.getTicketManager=function(){return this.ticketManager},e.prototype.createRaceRetryController=function(){return new et(new er(12e4))},e.prototype.createSwitchRetryController=function(){return new et(new er(null))},e.prototype.makeWebSocketOptions=function(e,t){var n,i,r,o,s,a,c=this.makeFrontierQuery(this.frontierConfig,t),h=(i=(n={url:e,query:c}).url,r=n.query,o=n.path,s=O.parse(location.href,!0),a=O.parse(i,!0),/\/\//.test(i)||(a.href=s.protocol+"//"+i,a.hostname=i),a.protocol=a.protocol||("http:"===s.protocol?"ws:":"wss:"),a.query=Object.assign(a.query,r,{stamp:Date.now()}),a.query=Object.assign(a.query,r),a.path=void 0===o?null:o,O.format(a)),u=c.device_id,l=this.webSocketConfig;return{url:h,deviceId:u,endPoint:e,protocols:l.protocols,binaryType:l.binaryType,connectTimeout:l.connectTimeout}},e.prototype.makeFrontierQuery=function(e,t){var n=e.fpid,i=e.appKey,r=e.accessSalt,o=e.noteToken,s=e.query,a=s&&s.device_id||w(o);return K(K({},s),{device_id:a,access_key:this.makeAccessKey(n,i,a,r),session_ticket:t})},e.prototype.makeAccessKey=function(e,t,n,i){return I()(""+e+t+n+i)},e}(),es=function(){function e(e,t,n,i,r,o){var s=this;this.ticketManager=e,this.webSocketConfig=t,this.wsManagerOptions=n,this.frontierConfig=i,this.pingPongOptions=r,this.logger=o,this.rxOp=new X,this.wsManager=new ee(new eo(this.ticketManager,this.webSocketConfig,this.frontierConfig,this.logger),this.wsManagerOptions,this.logger),this.message$=new N.x,this.close$=this.wsManager.close$.asObservable(),this.error$=this.wsManager.error$.asObservable(),this.newActiveConnection$=this.wsManager.newActiveConnection$,this.pingPongCtrl=new Q(this,this.pingPongOptions,this.logger),this.pongTimeout$=this.pingPongCtrl.pongTimedOut$.asObservable(),this.packager=new ei(this.frontierConfig),this.wsManager.message$.pipe((0,U.U)(function(e){return e.data}),this.rxOp.takeUntil()).subscribe(function(e){return s.handleMessageData(e)}),this.wsManager.newActiveConnection$.pipe((0,U.U)(function(e){return null!==e}),this.rxOp.takeUntil()).subscribe(function(e){return s.pingPongCtrl.reset(e)})}return e.prototype.handleMessageData=function(e){if(this.isPongMessage(e)){this.pingPongCtrl.onPongMessage(),this.logger.logPong();return}var t=this.packager.unpack(e);this.logger.logOnMessageData(t),this.sendMessageAck(t),t&&"string"!=typeof t&&this.message$.next(t)},e.prototype.isPongMessage=function(e){return e===this.pingPongOptions.message},e.prototype.sendMessageAck=function(e){e.headers&&e.headers.find(function(e){return"need_ack"===e.key&&"1"===e.value})&&this.send({},{headers:{is_ack:"1",ack_id:e.LogIDNew||"",ack_code:"0"}})},e.prototype.ping=function(){var e=this.wsManager.getActiveConnection();if(null===e)return!1;var t=e.send(this.pingPongOptions.message);if(t){var n=this.pingPongCtrl.getPingCount();this.logger.logPingSuccess(n+1)}else this.logger.logPingFailure();return t},e.prototype.send=function(e,t){var n=this.wsManager.getActiveConnection();return null!==n&&n.send(this.packager.pack(e,t))},e.prototype.connect=function(){return this.wsManager.race()},e.prototype.refresh=function(){this.wsManager.refresh()},e.prototype.reset=function(){this.wsManager.reset()},e.prototype.destroy=function(){this.message$.complete(),this.wsManager.destroy(),this.pingPongCtrl.destroy(),this.rxOp.destroy()},e}(),ea=function(){function e(e){this.options=e,this.rxOp=new X,this.ticket=this.options.initTicket,this.ticket$=new N.x,this.ticketExpireAt=this.getInitialTicketExpireAt(),this.loadTicketPromise=null}return e.prototype.getInitialTicketExpireAt=function(){return this.options.initTicket?Date.now()+this.options.expireAfter:0},e.prototype.loadTicket=function(){return null==this.ticket||this.isTicketExpired()?(this.ticket=null,null===this.loadTicketPromise&&(this.loadTicketPromise=this.loadTicketAndSave()),this.loadTicketPromise):Promise.resolve({ticket:this.ticket,isFromCache:!0})},e.prototype.markTicketAsExpired=function(){this.ticketExpireAt=Date.now()},e.prototype.loadTicketAndSave=function(){return z(this,void 0,void 0,function(){var e;return J(this,function(t){switch(t.label){case 0:return[4,this.rxOp.toPromise(this.randomSleepFor(1e4))];case 1:t.sent(),e=null,t.label=2;case 2:return t.trys.push([2,4,,5]),[4,this.rxOp.toPromise(this.options.loadTicketImpl())];case 3:return e=t.sent(),[3,5];case 4:return t.sent(),[3,5];case 5:return e?(this.ticket=e,this.updateTicketExpireAt(),this.ticket$.next(e)):e=null,this.loadTicketPromise=null,[2,{ticket:e,isFromCache:!1}]}})})},e.prototype.isTicketExpired=function(){return Date.now()>=this.ticketExpireAt},e.prototype.updateTicketExpireAt=function(){this.ticketExpireAt=Date.now()+this.options.expireAfter},e.prototype.randomSleepFor=function(e){return(0,H.H)(Math.floor(Math.random()*e))},e.prototype.destroy=function(){this.rxOp.destroy(),this.ticket$.complete(),this.loadTicketPromise=null},e}(),ec=function(){function e(){this.rxOp=new X,this.state$=new R.X("ONLINE"),this.newState$=this.state$.pipe((0,j.G)(),this.rxOp.takeUntil()),this.sendSuccessTimes=0,this.sendFailureTimes=0,this.receiveTimes=0}return Object.defineProperty(e.prototype,"state",{get:function(){return this.state$.getValue()},enumerable:!0,configurable:!0}),e.prototype.getState=function(){return this.state},e.prototype.is=function(e){return this.state===e},e.prototype.getStats=function(){return{sendSuccessTimes:this.sendSuccessTimes,sendFailureTimes:this.sendFailureTimes,receiveTimes:this.receiveTimes}},e.prototype.browserOnline=function(){this.sendFailureTimes=0,this.receiveTimes=0,this.state$.next("ONLINE")},e.prototype.browserOffline=function(){this.state$.next("OFFLINE")},e.prototype.sendMessageSuccess=function(){switch(this.state){case"ONLINE":this.sendSuccessTimes+=1,this.state$.next("GOOD_CONNECTION");return;case"POOR_CONNECTION":0===this.sendFailureTimes?(this.sendSuccessTimes+=1,this.state$.next("GOOD_CONNECTION")):(this.sendSuccessTimes+=1,this.sendFailureTimes=0);return;case"GOOD_CONNECTION":this.sendSuccessTimes+=1;return;case"OFFLINE":return}},e.prototype.intoPoorConnection=function(){this.sendSuccessTimes=0,this.sendFailureTimes=0,this.receiveTimes=0,this.state$.next("POOR_CONNECTION")},e.prototype.sendMessageFailure=function(){switch(this.state){case"ONLINE":this.intoPoorConnection();return;case"POOR_CONNECTION":this.sendFailureTimes+=1;return;case"GOOD_CONNECTION":0===this.sendFailureTimes?this.sendFailureTimes+=1:this.intoPoorConnection();return;case"OFFLINE":return}},e.prototype.receivedBroadcastMessage=function(){switch(this.state){case"ONLINE":case"POOR_CONNECTION":case"GOOD_CONNECTION":this.receiveTimes+=1;return;case"OFFLINE":return}},e.prototype.destroy=function(){this.state$.complete(),this.rxOp.destroy()},e}(),eh=new(function(){function e(){this.extensions={}}return e.prototype.setExtension=function(e,t){this.extensions[e]=t},e.prototype.removeExtension=function(e){delete this.extensions[e]},e.prototype.getExtension=function(e){return this.extensions[e]},e.prototype.getExtensions=function(){return this.extensions},e.prototype.init=function(e){var t=this;void 0===e&&(e={}),(0,l.Z)(e,function(e,n){return t.setExtension(n,e)})},e}()),eu={HEARTBEAT_SERVER_TIME:"hearbeat_server_time",HEARTBEAT_CLIENT_TIME:"hearbeat_client_time",LAST_SERVER_PUSH_TIME:"last_server_push_time",LAST_CLIENT_OFFLINE_TIME:"last_client_offline_time"},el=function(){function e(){this.storage=eh.getExtensions()&&eh.getExtensions().Storage||ep}return e.prototype.setHeartbeatTime=function(e){var t=Date.now();this.storage.setItem(ef(eu.HEARTBEAT_SERVER_TIME),e),this.storage.setItem(ef(eu.HEARTBEAT_CLIENT_TIME),t)},e.prototype.setSocketPushTime=function(e){this.storage.setItem(ef(eu.LAST_SERVER_PUSH_TIME),e)},e.prototype.setOfflineTime=function(){return z(this,void 0,void 0,function(){var e,t,n,i;return J(this,function(r){switch(r.label){case 0:return[4,this.storage.getItem(ef(eu.HEARTBEAT_SERVER_TIME))];case 1:return e=r.sent(),[4,this.storage.getItem(ef(eu.HEARTBEAT_CLIENT_TIME))];case 2:return t=r.sent(),n=Date.now(),i=+e+(n-t),this.storage.setItem(ef(eu.LAST_CLIENT_OFFLINE_TIME),i),[2]}})})},e.prototype.getOfflineTime=function(){return z(this,void 0,void 0,function(){var e,t;return J(this,function(n){switch(n.label){case 0:return[4,this.storage.getItem(ef(eu.LAST_CLIENT_OFFLINE_TIME))];case 1:return e=n.sent(),[4,this.storage.getItem(ef(eu.LAST_SERVER_PUSH_TIME))];case 2:return t=n.sent(),[2,{offlineTime:e,pushTime:t}]}})})},e}(),ep={storage:{},setItem:function(e,t){ep.storage[e]=t},getItem:function(e){return ep.storage[e]}};function ef(e){var t=eh.getExtensions&&eh.getExtensions().Suite&&eh.getExtensions().Suite.getToken,n=t&&t()||c;return n||(c||(c=w(new Date().valueOf())),n=c),e+"."+n}var ed=new el,eg=function(e){function t(){var t=e.call(this,"OverloadProtectionTriggered")||this;return t.code=-666666,t}return V(t,e),t}(Error),ey=function(){function e(t){var n=this;this.adapter=t,this.channel=o.http,this.state=s.online,this.config=K(K({},e.DEFAULT_IO_CONFIG),this.adapter.getStaticConfig()),this.webSocketOptions={protocols:"pbbp2",binaryType:"arraybuffer",connectTimeout:5e3},this.wsManagerOptions={endPoints:this.config.endPoints},this.pingPongOptions={message:"2",pingInterval:15e3,pongTimeout:45e3},this.logger=this.adapter.createIOLogger(this),this.stateMachine=new ec,this.reqId=1,this.requests={},this.hasListener=!1,this.events={},this._recvCount=0,this.socketSendTimeoutTimes=0,this.socketPushAcks={},this.routeType="token",this.handleOnline=function(){return z(n,void 0,void 0,function(){return J(this,function(e){switch(e.label){case 0:return this.logger.moiraeInfo("online"),this.stateMachine.browserOnline(),this.channel=o.http,this.state=s.online,this.fireEvent("online",this.channel),[4,this.connectSocket()];case 1:return e.sent(),[2]}})})},this.handleOffline=function(){n.logger.moiraeInfo("offline"),n.stateMachine.browserOffline(),n.closeSocket(),n.state=s.offline,n.channel=o.http,(0,l.Z)(n.requests,function(e){return e.reject(Error("network offline"))}),n.requests={},n.fireEvent("offline",n.channel),ed.setOfflineTime()},this.handleVisibilityChange=function(){n.logger.moiraeTeaLog({event:"visibility_change",new_state:document.visibilityState}),n.fireEvent("visibilitychange")},this.handleUnload=function(){n.events.unload&&n.events.unload(),n.frontierClient.destroy(),n.ticketManager.destroy(),n.stateMachine.destroy()},this.timeout=this.config.timeout,this.maxSize=this.config.maxSize,this.routeType=this.config.routeType,this.memberId=this.config.memberId||w(new Date().valueOf()),this.ticket=this.config.initialTicket||"",this.baseInfo={member_id:this.memberId,user_ticket:this.ticket},this.ticketManager=new ea({initTicket:this.config.initialTicket,loadTicketImpl:function(){return n.loadTicketImpl()},expireAfter:9e4}),this.ticketManager.ticket$.subscribe(function(e){return n.setBaseInfoTicket(e)}),this.frontierConfig=this.makeFrontierConfig(this.memberId),this.frontierClient=new es(this.ticketManager,this.webSocketOptions,this.wsManagerOptions,this.frontierConfig,this.pingPongOptions,this.logger),!1!==this.config.autoConnect&&this.connectSocket(!0),this.mount(),this.bindSocketEvent(),this.stateMachine.newState$.subscribe(function(e){var t=e[0],i=e[1];n.logger.moiraeInfo("state machine "+t+" -> "+i),n.logger.moiraeTeaLog({event:"state_machine",prevState:t,newState:i})}),this.logger.logIOInit&&this.logger.logIOInit(this.memberId)}return e.prototype.getTimeout=function(e){return e.timeout||this.timeout},e.prototype.makeFrontierConfig=function(e){var t=this.config,n=t.fpid,i=t.appKey,r=t.aid,o=t.businessType,s=t.serviceId;return{fpid:n,appKey:i,accessSalt:"f8a69f1719916z",noteToken:e,serviceId:void 0===s?2:s,query:{fpid:n,aid:r,business_type:o,tenant_id:t.tenantId,sdk_version:1,version_code:5806,version:2,device_id:e,xsack:1,device_platform:"web"}}},e.prototype.loadTicketImpl=function(){var e=this,t={url:"/api/pandora_ws/ws_ticket/",method:"post",noStore:!0,data:{business_type:this.config.businessType}};return this.adapter.sendMessageByAxios(t).catch(function(t){return e.logger.consoleWarn("fetch frontier token error",t)}).then(function(e){return(0,p.Z)(e,"data.ticket","")})},e.prototype.resetRecvCount=function(){this._recvCount^=this._recvCount},e.prototype.addRecvCount=function(){this._recvCount++,1<this._recvCount&&(this.state=s.online,this._recvCount^=this._recvCount)},e.prototype.intoWeakOnline=function(){this._recvCount^=this._recvCount,this.state=s.weakline},Object.defineProperty(e.prototype,"netState",{get:function(){return this.state},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this.reqId=1,this.requests={}},e.prototype.getMemberId=function(){return this.memberId},e.prototype.getTicket=function(){return this.ticket},e.prototype.connectSocket=function(e){var t=this;if(void 0===e&&(e=!1),this.state===s.online&&!this.config.disableSocket){this.closeSocket(),this.logger.moiraeTeaLog({event:"connect_start"});var n=Date.now(),i=this.frontierClient.connect();return i.then(function(){var i=Date.now()-n;t.logger.moiraeTeaLog({event:"connect_success",cost_time:i}),e&&t.fireEvent("firstConnectSuccess")}).catch(function(e){t.logger.moiraeTeaLog({event:"connect_error",msg:e.toString()})}),i}},e.prototype.request=function(e,t){var n,i,r,o,s,c,h,u,l,p=this;return void 0===t&&(t={}),eh.getExtensions()&&eh.getExtensions().FeatureGate&&eh.getExtensions().FeatureGate[a.REQUEST_MELTDOWN_AJAX_ENABLE]?(i=(n={interval:1e3,maxCount:100,onLimit:function(){p.logger.moiraeTeaLog({key:"request_meltdown"})}}).interval,r=n.maxCount,o=n.onLimit,s=!1,c=!1,h=0,u=0,l=function(){var e=Date.now();if(++h>=r){s=!0;return}if(0===u){u=e;return}if(!(e-u<i)){var t=Math.floor((e-u)/1e3*10);h>t?h-=t:h=0,u=e}},function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return s?("function"!=typeof o||c||(o(),c=!0),Promise.reject(new eg)):(l(),e.apply(void 0,t))}})(function(){return p.normalRequest(e,t)})():this.normalRequest(e,t)},e.prototype.normalRequest=function(e,t){if(void 0===t&&(t={}),this.state===s.offline){var n=Promise.reject(Error("offline"));return n.reqId=e.req_id||NaN,n}var i=this.adapter.generateRequestContext();e=K(K({},e),{version:e.version||2,data:K(K({},this.baseInfo),e.data),req_id:e.req_id||this.reqId++,context:i});var r=t.channel||this.channel,a=this.getHeaders(e,t,i);if(r===o.socket&&!function(e,t,n){n=n?n.toLowerCase():"";for(var i=0,r="utf-16"===n||"utf16"===n?C:S,o=0,s=e.length;o<s;o+=1)if((i+=r(e.charCodeAt(o)))>t)return!0;return!1}(JSON.stringify(e),this.maxSize)){var c=Object.assign(t,{headers:a});return this.requestBySocket(e,c)}if(t.channel&&t.channel!==o.socket)this.logger.moiraeInfo("not using socket as options.channel is "+t.channel);else if(r===o.socket&&(this.logger.moiraeInfo("not using socket as payload size is over "+this.maxSize),0===t.timeoutRetry)){var n=Promise.reject(Error("not using socket as payload size is over "+this.maxSize));return n.reqId=e.req_id||NaN,n}return this.requestByHttp(e,t)},e.prototype.getHeaders=function(e,t,n){void 0===t&&(t={});var i=this.adapter.getCommonHeader&&this.adapter.getCommonHeader();return K(K({req_id:String(e.req_id||this.reqId++),context:Object.keys(n).map(function(e){return e+"="+n[e]}).join(";"),user_agent:navigator.userAgent},t.headers||{}),i||{})},e.prototype.mount=function(){this.hasListener||(window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("unload",this.handleUnload),this.hasListener=!0)},e.prototype.unmount=function(e){void 0===e&&(e=!1),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),document.removeEventListener("visibilitychange",this.handleVisibilityChange),e&&(window.removeEventListener("unload",this.handleUnload),this.hasListener=!1)},e.prototype.setBaseInfoTicket=function(e){this.ticket=e,this.baseInfo.user_ticket=e},e.prototype.closeSocket=function(){this.frontierClient.reset()},e.prototype.bindSocketEvent=function(){var e=this;this.frontierClient.newActiveConnection$.subscribe(function(t){null===t?(e.logSocketError("lost active connection"),e.handleNoActiveConnection()):e.handleActiveConnection()}),this.frontierClient.close$.subscribe(function(){e.refreshIfNotOffline("closed")}),this.frontierClient.error$.subscribe(function(){e.refreshIfNotOffline("error")}),this.frontierClient.message$.subscribe(function(t){e.handleMessage(t)}),this.frontierClient.pongTimeout$.subscribe(function(){e.refreshIfNotOffline("pong timed out")})},e.prototype.refreshIfNotOffline=function(e){this.logSocketError(e),this.state!==s.offline&&this.frontierClient.refresh()},e.prototype.handleActiveConnection=function(){var e=this.channel,t=this.state;this.logger.moiraeInfo("socket enabled, prev channel: "+e+", prev state: "+t),this.logger.moiraeTeaLog({event:"socket_enabled",prevChannel:e,prevState:t}),this.channel=o.socket,this.state=s.online,this.socketSendTimeoutTimes=0,this.fireEvent("enabled",this.state,this.channel)},e.prototype.handleNoActiveConnection=function(){this.channel!==o.http&&(this.channel=o.http,this.state!==s.offline&&this.fireEvent("disabled",this.state,this.channel))},e.prototype.logSocketError=function(e){var t=this.channel,n=this.state;this.logger.moiraeInfo("socket error: "+e+", prev channel: "+t+", prev state: "+n),this.logger.moiraeTeaLog({event:"socket_error",type:e,prevChannel:t,prevState:n})},e.prototype.fireEvent=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];try{var i=this.events[e];i&&i.apply(void 0,t)}catch(e){this.logger.logException(e)}},e.prototype.requestByHttp=function(e,t){var n=this,i=e.data&&e.data.type||t.url,r=e.req_id,o=e.context&&e.context.request_id||r;this.logger.moiraeInfo("send req("+o+") "+i+" by http");try{10*Math.random()<1&&this.logger.moiraeTeaLog({key:"client_sheet_client_suit_request_http"})}catch(e){this.logger.logException(e)}var a=(t.headers||{}).path,c=t.host,l={url:t.url||(a?(void 0===c?"":c)+a:"/api/rce/messages"),method:"post",params:{member_id:this.memberId},data:e,timeout:this.getTimeout(t),headers:K(K({},u),t.headers),noStore:void 0===t.noStore||t.noStore},p=this.adapter.sendMessageByAxios(l).then(function(e){var t=e&&e.data;return t&&"ERROR"===t.type&&h.includes(t.code)&&n.logger.moiraeInfo("RESOLVE req("+o+") for error code "+t.code),n.state===s.weakline&&n.addRecvCount(),n.logger.moiraeInfo("req("+o+") "+i+" by http is resolved"),n.stateMachine.sendMessageSuccess(),e}).catch(function(r){if(n.state===s.weakline&&n.resetRecvCount(),n.stateMachine.is("POOR_CONNECTION")&&5*Math.random()<1){var a=JSON.stringify(n.stateMachine.getStats());n.logger.moiraeInfo("weak connection stats: "+a),n.logger.moiraeTeaLog({event:"http_failure_weakly_connected",stats:a})}n.stateMachine.sendMessageFailure();var c=r&&("-8"===r.code||"ECONNABORTED"===r.code);return t.timeoutRetry&&c&&n.state!==s.offline?(n.logger.moiraeInfo("RESEND req("+o+") by http for error "+T(r)),n.requestByHttp(e,K(K({},t),{timeoutRetry:Math.max(0,t.timeoutRetry-1)}))):(n.logger.moiraeInfo("req("+o+") "+i+" by http is rejected for error "+T(r)),n.logger.moiraeCount("ee.docs.doc.client_io_rejected"),Promise.reject(r))});return p.reqId=e.req_id,p},e.prototype.requestBySocket=function(e,t){var n=this,i=e.data&&e.data.type,r=e.req_id,o=e.context&&e.context.request_id||r,a=new Promise(function(a,c){n.requests[r]={payload:e,options:t,resolve:a,reject:c,resendByHttp:function(){n.logger.moiraeInfo("RESEND req("+o+") "+i+" by http"),n.requestByHttp(e,t).then(a,c),delete n.requests[r]}},n.logger.moiraeInfo("send req("+o+") "+i+" by socket"),n.frontierClient.send(e,t)?setTimeout(function(){if(n.requests[r]){if(0===n.requests[r].options.timeoutRetry)return void n.requests[r].reject(Error("req("+o+") "+i+" by socket timeout"));n.state===s.weakline&&n.resetRecvCount(),n.logger.moiraeInfo("req("+o+") "+i+" by socket timeout, #"+n.socketSendTimeoutTimes),n.socketSendTimeoutTimes+=1,2===n.socketSendTimeoutTimes&&n.refreshIfNotOffline("socket send timed out"),n.requests[r].resendByHttp()}},n.getTimeout(t),"socket timeout"):(n.logger.moiraeInfo("req("+o+") "+i+" by socket send failure"),n.requests[r].resendByHttp())});a.reqId=r;try{10*Math.random()<1&&this.logger.moiraeTeaLog({key:"client_sheet_client_suit_request_socket"})}catch(e){this.logger.logException(e)}return a},e.prototype.handleMessage=function(e){var t,n=this,i=e.payload,r=e.headers,o=void 0===r?[]:r,a=i.request_id,c=i.data,h=o.filter(function(e){return"req_id"===e.key})[0],u=o.filter(function(e){return"X-TT-LOGID"===e.key})[0];h&&(t=h.value),u&&(i.log_id=u.value);var l=i.req_id||t,p=c||{},f=p.code,d=p.type,g=p.over_size,y=this.requests;if(this.state===s.weakline&&this.addRecvCount(),5===f){this.logger.moiraeInfo("req("+a+") "+d+" by socket ticket expired"),this.logger.moiraeTeaLog({event:"ws_ticket_expired",requestType:d}),this.stateMachine.sendMessageFailure(),this.ticketManager.markTicketAsExpired(),this.ticketManager.loadTicket().then(function(e){if(null===e.ticket){n.logger.moiraeInfo("ABORT req("+a+") "+d+" due to failure to reload ticket"),l&&y[l]&&y[l].reject(Error("failed to reload ticket"));return}l&&y[l]&&(n.logger.moiraeInfo("RESEND req("+a+") "+d+" by http after reloading ticket"),y[l].resendByHttp())}),this.refreshIfNotOffline("ticket expired");return}if(l&&y[l]){if(this.stateMachine.sendMessageSuccess(),this.socketSendTimeoutTimes=0,1===g){this.logger.moiraeInfo("req("+a+") "+d+" by socket is oversize"),y[l].resendByHttp();return}this.logger.moiraeInfo("req("+a+") "+d+" by socket is resolved"),y[l].resolve(i),delete y[l];return}this.logger.moiraeInfo("message("+a+") "+d+" is received by socket"),this.logger.logOnPassiveMessageData(e),this.stateMachine.receivedBroadcastMessage(),this.fireEvent("broadcast",e)},e.prototype.getLogMessage=function(e){return"IO: memberId("+this.memberId+"): "+e},e.prototype.on=function(e,t){this.events[e]=t},e.prototype.isNewProtocol=function(){return!!this.config.businessType},e.prototype.getHost=function(){return this.config.host},e.DEFAULT_IO_CONFIG={timeout:15e3,maxSize:6e3,memberId:void 0,autoConnect:!0,initialTicket:void 0,host:"",routeType:"token",disableSocket:!1},e}(),ev=function(){function e(){this.callbacks=[],this.reset()}return e.prototype.reset=function(){this.callbacks=[]},e.prototype.triggerNotify=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.callbacks.forEach(function(t){t.apply(void 0,e)})},e.prototype.addListener=function(e){this.callbacks.push(e)},e.prototype.removeListener=function(e){this.callbacks.filter(function(t){return t!==e})},e}(),em=function(e){function t(n){var i=e.call(this,n)||this;return i.defaultInactiveInterval=3e5,i.heartbeatIntervalForInactive=i.defaultInactiveInterval,i.heartbeatIntervalMap={ONE_MIN:6e4,TWO_MIN:12e4,THREE_MIN:18e4,FOUR_MIN:24e4,FIVE_MIN:3e5},i.heartbeatIntervalForSocket=6e4,i.heartbeatIntervalForHttp=6e4,i.serverAndClientIntervalTime=void 0,i.scheduleHB=null,i.scheduleNewProtocolHB=null,i.hbErrorCount=0,i.hbSuccessCount=0,i.isHeartbeatRequestSending=!1,i.isNewHeartbeatRequestSending=!1,i.counter=0,i.newProtocolCounter=0,i.externalTabInactive=!1,i.isLatestHeartbeatFromIO=!1,i.isLatestNewHeartbeatFromIO=!1,i.watchEntitys=[],i.entities={},i.entityObservers=new Map,i.firstConnectSuccessHandle=function(){i.sendHeartbeats(void 0,void 0,{isFromIO:!0}),i.sendHeartbeats(void 0,void 0,{isNewHeartbeatsProtocol:!0,isFromIO:!0})},i.onlineStateHandle=function(e){i.schedule(!0),i.channelStateCallbacker.triggerNotify(i.netState,e)},i.offlineStateHandle=function(e){i.channelStateCallbacker.triggerNotify(i.netState,e)},i.enabledHandle=function(e,t){i.channelStateCallbacker.triggerNotify(e,t)},i.disabledHandle=function(e,t){i.channelStateCallbacker.triggerNotify(e,t)},i.broadcastHandle=function(e){var n=e.payload,r=e.headers,o={type:"",token:""};(void 0===r?[]:r).forEach(function(e){var t=e.key,n=e.value;"topic_type"===t?o.type=n:(t="topic_token",o.token=n)}),(0,l.Z)(i.entities,function(e){if(e){var r=e.messages,s=e.entity;(0,l.Z)(Object.values(r||{}),function(e){var i=e||{},r=i.handler,a=i.filter;t.keyOf(o)===t.keyOf(s)?r&&r(n):(!(0,f.Z)(a)&&(0,d.Z)(a)||(0,f.Z)(a)&&a(n)||(0,g.Z)(a)&&t.keyOf(a)===t.keyOf({type:n.type,token:(0,p.Z)(n,"data.token")}))&&r&&r(n)});var a=i.entityObservers.get(t.keyOf(e.entity));a&&a.forEach(function(e,t){try{e.messageHandler(n)}catch(e){i.logger.moiraeError("entityObserver handle message error: "+t,e)}})}})},i.visibilityChangeHandle=function(){"visible"===document.visibilityState&&i.schedule(!0)},i.scheduleFinallyCb=function(e){void 0===e&&(e=!1),i.logger.moiraeInfo("schedule next heartbeat, isNewHeartbeatsProtocol: "+e),e?i.scheduleNewProtocolHeartbeart():i.scheduleHeartbeart()},i.scheduleCatchCb=function(e,t){void 0===e&&(e=!1),i.hbErrorCount%3==0&&(i.logger.moiraeError({key:"client_suit_hearbeat_error",hbErrorCount:i.hbErrorCount}),i.logger.moiraeTeaLog({key:"client_sheet_client_suit_hearbeat_error"})),i.logger.moiraeError("heartbeat error: "+T(t)),i.logger.moiraeError("schedule next heartbeat"),e?i.scheduleNewProtocolHeartbeart():i.scheduleHeartbeart(),i.logger.consoleError("\b\u5FC3\u8DF3\u5F02\u5E38:",t.message,t)},i.externalEntityInfoMap=new Map,i.channelStateCallbacker=new ev,i.on("online",i.onlineStateHandle),i.on("offline",i.offlineStateHandle),i.on("enabled",i.enabledHandle),i.on("disabled",i.disabledHandle),i.on("broadcast",i.broadcastHandle),i.on("visibilitychange",i.visibilityChangeHandle),i.on("firstConnectSuccess",i.firstConnectSuccessHandle),i.schedule(),i}return V(t,e),t.prototype.setHeartbeatIntervalForSocket=function(e){this.heartbeatIntervalForSocket!==e&&(this.logger.moiraeInfo("set new heartbeat interval for socket: "+e),this.heartbeatIntervalForSocket=e)},t.prototype.setHeartbeatIntervalForHttp=function(e){this.heartbeatIntervalForHttp!==e&&(this.logger.moiraeInfo("set new heartbeat interval for http: "+e),this.heartbeatIntervalForHttp=e)},t.prototype.setServerAndClientIntervalTime=function(e,t){this.serverAndClientIntervalTime=t/2+e-Date.now()},t.prototype.getServerAndClientIntervalTime=function(){return this.serverAndClientIntervalTime},t.prototype.calcHeartbeatInterval=function(){return this.externalTabInactive?this.heartbeatIntervalForInactive:"hidden"===document.visibilityState?2*this.heartbeatIntervalForSocket:this.channel===o.socket?this.heartbeatIntervalForSocket:this.heartbeatIntervalForHttp},t.keyOf=function(e){return e.type+":"+e.token},t.isEntityEqual=function(e,n){return t.keyOf(e)===t.keyOf(n)},t.prototype.triggerHeartbeatStabilityChange=function(e){var n=this;(0,l.Z)(this.entities,function(i){if(i){try{i.heartbeatStabilityChangeHandler&&i.heartbeatStabilityChangeHandler(e)}catch(e){n.logger.consoleError("entity.heartbeatStabilityChangeHandler error",e),n.logger.moiraeError("entity.heartbeatStabilityChangeHandler error",T(e))}var r=n.entityObservers.get(t.keyOf(i.entity));r&&r.forEach(function(t,i){try{t.heartbeatStabilityChangeHandler&&t.heartbeatStabilityChangeHandler(e)}catch(e){n.logger.consoleError("entityObserver.heartbeatStabilityChangeHandler error",i,e),n.logger.moiraeError("entityObserver.heartbeatStabilityChangeHandler error",i,T(e))}})}})},t.prototype.reset=function(){this.counter=0,this.newProtocolCounter=0,e.prototype.reset.call(this),this.channelStateCallbacker.reset(),this.scheduleHB&&(this.logger.moiraeTeaLog({event:"schedule_HB_reset"}),clearTimeout(this.scheduleHB),this.scheduleHB=null),this.entities={},this.externalEntityInfoMap.clear()},t.prototype.registerChannelState=function(e){this.channelStateCallbacker.addListener(e)},t.prototype.unregisterChannelState=function(e){this.channelStateCallbacker.removeListener(e)},t.prototype.closeChannel=function(){this.logger.moiraeTeaLog({event:"schedule_HB_closeChannel"}),this.scheduleHB&&clearTimeout(this.scheduleHB),this.closeSocket(),this.unmount(!1)},t.prototype.switchHeartbeatInactive=function(e){if(this.externalTabInactive=!0,!e){this.heartbeatIntervalForInactive=this.defaultInactiveInterval;return}this.heartbeatIntervalForInactive=this.heartbeatIntervalMap[e]||this.defaultInactiveInterval},t.prototype.switchHeartbeatActive=function(){this.externalTabInactive=!1,this.heartbeatIntervalForInactive=this.defaultInactiveInterval},t.prototype.setEntityExternalInfo=function(e){var n=this;void 0===e&&(e=[]),e&&(e.forEach(function(e){var i=t.keyOf(e.entity);n.externalEntityInfoMap.set(i,e)}),this.schedule(!0))},t.prototype.sendHeartbeats=function(e,t,n){n&&n.isNewHeartbeatsProtocol?this.newProtocolCounter++:this.counter++,this.sendHeartbeatsInternal(e,t,n)},t.prototype.sendHeartbeatsInternal=function(e,n,i){var r,o=this;void 0===i&&(i={});var a=i.isNewHeartbeatsProtocol,c=void 0!==a&&a,h=i.isFromIO,u=void 0!==h&&h,p={isNewHeartbeatsProtocol:""+c,isFromIO:""+u},f=Object.values(this.entities).filter(function(e){return!!e.isNewHeartbeatsProtocol==!!c}),g=f.map(function(e){return e.entity.type}).join(";");if(f.length<=0){this.logger.moiraeTeaLog(K({event:"entities_empty"},p)),e&&e();return}var v=c?this.isNewHeartbeatRequestSending:this.isHeartbeatRequestSending,m=c?this.isLatestNewHeartbeatFromIO:this.isLatestHeartbeatFromIO;if(v){this.logger.moiraeTeaLog(K(K({event:"is_sending_heartbeat"},p),{entitiesTypes:g,isLatestFromIO:""+m})),u&&e&&e();return}this.setHeartbeatsSendingStatus(!0,c);var b=[],k=[],E=c?this.newProtocolCounter:this.counter;if((0,l.Z)(f,function(e){var n=t.keyOf(e.entity);if(o.watchEntitys.some(function(e){return n===t.keyOf(e)})){var i=K(K({},e.entity),{modules:[]}),r=function(e,t){E>=e.counter+e.interval&&(k.push(e),i.modules.push(t))};(0,l.Z)(e.heartbeats,r);var s=o.entityObservers.get(n);s&&s.forEach(function(e){(0,l.Z)(e.heartbeats,r)});var a=(e.heartbeats.engine_channel||{}).version;"number"==typeof a&&(i.revisions={engine_channel:a});var c=o.externalEntityInfoMap.get(n);c&&(i.inactive=c.inactive),b.push(i)}}),b.length<=0){this.logger.moiraeTeaLog(K(K({event:"channels_empty"},p),{entitiesTypes:g})),this.setHeartbeatsSendingStatus(!1,c),e&&e();return}window.__HEARTBEAT_STATUS__=!0;var I={timeoutRetry:3,noStore:!0,noErrorRetry:!0};c?(r={channels:b},I=K(K({},I),{headers:{path:"/api/rce/heartbeat"},host:this.getHost()})):r={type:"COLLABROOM",data:{type:"USER_HEARTBEAT",member_id:this.getMemberId(),user_ticket:this.getTicket(),channels:b},version:2},this.logger.moiraeTeaLog(K(K({event:"send_heartbeat_start"},p),{entitiesTypes:g})),this.setLatestHeartbeatIsFromIO(c,u);var O=Date.now();this.request(r,I).then(function(n){var i=n.data.server_time;i&&(O=Date.now()-O,ed.setHeartbeatTime(i),o.setServerAndClientIntervalTime(i,O)),window.__HEARTBEAT_STATUS__=!1,o.setHeartbeatsSendingStatus(!1,c);try{o.netState===s.offline&&(o.logger.moiraeInfo("client_suit_hearbeat_resume"),o.logger.moiraeCount("ee.docs.sheet.client_suit_hearbeat_resume"),o.logger.moiraeTeaLog({key:"client_sheet_client_suit_hearbeat_resume"}));var r=Number(n.data.interval);if(r&&o.setHeartbeatIntervalForSocket(1e3*r),(0,y.Z)(n.data,"interval_http")){var a=Number(n.data.interval_http);a&&o.setHeartbeatIntervalForHttp(1e3*a)}else r&&o.setHeartbeatIntervalForHttp(1e3*r);var h=n.data.channel_info;(0,l.Z)(k,function(e){e.counter=E}),(0,l.Z)(h,function(e){var n=t.keyOf(e),i=o.entities[n];(0,d.Z)(i)||(0,l.Z)(e.modules,function(e){var t=e.name,r=parseInt(e.version,10),s=i.heartbeats[t],a=e.extra;(0,d.Z)(s)||o.checkHeartbeat(r,s,i,a);var c=o.entityObservers.get(n);c&&c.forEach(function(e){try{var n=e.heartbeats[t];n&&o.checkHeartbeat(r,n,i)}catch(e){o.logger.moiraeTeaLog({event:"entityObservers handle heartbeat failed",heartbeatModuleName:t,heartbeatVerson:r})}})})})}catch(e){o.logger.moiraeInfo("heartbeat set interval_http time error, error: "+e)}o.logger.moiraeInfo("heartbeat finallyCb, isNewHeartbeatsProtocol: "+c+", isFromIO: "+u),o.logger.moiraeTeaLog(K(K({event:"send_heartbeat_end"},p),{entitiesTypes:g})),o.hbErrorCount=0,o.hbSuccessCount+=1,2===o.hbSuccessCount&&o.triggerHeartbeatStabilityChange(!0),e&&e()}).catch(function(e){window.__HEARTBEAT_STATUS__=!1,o.setHeartbeatsSendingStatus(!1,c),o.hbErrorCount+=1,o.hbSuccessCount=0,2===o.hbErrorCount&&(o.intoWeakOnline(),o.channelStateCallbacker.triggerNotify(o.netState,o.channel),o.triggerHeartbeatStabilityChange(!1)),n&&n(e)})},t.prototype.setHeartbeatsSendingStatus=function(e,t){t?this.isNewHeartbeatRequestSending=e:this.isHeartbeatRequestSending=e},t.prototype.setLatestHeartbeatIsFromIO=function(e,t){e?this.isLatestNewHeartbeatFromIO=t:this.isLatestHeartbeatFromIO=t},t.prototype.watchEntities=function(e,n,i){var r,o=this;void 0===n&&(n=0),void 0===i&&(i={});var s=i.isNewProtocol,a=void 0!==s&&s,c=e.reduce(function(e,t){return t&&t.token&&e.push(K({route_key:t.token,route_type:o.routeType},t)),e},[]);if(!c.length)return Promise.resolve();var h={};a?(r={member_id:String(this.getMemberId()),entities:c},h={headers:{path:"/api/room/watch"},host:this.getHost()}):r={type:"COLLABROOM",data:{type:"WATCH",entities:c}};var u=e.map(function(e){return e.type}).join(";");return this.logger.moiraeTeaLog({event:"send_watch",isNewProtocol:a,entitiesTypes:u}),this.request(r,h).then(function(e){var r=(0,p.Z)(e,"data.entities")||[],s=[];if(c.forEach(function(n){var i=t.keyOf(n),c=r.find(function(e){return i===t.keyOf(e)});if(!c||(a?0!==c.code:1!==c.succ)){o.logger.logWatchEntityFailure(n),s.push(K({},n));return}var h=o.entities[i];h&&h.acceptWatchHandler&&h.acceptWatchHandler(e)}),0!==s.length){if(n>=3)throw Error("failed to watch entities");return o.watchEntities(s,n+1,i)}})},t.prototype.unWatchEnities=function(e,n){var i,r=this,o=!!n&&!!n.isNewProtocol,s=e.map(function(e){var n=t.keyOf(e);return r.logger.consoleWarn("delete entities key:",{key:n}),r.watchEntitys=r.watchEntitys.filter(function(e){return n!==t.keyOf(e)}),K({resource_type:"",route_key:e.token,route_type:r.routeType},e)}),a={};o?(i={member_id:String(this.getMemberId()),entities:s},a={headers:{path:"/api/room/unwatch"},host:this.getHost()}):i={type:"COLLABROOM",data:{type:"UNWATCH",entities:s}};var c=e.map(function(e){return e.type}).join(";");return this.logger.moiraeTeaLog({event:"send_unwatch",isNewProtocol:o,entitiesTypes:c}),this.request(i,a).then(function(n){var i=(0,p.Z)(n,"data.code");if(o?0!==n.code:0!==i)throw Error("unwatch entities failed! "+{ens:e.map(function(e){return t.keyOf(e)}).join(" ")});return n})},t.prototype.schedule=function(e){void 0===e&&(e=!1),this.scheduleHeartbeart(e),this.scheduleNewProtocolHeartbeart(e)},t.prototype.scheduleHeartbeart=function(e){var t=this;void 0===e&&(e=!1),this.scheduleHB&&clearTimeout(this.scheduleHB);var n=e?0:this.calcHeartbeatInterval();this.scheduleHB=window.setTimeout(function(){if(t.netState===s.offline)return void t.scheduleHeartbeart();t.counter++,t.logger.moiraeInfo("send heartbeat, interval: "+n),t.sendHeartbeatsInternal(t.scheduleFinallyCb.bind(null,!1),t.scheduleCatchCb.bind(null,!1),{isNewHeartbeatsProtocol:!1,isFromIO:!0})},n)},t.prototype.scheduleNewProtocolHeartbeart=function(e){var t=this;void 0===e&&(e=!1),this.scheduleNewProtocolHB&&clearTimeout(this.scheduleNewProtocolHB);var n=e?0:this.calcHeartbeatInterval();this.scheduleNewProtocolHB=window.setTimeout(function(){if(t.netState===s.offline)return void t.scheduleNewProtocolHeartbeart();t.newProtocolCounter++,t.logger.moiraeInfo("send new protocol heartbeat, interval: "+n),t.sendHeartbeatsInternal(t.scheduleFinallyCb.bind(null,!0),t.scheduleCatchCb.bind(null,!0),{isNewHeartbeatsProtocol:!0,isFromIO:!0})},n)},t.prototype.checkHeartbeat=function(e,t,n,i){var r=t.version,o=t.callback;!(e<r)&&(t.version=e,o&&o(e,r,n,i))},t}(ey),eb=function(e){function t(t){var n=e.call(this,t)||this;return t.getExternalExtensions&&eh.init(t.getExternalExtensions()),n.unloadHandle=n.unloadHandle.bind(n),n.on("unload",n.unloadHandle),n}return V(t,e),t.initHeartbeat=function(e){return K({interval:1,version:0,counter:0},e)},t.beats=function(e){return(0,v.Z)(e,function(e,n,i){return e[i]=t.initHeartbeat(n),e},{})},t.prototype.unloadHandle=function(){var e=(0,m.Z)(this.entities).map(function(e){return e.entity});this.unRegister(e)},t.prototype.registerEntityObserver=function(e,n){var i=em.keyOf(e),r=(0,b.Z)(),o=this.entityObservers.get(i),s={heartbeats:t.beats(n.heartbeats),messageHandler:n.messageHandler,acceptWatchHandler:n.acceptWatchHandler,heartbeatStabilityChangeHandler:n.heartbeatStabilityChangeHandler};if(o)o.set(r,s);else{var a=new Map;a.set(r,s),this.entityObservers.set(i,a)}return r},t.prototype.updateEntityObserver=function(e,n,i){var r=em.keyOf(e),o=this.entityObservers.get(r);if(!o)throw Error("no observers found: "+{key:r});var s=o.get(n);if(!s)throw Error("no observer found: "+{key:r}+" "+n);var a=i.heartbeats,c=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&0>t.indexOf(i)&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)0>t.indexOf(i[r])&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n}(i,["heartbeats"]),h=s.heartbeats;a&&(0,l.Z)(a,function(e,n){h[n]=t.initHeartbeat(e)}),o.set(n,K(K(K({},s),c),{heartbeats:h}))},t.prototype.unregisterEntityObserver=function(e,t){var n=em.keyOf(e),i=this.entityObservers.get(n);i&&i.delete(t)},t.prototype.register=function(e,n){var i,r=em.keyOf(e);this.entities[r]={entity:e,messages:((i={}).DEFAULT_MESSAGE=n.message,i),heartbeats:t.beats(n.heartbeats),isNewHeartbeatsProtocol:n.isNewHeartbeatsProtocol,acceptWatchHandler:n.acceptWatchHandler,heartbeatStabilityChangeHandler:n.heartbeatStabilityChangeHandler},this.mount(),this.logger.moiraeTeaLog({event:"register_entity",isNewHeartbeatsProtocol:n.isNewHeartbeatsProtocol,entityType:e.type})},t.prototype.unRegister=function(e){var t=this;e=(0,k.Z)(e)?e:[e];var n=[],i=[];e.forEach(function(e){var r=em.keyOf(e),o=t.watchEntitys.some(function(e){return r===em.keyOf(e)&&e.isNewProtocol});delete t.entities[r],t.externalEntityInfoMap.delete(r),o?i.push(e):n.push(e)});var r=[];if(n.length>0){var o=this.unWatchEnities(n,{isNewProtocol:!1});r.push(o)}if(i.length>0){var o=this.unWatchEnities(i,{isNewProtocol:!0});r.push(o)}return this.watchEntitys.length||this.unmount(!0),this.logger.moiraeTeaLog({event:"unregister_entity",hasNewProtocol:i.length>0,entitiesTypes:e.map(function(e){return e.type}).join(";")}),Promise.all(r)},t.prototype.watch=function(e,t){var n=Object.assign({isNewProtocol:!!t&&t.isNewProtocol},e);return this.watchEntitys.push(n),this.watchEntities([e],0,t)},t.prototype.watches=function(e,t){var n=e.map(function(e){return Object.assign({isNewProtocol:!!t&&t.isNewProtocol},e)});return this.watchEntitys=this.watchEntitys.concat(n),this.watchEntities(e,0,t)},t.prototype.unWatch=function(e,t){return this.unWatchEnities([e],t)},t.prototype.unWatches=function(e,t){return this.unWatchEnities(e,t)},t.prototype.addHeartbeat=function(e,n,i){var r=em.keyOf(e),o=this.entities[r];if(!o)return void this.logger.consoleWarn("fail to add heartbeat because entity is not registered: ",{key:r});o.heartbeats[n]=t.initHeartbeat(i)},t.prototype.removeHeartbeat=function(e,t){var n=em.keyOf(e),i=this.entities[n];if(!i)return void this.logger.consoleWarn("fail to remove heartbeat because entity is not registered: ",{key:n});delete i.heartbeats[t]},t.prototype.setHeartbeatVersion=function(e,t,n){var i=this,r=em.keyOf(e),o=this.entities[r],s=o&&o.heartbeats&&o.heartbeats[t];s&&(s.version=n);var a=this.entityObservers.get(r);a&&a.forEach(function(e){try{var r=e.heartbeats[t];r&&(r.version=n)}catch(e){i.logger.consoleError("entityObservers handle heartbeat failed",t,n,e),i.logger.moiraeError("entityObservers handle heartbeat failed",t,n,T(e))}})},t.prototype.getHeartbeatInfo=function(e,t){var n=em.keyOf({type:e,token:t}),i=this.entities[n];return i&&i.heartbeats?K({},i.heartbeats):null},t.prototype.removeMessage=function(e,t){var n=em.keyOf(e),i=this.entities[n];if(!i)return void this.logger.consoleWarn("fail to remove heartbeat because entity is not registered: ",{key:n});delete i.messages[t]},t.prototype.addMessage=function(e,t,n){var i=em.keyOf(e),r=this.entities[i];if(!r)return void this.logger.consoleWarn("fail to add message because entity is not registered: ",{key:i});r.messages[t]=n},t.prototype.isEntityRegistered=function(e){var t=em.keyOf(e);if(!this.entities[t])return!1;var n=this.entities[t],i=n.messages,r=n.heartbeats;return!!Object.keys(i||{}).length||!!Object.keys(r||{}).length},t.prototype.getChannelState=function(){return this.channel},t}(em)},609761:function(e,t,n){"use strict";var i,r,o,s,a;n.d(t,{c:()=>i}),(s=i||(i={})).http="http",s.socket="socket",(a=r||(r={})).online="online",a.offline="offline",a.weakline="weakline",(o||(o={})).REQUEST_MELTDOWN_AJAX_ENABLE="request_meltdown_ajax_enable"},816310:function(e,t,n){"use strict";n.d(t,{IO:()=>ex});var i,r,o,s,a,c,h,u,l,p,f=n(71642),d=n(504957),g=n(34602),y=n(715822),v=n(340600),m=function(e,t){return(m=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function b(e,t){function n(){this.constructor=e}m(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var k=function(){return(k=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function E(e,t,n,i){return new(n||(n=Promise))(function(r,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((i=i.apply(e,t||[])).next())})}function I(e,t){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){var c=[o,a];if(n)throw TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&c[0]?i.return:c[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,c[1])).done)return r;switch(i=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,i=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===c[0]||2===c[0])){s=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){s.label=c[1];break}if(6===c[0]&&s.label<r[1]){s.label=r[1],r=c;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(c);break}r[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],i=0}finally{n=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(i=a||(a={})).PB="pb",i.JSON="json";var O="upstream_encoding";function _(e){return"pb"===e?a.PB:a.JSON}var w=function(){function e(){this.destroy$=new f.x}return e.prototype.takeUntil=function(){return(0,v.R)(this.destroy$)},e.prototype.from=function(e){return(0,d.D)(e).pipe(this.takeUntil())},e.prototype.toPromise=function(e){var t=this;return new Promise(function(n,i){var r,o=!1;t.from(e).subscribe(function(e){o=!0,r=e},i,function(){o&&n(r)})})},e.prototype.destroy=function(){this.destroy$.next(),this.destroy$.complete()},e}(),T=n(488882),C=n.n(T),S=n(258028),N=n(730413),P=n(721270),H=n(52e4),x=n(207587),A=n(203820),R=n(159574),M=n(754054),L=n(211790),F=n(23898),q=n(461550),D=n(102301),$=n(740521),B="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function U(e){var t=function(e){void 0===e&&(e=20);for(var t="",n=0;n<e;n++){var i=Math.floor(Math.random()*B.length);t+=B[i]}return t}(32),n=C()(e+t);return Number((parseInt(n=Math.floor(6*Math.random())+1+(n=n.slice(8,24)).slice(1),16)+"").slice(0,14))}function j(e){try{var t=new WeakSet;return JSON.stringify(e,function(e,n){var i;return(i=typeof n,null==n||"object"!==i&&"function"!==i)?n:t.has(n)?"[Circular]":(t.add(n),n instanceof Error)?String(n.message):n})}catch(t){return String(e)}}function W(e){return e<=65535?2:4}function G(e){return e<=127?1:e<=2047?2:e<=65535?3:4}var Z=[1015,9998];(r=c||(c={})).http="http",r.socket="socket",(o=h||(h={})).online="online",o.offline="offline",o.weakline="weakline";var V={"x-command":"api.rce.pandora"};(u||(u={})).REQUEST_MELTDOWN_AJAX_ENABLE="request_meltdown_ajax_enable";var K=n(686090),z=n(839711),J=n(192243),X=function(){function e(e){this.options=e,this.rxOp=new w,this.ticket=this.options.initTicket,this.ticket$=new f.x,this.ticketExpireAt=this.getInitialTicketExpireAt(),this.loadTicketPromise=null}return e.prototype.getInitialTicketExpireAt=function(){return this.options.initTicket?Date.now()+this.options.expireAfter:0},e.prototype.loadTicket=function(){return null==this.ticket||this.isTicketExpired()?(this.ticket=null,null===this.loadTicketPromise&&(this.loadTicketPromise=this.loadTicketAndSave()),this.loadTicketPromise):Promise.resolve({ticket:this.ticket,isFromCache:!0})},e.prototype.markTicketAsExpired=function(){this.ticketExpireAt=Date.now()},e.prototype.loadTicketAndSave=function(){return E(this,void 0,void 0,function(){var e;return I(this,function(t){switch(t.label){case 0:return[4,this.rxOp.toPromise(this.randomSleepFor(1e4))];case 1:t.sent(),e=null,t.label=2;case 2:return t.trys.push([2,4,,5]),[4,this.rxOp.toPromise(this.options.loadTicketImpl())];case 3:return e=t.sent(),[3,5];case 4:return t.sent(),[3,5];case 5:return e?(this.ticket=e,this.updateTicketExpireAt(),this.ticket$.next(e)):e=null,this.loadTicketPromise=null,[2,{ticket:e,isFromCache:!1}]}})})},e.prototype.isTicketExpired=function(){return Date.now()>=this.ticketExpireAt},e.prototype.updateTicketExpireAt=function(){this.ticketExpireAt=Date.now()+this.options.expireAfter},e.prototype.randomSleepFor=function(e){return(0,K.H)(Math.floor(Math.random()*e))},e.prototype.destroy=function(){this.rxOp.destroy(),this.ticket$.complete(),this.loadTicketPromise=null},e}(),Q=function(){function e(){this.rxOp=new w,this.state$=new z.X("ONLINE"),this.newState$=this.state$.pipe((0,J.G)(),this.rxOp.takeUntil()),this.sendSuccessTimes=0,this.sendFailureTimes=0,this.receiveTimes=0}return Object.defineProperty(e.prototype,"state",{get:function(){return this.state$.getValue()},enumerable:!0,configurable:!0}),e.prototype.getState=function(){return this.state},e.prototype.is=function(e){return this.state===e},e.prototype.getStats=function(){return{sendSuccessTimes:this.sendSuccessTimes,sendFailureTimes:this.sendFailureTimes,receiveTimes:this.receiveTimes}},e.prototype.browserOnline=function(){this.sendFailureTimes=0,this.receiveTimes=0,this.state$.next("ONLINE")},e.prototype.browserOffline=function(){this.state$.next("OFFLINE")},e.prototype.sendMessageSuccess=function(){switch(this.state){case"ONLINE":this.sendSuccessTimes+=1,this.state$.next("GOOD_CONNECTION");return;case"POOR_CONNECTION":0===this.sendFailureTimes?(this.sendSuccessTimes+=1,this.state$.next("GOOD_CONNECTION")):(this.sendSuccessTimes+=1,this.sendFailureTimes=0);return;case"GOOD_CONNECTION":this.sendSuccessTimes+=1;return;case"OFFLINE":return}},e.prototype.intoPoorConnection=function(){this.sendSuccessTimes=0,this.sendFailureTimes=0,this.receiveTimes=0,this.state$.next("POOR_CONNECTION")},e.prototype.sendMessageFailure=function(){switch(this.state){case"ONLINE":this.intoPoorConnection();return;case"POOR_CONNECTION":this.sendFailureTimes+=1;return;case"GOOD_CONNECTION":0===this.sendFailureTimes?this.sendFailureTimes+=1:this.intoPoorConnection();return;case"OFFLINE":return}},e.prototype.receivedBroadcastMessage=function(){switch(this.state){case"ONLINE":case"POOR_CONNECTION":case"GOOD_CONNECTION":this.receiveTimes+=1;return;case"OFFLINE":return}},e.prototype.destroy=function(){this.state$.complete(),this.rxOp.destroy()},e}(),Y=new(function(){function e(){this.extensions={}}return e.prototype.setExtension=function(e,t){this.extensions[e]=t},e.prototype.removeExtension=function(e){delete this.extensions[e]},e.prototype.getExtension=function(e){return this.extensions[e]},e.prototype.getExtensions=function(){return this.extensions},e.prototype.init=function(e){var t=this;void 0===e&&(e={}),(0,N.Z)(e,function(e,n){return t.setExtension(n,e)})},e}()),ee={HEARTBEAT_SERVER_TIME:"hearbeat_server_time",HEARTBEAT_CLIENT_TIME:"hearbeat_client_time",LAST_SERVER_PUSH_TIME:"last_server_push_time",LAST_CLIENT_OFFLINE_TIME:"last_client_offline_time"},et=function(){function e(){this.storage=Y.getExtensions()&&Y.getExtensions().Storage||en}return e.prototype.setHeartbeatTime=function(e){var t=Date.now();this.storage.setItem(ei(ee.HEARTBEAT_SERVER_TIME),e),this.storage.setItem(ei(ee.HEARTBEAT_CLIENT_TIME),t)},e.prototype.setSocketPushTime=function(e){this.storage.setItem(ei(ee.LAST_SERVER_PUSH_TIME),e)},e.prototype.setOfflineTime=function(){return E(this,void 0,void 0,function(){var e,t,n,i;return I(this,function(r){switch(r.label){case 0:return[4,this.storage.getItem(ei(ee.HEARTBEAT_SERVER_TIME))];case 1:return e=r.sent(),[4,this.storage.getItem(ei(ee.HEARTBEAT_CLIENT_TIME))];case 2:return t=r.sent(),n=Date.now(),i=+e+(n-t),this.storage.setItem(ei(ee.LAST_CLIENT_OFFLINE_TIME),i),[2]}})})},e.prototype.getOfflineTime=function(){return E(this,void 0,void 0,function(){var e,t;return I(this,function(n){switch(n.label){case 0:return[4,this.storage.getItem(ei(ee.LAST_CLIENT_OFFLINE_TIME))];case 1:return e=n.sent(),[4,this.storage.getItem(ei(ee.LAST_SERVER_PUSH_TIME))];case 2:return t=n.sent(),[2,{offlineTime:e,pushTime:t}]}})})},e}(),en={storage:{},setItem:function(e,t){en.storage[e]=t},getItem:function(e){return en.storage[e]}};function ei(e){var t=Y.getExtensions&&Y.getExtensions().Suite&&Y.getExtensions().Suite.getToken,n=t&&t()||l;return n||(l||(l=U(new Date().valueOf())),n=l),e+"."+n}var er=new et,eo=function(e){function t(){var t=e.call(this,"OverloadProtectionTriggered")||this;return t.code=-666666,t}return b(t,e),t}(Error),es=function(){function e(t){var n=this;this.adapter=t,this.channel=c.http,this.state=h.online,this.config=k(k({},e.DEFAULT_IO_CONFIG),this.adapter.getStaticConfig()),this.webSocketOptions={protocols:"pbbp2",binaryType:"arraybuffer",connectTimeout:5e3},this.wsManagerOptions={endPoints:this.config.endPoints},this.pingPongOptions={message:"2",pingInterval:15e3,pongTimeout:45e3},this.logger=this.adapter.createIOLogger(this),this.stateMachine=new Q,this.reqId=1,this.requests={},this.hasListener=!1,this.events={},this._recvCount=0,this.socketSendTimeoutTimes=0,this.socketPushAcks={},this.routeType="token",this.frontierClientStatus="init",this.frontierClientResolves=[],this.handleOnline=function(){return E(n,void 0,void 0,function(){return I(this,function(e){switch(e.label){case 0:return this.logger.moiraeInfo("online"),this.stateMachine.browserOnline(),this.channel=c.http,this.state=h.online,this.fireEvent("online",this.channel),[4,this.connectSocket()];case 1:return e.sent(),[2]}})})},this.handleOffline=function(){n.logger.moiraeInfo("offline"),n.stateMachine.browserOffline(),n.closeSocket(),n.state=h.offline,n.channel=c.http,(0,N.Z)(n.requests,function(e){return e.reject(Error("network offline"))}),n.requests={},n.fireEvent("offline",n.channel),er.setOfflineTime()},this.handleVisibilityChange=function(){n.fireEvent("visibilitychange")},this.handleUnload=function(){n.events.unload&&n.events.unload(),n.frontierClient&&n.frontierClient.destroy(),n.ticketManager.destroy(),n.stateMachine.destroy()},this.timeout=this.config.timeout,this.maxSize=this.config.maxSize,this.routeType=this.config.routeType,this.memberId=this.config.memberId||U(new Date().valueOf()),this.ticket=this.config.initialTicket||"",this.baseInfo={member_id:this.memberId,user_ticket:this.ticket},this.ticketManager=new X({initTicket:this.config.initialTicket,loadTicketImpl:function(){return n.loadTicketImpl()},expireAfter:9e4}),this.ticketManager.ticket$.subscribe(function(e){return n.setBaseInfoTicket(e)}),!1!==this.config.autoConnect&&this.connectSocket(!0),this.mount(),this.stateMachine.newState$.subscribe(function(e){var t=e[0],i=e[1];n.logger.moiraeTeaLog({event:"state_machine",prevState:t,newState:i})}),this.logger.logIOInit&&this.logger.logIOInit(this.memberId)}return e.prototype.getTimeout=function(e){return e.timeout||this.timeout},e.prototype.loadFrontierClient=function(){return E(this,void 0,void 0,function(){return I(this,function(e){return[2,new Promise(function(e,t){t("need FrontierClient.")})]})})},e.prototype.setupFrontierClient=function(){return E(this,void 0,void 0,function(){var e,t,n;return I(this,function(i){switch(i.label){case 0:return this.frontierClientStatus="loading",[4,this.loadFrontierClient()];case 1:return e=i.sent(),t=this.makeFrontierConfig(this.memberId),this.frontierClient=new e(this.ticketManager,this.webSocketOptions,this.wsManagerOptions,t,this.pingPongOptions,this.logger),this.bindSocketEvent(this.frontierClient),this.frontierClientStatus="done",this.frontierClientResolves.length&&(n=this.frontierClientResolves,this.frontierClientResolves=[],n.forEach(function(e){return e()})),[2]}})})},e.prototype.ensureFrontierClient=function(){return E(this,void 0,void 0,function(){var e=this;return I(this,function(t){switch(t.label){case 0:if("init"!==this.frontierClientStatus)return[3,2];return[4,this.setupFrontierClient()];case 1:return t.sent(),[3,4];case 2:if("loading"!==this.frontierClientStatus)return[3,4];return[4,new Promise(function(t){e.frontierClientResolves.push(t)})];case 3:t.sent(),t.label=4;case 4:return[2,this.frontierClient]}})})},e.prototype.makeFrontierConfig=function(e){var t=this.config,n=t.fpid,i=t.appKey,r=t.aid,o=t.businessType,s=t.serviceId;return{fpid:n,appKey:i,accessSalt:"f8a69f1719916z",noteToken:e,serviceId:void 0===s?2:s,query:{fpid:n,aid:r,business_type:o,tenant_id:t.tenantId,sdk_version:1,version_code:5806,version:2,device_id:e,xsack:1,device_platform:"web"}}},e.prototype.loadTicketImpl=function(){var e=this,t={url:"/api/pandora_ws/ws_ticket/",method:"post",noStore:!0,data:{business_type:this.config.businessType}};return this.adapter.sendMessageByAxios(t).catch(function(t){return e.logger.consoleWarn("fetch frontier token error",t)}).then(function(e){return(0,P.Z)(e,"data.ticket","")})},e.prototype.resetRecvCount=function(){this._recvCount^=this._recvCount},e.prototype.addRecvCount=function(){this._recvCount++,1<this._recvCount&&(this.state=h.online,this._recvCount^=this._recvCount)},e.prototype.intoWeakOnline=function(){this._recvCount^=this._recvCount,this.state=h.weakline},Object.defineProperty(e.prototype,"netState",{get:function(){return this.state},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this.reqId=1,this.requests={}},e.prototype.getMemberId=function(){return this.memberId},e.prototype.getTicket=function(){return this.ticket},e.prototype.connectSocket=function(e){var t=this;if(void 0===e&&(e=!1),this.state===h.online&&!this.config.disableSocket)return this._connectSocket(e).catch(function(e){t.logger.moiraeTeaLog({event:"connect_error",msg:e.toString()})})},e.prototype._connectSocket=function(e){return void 0===e&&(e=!1),E(this,void 0,void 0,function(){var t,n,i;return I(this,function(r){switch(r.label){case 0:return[4,this.ensureFrontierClient()];case 1:return t=r.sent(),this.closeSocket(),this.logger.moiraeTeaLog({event:"connect_start"}),n=Date.now(),[4,t.connect()];case 2:return i=r.sent(),this.logger.moiraeTeaLog({event:"connect_success",cost_time:Date.now()-n}),e&&this.fireEvent("firstConnectSuccess"),[2,i]}})})},e.prototype.request=function(e,t){var n,i,r,o,s,a,c,h,l,p=this;return void 0===t&&(t={}),Y.getExtensions()&&Y.getExtensions().FeatureGate&&Y.getExtensions().FeatureGate[u.REQUEST_MELTDOWN_AJAX_ENABLE]?(i=(n={interval:1e3,maxCount:100,onLimit:function(){p.logger.moiraeTeaLog({key:"request_meltdown"})}}).interval,r=n.maxCount,o=n.onLimit,s=!1,a=!1,c=0,h=0,l=function(){var e=Date.now();if(++c>=r){s=!0;return}if(0===h){h=e;return}if(!(e-h<i)){var t=Math.floor((e-h)/1e3*10);c>t?c-=t:c=0,h=e}},function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return s?("function"!=typeof o||a||(o(),a=!0),Promise.reject(new eo)):(l(),e.apply(void 0,t))}})(function(){return p.normalRequest(e,t)})():this.normalRequest(e,t)},e.prototype.normalRequest=function(e,t){if(void 0===t&&(t={}),this.state===h.offline){var n=Promise.reject(Error("offline"));return n.reqId=e.req_id||NaN,n}var i=this.adapter.generateRequestContext();e=k(k({},e),{version:e.version||2,data:k(k({},this.baseInfo),e.data),req_id:e.req_id||this.reqId++,context:i});var r=t.channel||this.channel,o=this.getHeaders(e,t,i);if(r===c.socket&&!function(e,t,n){n=n?n.toLowerCase():"";for(var i=0,r="utf-16"===n||"utf16"===n?W:G,o=0,s=e.length;o<s;o+=1)if((i+=r(e.charCodeAt(o)))>t)return!0;return!1}(JSON.stringify(e),this.maxSize)){var s=Object.assign(t,{headers:o});return this.requestBySocket(e,s)}if(t.channel&&t.channel!==c.socket)this.logger.moiraeInfo("not using socket as options.channel is "+t.channel);else if(r===c.socket&&(this.logger.moiraeInfo("not using socket as payload size is over "+this.maxSize),0===t.timeoutRetry)){var n=Promise.reject(Error("not using socket as payload size is over "+this.maxSize));return n.reqId=e.req_id||NaN,n}return this.requestByHttp(e,t)},e.prototype.getHeaders=function(e,t,n){void 0===t&&(t={});var i=this.adapter.getCommonHeader&&this.adapter.getCommonHeader();return k(k({req_id:String(e.req_id||this.reqId++),context:Object.keys(n).map(function(e){return e+"="+n[e]}).join(";"),user_agent:navigator.userAgent},t.headers||{}),i||{})},e.prototype.mount=function(){this.hasListener||(window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),document.addEventListener("visibilitychange",this.handleVisibilityChange),window.addEventListener("unload",this.handleUnload),this.hasListener=!0)},e.prototype.unmount=function(e){void 0===e&&(e=!1),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),document.removeEventListener("visibilitychange",this.handleVisibilityChange),e&&(window.removeEventListener("unload",this.handleUnload),this.hasListener=!1)},e.prototype.setBaseInfoTicket=function(e){this.ticket=e,this.baseInfo.user_ticket=e},e.prototype.closeSocket=function(){this.frontierClient&&this.frontierClient.reset()},e.prototype.bindSocketEvent=function(e){var t=this;e.newActiveConnection$.subscribe(function(e){null===e?(t.logSocketError("lost active connection"),t.handleNoActiveConnection()):t.handleActiveConnection()}),e.close$.subscribe(function(){t.refreshIfNotOffline("closed")}),e.error$.subscribe(function(){t.refreshIfNotOffline("error")}),e.message$.subscribe(function(e){t.handleMessage(e)}),e.pongTimeout$.subscribe(function(){t.refreshIfNotOffline("pong timed out")})},e.prototype.refreshIfNotOffline=function(e){this.logSocketError(e),this.state!==h.offline&&this.frontierClient&&this.frontierClient.refresh()},e.prototype.handleActiveConnection=function(){var e=this.channel,t=this.state;this.logger.moiraeTeaLog({event:"socket_enabled",prevChannel:e,prevState:t}),this.channel=c.socket,this.state=h.online,this.socketSendTimeoutTimes=0,this.fireEvent("enabled",this.state,this.channel)},e.prototype.handleNoActiveConnection=function(){this.channel!==c.http&&(this.channel=c.http,this.state!==h.offline&&this.fireEvent("disabled",this.state,this.channel))},e.prototype.logSocketError=function(e){var t=this.channel,n=this.state;this.logger.moiraeTeaLog({event:"socket_error",type:e,prevChannel:t,prevState:n})},e.prototype.fireEvent=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];try{var i=this.events[e];i&&i.apply(void 0,t)}catch(e){this.logger.logException(e)}},e.prototype.requestByHttp=function(e,t){var n=this,i=e.data&&e.data.type||t.url,r=e.req_id,o=e.context&&e.context.request_id||r;(0,P.Z)(t,["headers",O])===a.PB&&((0,H.Z)(e,"data.payload",function(e){for(var t=[],n=0;n<e.length;n+=32768)t.push(String.fromCharCode.apply(null,e.subarray(n,n+32768)));return btoa(t.join(""))}((0,P.Z)(e,"data.payload"))),(0,H.Z)(t,["headers",O],a.JSON)),this.logger.moiraeInfo("send req("+o+") "+i+" by http");try{10*Math.random()<1&&this.logger.moiraeTeaLog({key:"client_sheet_client_suit_request_http"})}catch(e){this.logger.logException(e)}var s=(t.headers||{}).path,c=t.host,u={url:t.url||(s?(void 0===c?"":c)+s:"/api/rce/messages"),method:"post",params:{member_id:this.memberId},data:e,timeout:this.getTimeout(t),headers:k(k({},V),t.headers),noStore:void 0===t.noStore||t.noStore},l=this.adapter.sendMessageByAxios(u).then(function(e){var t=e&&e.data;return t&&"ERROR"===t.type&&Z.includes(t.code)&&n.logger.moiraeInfo("RESOLVE req("+o+") for error code "+t.code),n.state===h.weakline&&n.addRecvCount(),n.logger.moiraeInfo("req("+o+") "+i+" by http is resolved"),n.stateMachine.sendMessageSuccess(),e}).catch(function(r){if(n.state===h.weakline&&n.resetRecvCount(),n.stateMachine.is("POOR_CONNECTION")&&5*Math.random()<1){var s=JSON.stringify(n.stateMachine.getStats());n.logger.moiraeTeaLog({event:"http_failure_weakly_connected",stats:s})}n.stateMachine.sendMessageFailure();var a=r&&("-8"===r.code||"ECONNABORTED"===r.code);return t.timeoutRetry&&a&&n.state!==h.offline?(n.logger.moiraeInfo("RESEND req("+o+") by http for error "+j(r)),n.requestByHttp(e,k(k({},t),{timeoutRetry:Math.max(0,t.timeoutRetry-1)}))):(n.logger.moiraeInfo("req("+o+") "+i+" by http is rejected for error "+j(r)),n.logger.moiraeCount("ee.docs.doc.client_io_rejected"),Promise.reject(r))});return l.reqId=e.req_id,l},e.prototype.requestBySocket=function(e,t){var n=this,i=e.data&&e.data.type,r=e.req_id,o=e.context&&e.context.request_id||r,s=new Promise(function(s,a){n.requests[r]={payload:e,options:t,resolve:s,reject:a,resendByHttp:function(){n.logger.moiraeInfo("RESEND req("+o+") "+i+" by http"),n.requestByHttp(e,t).then(s,a),delete n.requests[r]}},n.logger.moiraeInfo("send req("+o+") "+i+" by socket"),n.frontierClient&&n.frontierClient.send(e,t)?setTimeout(function(){if(n.requests[r]){if(0===n.requests[r].options.timeoutRetry)return void n.requests[r].reject(Error("req("+o+") "+i+" by socket timeout"));n.state===h.weakline&&n.resetRecvCount(),n.logger.moiraeInfo("req("+o+") "+i+" by socket timeout, #"+n.socketSendTimeoutTimes),n.socketSendTimeoutTimes+=1,2===n.socketSendTimeoutTimes&&n.refreshIfNotOffline("socket send timed out"),n.requests[r].resendByHttp()}},n.getTimeout(t),"socket timeout"):(n.logger.moiraeInfo("req("+o+") "+i+" by socket send failure"),n.requests[r].resendByHttp())});s.reqId=r;try{10*Math.random()<1&&this.logger.moiraeTeaLog({key:"client_sheet_client_suit_request_socket"})}catch(e){this.logger.logException(e)}return s},e.prototype.handleMessage=function(e){var t,n=this,i=e.payload,r=e.headers,o=void 0===r?[]:r,s=i.request_id,a=i.data,c=o.filter(function(e){return"req_id"===e.key})[0],u=o.filter(function(e){return"X-TT-LOGID"===e.key})[0];c&&(t=c.value),u&&(i.log_id=u.value);var l=i.req_id||t,p=a||{},f=p.code,d=p.type,g=p.over_size,y=this.requests;if(this.state===h.weakline&&this.addRecvCount(),5===f){this.logger.moiraeTeaLog({event:"ws_ticket_expired",requestType:d}),this.stateMachine.sendMessageFailure(),this.ticketManager.markTicketAsExpired(),this.ticketManager.loadTicket().then(function(e){if(null===e.ticket){n.logger.moiraeInfo("ABORT req("+s+") "+d+" due to failure to reload ticket"),l&&y[l]&&y[l].reject(Error("failed to reload ticket"));return}l&&y[l]&&(n.logger.moiraeInfo("RESEND req("+s+") "+d+" by http after reloading ticket"),y[l].resendByHttp())}),this.refreshIfNotOffline("ticket expired");return}if(l&&y[l]){if(this.stateMachine.sendMessageSuccess(),this.socketSendTimeoutTimes=0,1===g){this.logger.moiraeInfo("req("+s+") "+d+" by socket is oversize"),y[l].resendByHttp();return}this.logger.moiraeInfo("req("+s+") "+d+" by socket is resolved"),y[l].resolve(i),delete y[l];return}this.logger.moiraeInfo("message("+s+") "+d+" is received by socket"),this.logger.logOnPassiveMessageData(e),this.stateMachine.receivedBroadcastMessage(),this.fireEvent("broadcast",e)},e.prototype.getLogMessage=function(e){return"IO: memberId("+this.memberId+"): "+e},e.prototype.on=function(e,t){this.events[e]=t},e.prototype.isNewProtocol=function(){return!!this.config.businessType},e.prototype.getHost=function(){return this.config.host},e.DEFAULT_IO_CONFIG={timeout:15e3,maxSize:6e3,memberId:void 0,autoConnect:!0,initialTicket:void 0,host:"",routeType:"token",disableSocket:!1},e}(),ea=function(){function e(){this.callbacks=[],this.reset()}return e.prototype.reset=function(){this.callbacks=[]},e.prototype.triggerNotify=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.callbacks.forEach(function(t){t.apply(void 0,e)})},e.prototype.addListener=function(e){this.callbacks.push(e)},e.prototype.removeListener=function(e){this.callbacks=this.callbacks.filter(function(t){return t!==e})},e}();(s=p||(p={})).CONNECT_SOCKET="CONNECT_SOCKET",s.TRIGGER_ACTIVE_TAB="TRIGGER_ACTIVE_TAB",s.TRIGGER_INACTIVE_TAB="TRIGGER_INACTIVE_TAB",s.TRIGGER_ONLINE="TRIGGER_ONLINE",s.TRIGGER_VISIBLE="TRIGGER_VISIBLE",s.SCHEDULE="SCHEDULE",s.BUSINESS_CALL="BUSINESS_CALL",s.DEFAULT="DEFAULT";var ec=function(e){function t(n){var i=e.call(this,n)||this;return i.checkLastRequestIsActive=function(){return!!(0,x.Z)(i.isActive)&&i.isActive},i.defaultInactiveInterval=3e5,i.heartbeatIntervalForInactive=i.defaultInactiveInterval,i.heartbeatIntervalInactiveFromServer=i.defaultInactiveInterval,i.heartbeatIntervalMap={ONE_MIN:6e4,TWO_MIN:12e4,THREE_MIN:18e4,FOUR_MIN:24e4,FIVE_MIN:3e5},i.heartbeatIntervalForSocket=6e4,i.heartbeatIntervalForHttp=6e4,i.serverAndClientIntervalTime=void 0,i.scheduleHB=null,i.scheduleNewProtocolHB=null,i.hbErrorCount=0,i.hbSuccessCount=0,i.isHeartbeatRequestSending=!1,i.isNewHeartbeatRequestSending=!1,i.counter=0,i.newProtocolCounter=0,i.externalTabInactive=!1,i.isLatestHeartbeatFromIO=!1,i.isLatestNewHeartbeatFromIO=!1,i.watchEntitys=[],i.entities={},i.entityObservers=new Map,i.firstConnectSuccessHandle=function(){i.sendHeartbeats(void 0,void 0,{isFromIO:!0}),i.sendHeartbeats(void 0,void 0,{isNewHeartbeatsProtocol:!0,isFromIO:!0,triggerTime:p.CONNECT_SOCKET})},i.onlineStateHandle=function(e){i.schedule(!0,p.TRIGGER_ONLINE),i.channelStateCallbacker.triggerNotify(i.netState,e)},i.offlineStateHandle=function(e){i.channelStateCallbacker.triggerNotify(i.netState,e)},i.enabledHandle=function(e,t){i.channelStateCallbacker.triggerNotify(e,t)},i.disabledHandle=function(e,t){i.channelStateCallbacker.triggerNotify(e,t)},i.broadcastHandle=function(e){var n=e.payload,r=e.headers,o={type:"",token:""};(void 0===r?[]:r).forEach(function(e){var t=e.key,i=e.value;"topic_type"===t?(o.type=i,n.topicType=i):"topic_token"===t&&(o.token=i,n.topicToken=i)}),(0,N.Z)(i.entities,function(e){if(e){var r=e.messages,s=e.entity;(0,N.Z)(Object.values(r||{}),function(e){var i=e||{},r=i.handler,a=i.filter;t.keyOf(o)===t.keyOf(s)?r&&r(n):(!(0,A.Z)(a)&&(0,R.Z)(a)||(0,A.Z)(a)&&a(n)||(0,M.Z)(a)&&t.keyOf(a)===t.keyOf({type:n.type,token:(0,P.Z)(n,"data.token")}))&&r&&r(n)});var a=i.entityObservers.get(t.keyOf(e.entity));a&&a.forEach(function(e,t){try{e.messageHandler(n)}catch(e){i.logger.moiraeError("entityObserver handle message error: "+t,e)}})}})},i.visibilityChangeHandle=function(){if(i.checkLastRequestIsActive())return void console.info("[byted-x-io] visibilitychange pre is active, not send heartbeat");"visible"===document.visibilityState&&i.schedule(!0,p.TRIGGER_VISIBLE),console.info("[byted-x-io] visibilitychange",document.visibilityState)},i.scheduleFinallyCb=function(e){void 0===e&&(e=!1),e?i.scheduleNewProtocolHeartbeart():i.scheduleHeartbeart()},i.scheduleCatchCb=function(e,t){void 0===e&&(e=!1),i.hbErrorCount%3==0&&i.logger.moiraeTeaLog({key:"client_sheet_client_suit_hearbeat_error"}),i.logger.moiraeError("heartbeat error: "+j(t)),e?i.scheduleNewProtocolHeartbeart():i.scheduleHeartbeart(),i.logger.consoleError("\b\u5FC3\u8DF3\u5F02\u5E38:",t.message,t)},i.externalEntityInfoMap=new Map,i.channelStateCallbacker=new ea,i.on("online",i.onlineStateHandle),i.on("offline",i.offlineStateHandle),i.on("enabled",i.enabledHandle),i.on("disabled",i.disabledHandle),i.on("broadcast",i.broadcastHandle),i.on("visibilitychange",i.visibilityChangeHandle),i.on("firstConnectSuccess",i.firstConnectSuccessHandle),i.schedule(),i}return b(t,e),t.prototype.setHeartbeatIntervalInactiveFromServer=function(e){(this.heartbeatIntervalInactiveFromServer!==e||this.heartbeatIntervalForInactive!==e)&&(this.logger.moiraeInfo("set new heartbeat interval inactive for socket: "+e),this.heartbeatIntervalInactiveFromServer=e,this.heartbeatIntervalForInactive=e)},t.prototype.setHeartbeatIntervalForSocket=function(e){this.heartbeatIntervalForSocket!==e&&(this.logger.moiraeInfo("set new heartbeat interval for socket: "+e),this.heartbeatIntervalForSocket=e)},t.prototype.setHeartbeatIntervalForHttp=function(e){this.heartbeatIntervalForHttp!==e&&(this.logger.moiraeInfo("set new heartbeat interval for http: "+e),this.heartbeatIntervalForHttp=e)},t.prototype.setServerAndClientIntervalTime=function(e,t){this.serverAndClientIntervalTime=t/2+e-Date.now()},t.prototype.getServerAndClientIntervalTime=function(){return this.serverAndClientIntervalTime},t.prototype.calcHeartbeatInterval=function(){return this.externalTabInactive||"hidden"===document.visibilityState?this.heartbeatIntervalForInactive:this.channel===c.socket?this.heartbeatIntervalForSocket:this.heartbeatIntervalForHttp},t.keyOf=function(e){return e.type+":"+e.token},t.isEntityEqual=function(e,n){return t.keyOf(e)===t.keyOf(n)},t.prototype.triggerHeartbeatStabilityChange=function(e){var n=this;(0,N.Z)(this.entities,function(i){if(i){try{i.heartbeatStabilityChangeHandler&&i.heartbeatStabilityChangeHandler(e)}catch(e){n.logger.consoleError("entity.heartbeatStabilityChangeHandler error",e),n.logger.moiraeError("entity.heartbeatStabilityChangeHandler error",j(e))}var r=n.entityObservers.get(t.keyOf(i.entity));r&&r.forEach(function(t,i){try{t.heartbeatStabilityChangeHandler&&t.heartbeatStabilityChangeHandler(e)}catch(e){n.logger.consoleError("entityObserver.heartbeatStabilityChangeHandler error",i,e),n.logger.moiraeError("entityObserver.heartbeatStabilityChangeHandler error",i,j(e))}})}})},t.prototype.reset=function(){this.counter=0,this.newProtocolCounter=0,e.prototype.reset.call(this),this.channelStateCallbacker.reset(),this.scheduleHB&&(this.logger.moiraeTeaLog({event:"schedule_HB_reset"}),clearTimeout(this.scheduleHB),this.scheduleHB=null),this.entities={},this.externalEntityInfoMap.clear()},t.prototype.registerChannelState=function(e){this.channelStateCallbacker.addListener(e)},t.prototype.unregisterChannelState=function(e){this.channelStateCallbacker.removeListener(e)},t.prototype.closeChannel=function(){this.logger.moiraeTeaLog({event:"schedule_HB_closeChannel"}),this.scheduleHB&&clearTimeout(this.scheduleHB),this.closeSocket(),this.unmount(!1)},t.prototype.switchHeartbeatInactive=function(e){if(this.externalTabInactive=!0,!e){this.heartbeatIntervalForInactive=this.heartbeatIntervalInactiveFromServer||this.defaultInactiveInterval;return}this.heartbeatIntervalForInactive=this.heartbeatIntervalMap[e]||this.heartbeatIntervalInactiveFromServer||this.defaultInactiveInterval},t.prototype.switchHeartbeatActive=function(){this.externalTabInactive=!1,this.heartbeatIntervalForInactive=this.heartbeatIntervalInactiveFromServer||this.defaultInactiveInterval},t.prototype.setEntityExternalInfo=function(e,n){var i=this;if(void 0===e&&(e=[]),e){var r=!1;if(e.forEach(function(e){var n=t.keyOf(e.entity);i.externalEntityInfoMap.set(n,e),0===e.inactive&&(r=!0)}),!r)return void console.info("[byted-x-io] trigger_inactive_tab, not send heartbeat");if(this.checkLastRequestIsActive())return void console.info("[byted-x-io] trigger_active_tab pre is active, not send heartbeat");var o=n||(r?p.TRIGGER_ACTIVE_TAB:p.TRIGGER_INACTIVE_TAB);this.schedule(!0,o)}},t.prototype.sendHeartbeats=function(e,t,n){n&&n.isNewHeartbeatsProtocol?this.newProtocolCounter++:this.counter++,n&&n.triggerTime||(n=k(k({},n),{triggerTime:p.BUSINESS_CALL})),this.sendHeartbeatsInternal(e,t,n)},t.prototype.sendHeartbeatsInternal=function(e,n,i){var r,o=this;void 0===i&&(i={});var s=i.isNewHeartbeatsProtocol,a=void 0!==s&&s,c=i.isFromIO,u=void 0!==c&&c,l=i.isForceSend,f=i.triggerTime,d=void 0===f?p.DEFAULT:f,g={isNewHeartbeatsProtocol:""+a,isFromIO:""+u},y=Object.values(this.entities).filter(function(e){return!!e.isNewHeartbeatsProtocol==!!a}),v=y.map(function(e){return e.entity.type}).join(";");if(y.length<=0){this.logger.moiraeTeaLog(k({event:"entities_empty"},g)),e&&e();return}var m=a?this.isNewHeartbeatRequestSending:this.isHeartbeatRequestSending,b=a?this.isLatestNewHeartbeatFromIO:this.isLatestHeartbeatFromIO;if(m&&!(void 0!==l&&l)){this.logger.moiraeTeaLog(k(k({event:"is_sending_heartbeat"},g),{entitiesTypes:v,isLatestFromIO:""+b})),u&&e&&e();return}this.setHeartbeatsSendingStatus(!0,a);var E=[],I=[],O=a?this.newProtocolCounter:this.counter;if((0,N.Z)(y,function(e){var n=t.keyOf(e.entity);if(o.watchEntitys.some(function(e){return n===t.keyOf(e)})){var i=k(k({},e.entity),{modules:[]}),r=function(e,t){O>=e.counter+e.interval&&(I.push(e),i.modules.push(t))};(0,N.Z)(e.heartbeats,r);var s=o.entityObservers.get(n);s&&s.forEach(function(e){(0,N.Z)(e.heartbeats,r)});var a=(e.heartbeats.engine_channel||{}).version;"number"==typeof a&&(i.revisions={engine_channel:a});var c=o.externalEntityInfoMap.get(n);c&&(i.inactive=c.inactive),E.push(i)}}),E.length<=0){this.logger.moiraeTeaLog(k(k({event:"channels_empty"},g),{entitiesTypes:v})),this.setHeartbeatsSendingStatus(!1,a),e&&e();return}window.__HEARTBEAT_STATUS__=!0;var _={timeoutRetry:3,noStore:!0,noErrorRetry:!0};a?(this.isActive="visible"===document.visibilityState,r={channels:E,trigger_time:d,inactive:+!this.isActive,last_interval_inactive:this.heartbeatIntervalInactiveFromServer/1e3},_=k(k({},_),{headers:{path:"/api/rce/heartbeat"},host:this.getHost()}),console.info("[byted-x-io] send heartbeat visibilityState",document.visibilityState)):r={type:"COLLABROOM",data:{type:"USER_HEARTBEAT",member_id:this.getMemberId(),user_ticket:this.getTicket(),channels:E},version:2},this.setLatestHeartbeatIsFromIO(a,u);var w=Date.now();this.request(r,_).then(function(n){var i=n.data.server_time;i&&(w=Date.now()-w,er.setHeartbeatTime(i),o.setServerAndClientIntervalTime(i,w)),window.__HEARTBEAT_STATUS__=!1,o.setHeartbeatsSendingStatus(!1,a);try{o.netState===h.offline&&(o.logger.moiraeCount("ee.docs.sheet.client_suit_hearbeat_resume"),o.logger.moiraeTeaLog({key:"client_sheet_client_suit_hearbeat_resume"}));var r=Number(n.data.interval_inactive);r>0&&o.setHeartbeatIntervalInactiveFromServer(1e3*r);var s=Number(n.data.interval);if(s&&o.setHeartbeatIntervalForSocket(1e3*s),(0,L.Z)(n.data,"interval_http")){var c=Number(n.data.interval_http);c&&o.setHeartbeatIntervalForHttp(1e3*c)}else s&&o.setHeartbeatIntervalForHttp(1e3*s);var u=n.data.channel_info;(0,N.Z)(I,function(e){e.counter=O}),(0,N.Z)(u,function(e){var n=t.keyOf(e),i=o.entities[n];(0,R.Z)(i)||(0,N.Z)(e.modules,function(e){var t=e.name,r=parseInt(e.version,10),s=i.heartbeats[t],a=e.extra;if(!(0,R.Z)(s))try{o.checkHeartbeat(r,s,i,a)}catch(e){o.logger.moiraeInfo("module handle heartbeat failed, module: "+t+", heartbeatVerson: "+r)}var c=o.entityObservers.get(n);c&&c.forEach(function(e){try{var n=e.heartbeats[t];n&&o.checkHeartbeat(r,n,i)}catch(e){o.logger.moiraeInfo("entityObservers handle heartbeat failed, module: "+t+", heartbeatVerson: "+r)}})})})}catch(e){o.logger.moiraeInfo("heartbeat set interval_http time error, error: "+j(e))}o.logger.moiraeTeaLog(k(k({event:"send_heartbeat_end"},g),{entitiesTypes:v,intervalInactiveSocket:o.heartbeatIntervalInactiveFromServer,inactive:!o.isActive})),o.hbErrorCount=0,o.hbSuccessCount+=1,2===o.hbSuccessCount&&o.triggerHeartbeatStabilityChange(!0),e&&e()}).catch(function(e){window.__HEARTBEAT_STATUS__=!1,o.setHeartbeatsSendingStatus(!1,a),o.hbErrorCount+=1,o.hbSuccessCount=0,2===o.hbErrorCount&&(o.intoWeakOnline(),o.channelStateCallbacker.triggerNotify(o.netState,o.channel),o.triggerHeartbeatStabilityChange(!1)),n&&n(e)})},t.prototype.setHeartbeatsSendingStatus=function(e,t){t?this.isNewHeartbeatRequestSending=e:this.isHeartbeatRequestSending=e},t.prototype.setLatestHeartbeatIsFromIO=function(e,t){e?this.isLatestNewHeartbeatFromIO=t:this.isLatestHeartbeatFromIO=t},t.prototype.watchEntities=function(e,n,i){var r,o=this;void 0===n&&(n=0),void 0===i&&(i={});var s=i.isNewProtocol,a=void 0!==s&&s,c=e.reduce(function(e,t){return t&&t.token&&e.push(k({route_key:t.token,route_type:o.routeType},t)),e},[]);if(!c.length)return Promise.resolve();var h={};a?(r={member_id:String(this.getMemberId()),entities:c},h={headers:{path:"/api/room/watch"},host:this.getHost()}):r={type:"COLLABROOM",data:{type:"WATCH",entities:c}};var u=e.map(function(e){return e.type}).join(";");return this.logger.moiraeTeaLog({event:"send_watch",isNewProtocol:a,entitiesTypes:u}),this.request(r,h).then(function(e){var r=(0,P.Z)(e,"data.entities")||[],s=[];if(c.forEach(function(n){var i=t.keyOf(n),c=r.find(function(e){return i===t.keyOf(e)});if(!c||(a?0!==c.code:1!==c.succ)){o.logger.logWatchEntityFailure(n),s.push(k({},n));return}var h=o.entities[i];h&&h.acceptWatchHandler&&h.acceptWatchHandler(e)}),0!==s.length){if(n>=3)throw Error("failed to watch entities");return o.watchEntities(s,n+1,i)}})},t.prototype.unWatchEnities=function(e,n){var i,r=this,o=e.map(function(e){var n=t.keyOf(e);return r.logger.consoleWarn("delete entities key:",{key:n}),r.watchEntitys=r.watchEntitys.filter(function(e){return n!==t.keyOf(e)}),k({resource_type:"",route_key:e.token,route_type:r.routeType},e)}),s={};i={member_id:String(this.getMemberId()),entities:o},s={headers:{path:"/api/room/unwatch"},host:this.getHost()};var a=e.map(function(e){return e.type}).join(";");return this.logger.moiraeTeaLog({event:"send_unwatch",isNewProtocol:!0,entitiesTypes:a}),this.request(i,s).then(function(n){if((0,P.Z)(n,"data.code"),0!==n.code)throw Error("unwatch entities failed! "+{ens:e.map(function(e){return t.keyOf(e)}).join(" ")});return n})},t.prototype.schedule=function(e,t){void 0===e&&(e=!1),this.scheduleHeartbeart(e),this.scheduleNewProtocolHeartbeart(e,t)},t.prototype.scheduleHeartbeart=function(e){var t=this;void 0===e&&(e=!1),this.scheduleHB&&clearTimeout(this.scheduleHB);var n=e?0:this.calcHeartbeatInterval();this.scheduleHB=window.setTimeout(function(){if(t.netState===h.offline)return void t.scheduleHeartbeart();t.counter++,t.logger.moiraeInfo("send heartbeat, interval: "+n),t.sendHeartbeatsInternal(t.scheduleFinallyCb.bind(null,!1),t.scheduleCatchCb.bind(null,!1),{isNewHeartbeatsProtocol:!1,isFromIO:!0})},n)},t.prototype.scheduleNewProtocolHeartbeart=function(e,t){var n=this;void 0===e&&(e=!1),void 0===t&&(t=p.SCHEDULE),this.scheduleNewProtocolHB&&clearTimeout(this.scheduleNewProtocolHB);var i=e?0:this.calcHeartbeatInterval();this.scheduleNewProtocolHB=window.setTimeout(function(){if(n.netState===h.offline)return void n.scheduleNewProtocolHeartbeart();n.newProtocolCounter++,n.logger.moiraeInfo("send new protocol heartbeat, interval: "+i),n.sendHeartbeatsInternal(n.scheduleFinallyCb.bind(null,!0),n.scheduleCatchCb.bind(null,!0),{isNewHeartbeatsProtocol:!0,isFromIO:!0,triggerTime:t})},i)},t.prototype.checkHeartbeat=function(e,t,n,i){var r=t.version,o=t.callback;!(e<r)&&(t.version=e,o&&o(e,r,n,i))},t}(es),eh=function(e){function t(t){var n=e.call(this,t)||this;return t.getExternalExtensions&&Y.init(t.getExternalExtensions()),n.unloadHandle=n.unloadHandle.bind(n),n.on("unload",n.unloadHandle),n}return b(t,e),t.initHeartbeat=function(e){return k({interval:1,version:0,counter:0},e)},t.beats=function(e){return(0,F.Z)(e,function(e,n,i){return e[i]=t.initHeartbeat(n),e},{})},t.prototype.unloadHandle=function(){var e=(0,q.Z)(this.entities).map(function(e){return e.entity});this.unRegister(e)},t.prototype.registerEntityObserver=function(e,n){var i=ec.keyOf(e),r=(0,D.Z)(),o=this.entityObservers.get(i),s={heartbeats:t.beats(n.heartbeats),messageHandler:n.messageHandler,acceptWatchHandler:n.acceptWatchHandler,heartbeatStabilityChangeHandler:n.heartbeatStabilityChangeHandler};if(o)o.set(r,s);else{var a=new Map;a.set(r,s),this.entityObservers.set(i,a)}return r},t.prototype.updateEntityObserver=function(e,n,i){var r=ec.keyOf(e),o=this.entityObservers.get(r);if(!o)throw Error("no observers found: "+{key:r});var s=o.get(n);if(!s)throw Error("no observer found: "+{key:r}+" "+n);var a=i.heartbeats,c=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&0>t.indexOf(i)&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)0>t.indexOf(i[r])&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n}(i,["heartbeats"]),h=s.heartbeats;a&&(0,N.Z)(a,function(e,n){h[n]=t.initHeartbeat(e)}),o.set(n,k(k(k({},s),c),{heartbeats:h}))},t.prototype.unregisterEntityObserver=function(e,t){var n=ec.keyOf(e),i=this.entityObservers.get(n);i&&i.delete(t)},t.prototype.register=function(e,n){var i,r=ec.keyOf(e);this.entities[r]={entity:e,messages:((i={}).DEFAULT_MESSAGE=n.message,i),heartbeats:t.beats(n.heartbeats),isNewHeartbeatsProtocol:n.isNewHeartbeatsProtocol,acceptWatchHandler:n.acceptWatchHandler,heartbeatStabilityChangeHandler:n.heartbeatStabilityChangeHandler},this.mount(),this.logger.moiraeTeaLog({event:"register_entity",isNewHeartbeatsProtocol:n.isNewHeartbeatsProtocol,entityType:e.type})},t.prototype.unRegister=function(e){var t=this;e=(0,$.Z)(e)?e:[e];var n=[],i=[];e.forEach(function(e){var r=ec.keyOf(e),o=t.watchEntitys.some(function(e){return r===ec.keyOf(e)&&e.isNewProtocol});delete t.entities[r],t.externalEntityInfoMap.delete(r),o?i.push(e):n.push(e)});var r=[];if(n.length>0){var o=this.unWatchEnities(n,{isNewProtocol:!1});r.push(o)}if(i.length>0){var o=this.unWatchEnities(i,{isNewProtocol:!0});r.push(o)}return this.watchEntitys.length||this.unmount(!0),this.logger.moiraeTeaLog({event:"unregister_entity",hasNewProtocol:i.length>0,entitiesTypes:e.map(function(e){return e.type}).join(";")}),Promise.all(r)},t.prototype.watch=function(e,t){var n=Object.assign({isNewProtocol:!!t&&t.isNewProtocol},e);return this.watchEntitys.push(n),this.watchEntities([e],0,t)},t.prototype.watches=function(e,t){var n=e.map(function(e){return Object.assign({isNewProtocol:!!t&&t.isNewProtocol},e)});return this.watchEntitys=this.watchEntitys.concat(n),this.watchEntities(e,0,t)},t.prototype.unWatch=function(e,t){return this.unWatchEnities([e],t)},t.prototype.unWatches=function(e,t){return this.unWatchEnities(e,t)},t.prototype.addHeartbeat=function(e,n,i){var r=ec.keyOf(e),o=this.entities[r];if(!o)return void this.logger.consoleWarn("fail to add heartbeat because entity is not registered: ",{key:r});o.heartbeats[n]=t.initHeartbeat(i)},t.prototype.removeHeartbeat=function(e,t){var n=ec.keyOf(e),i=this.entities[n];if(!i)return void this.logger.consoleWarn("fail to remove heartbeat because entity is not registered: ",{key:n});delete i.heartbeats[t]},t.prototype.setHeartbeatVersion=function(e,t,n){var i=this,r=ec.keyOf(e),o=this.entities[r],s=o&&o.heartbeats&&o.heartbeats[t];s&&(s.version=n);var a=this.entityObservers.get(r);a&&a.forEach(function(e){try{var r=e.heartbeats[t];r&&(r.version=n)}catch(e){i.logger.consoleError("entityObservers handle heartbeat failed",t,n,e),i.logger.moiraeError("entityObservers handle heartbeat failed",t,n,j(e))}})},t.prototype.getHeartbeatInfo=function(e,t){var n=ec.keyOf({type:e,token:t}),i=this.entities[n];return i&&i.heartbeats?k({},i.heartbeats):null},t.prototype.removeMessage=function(e,t){var n=ec.keyOf(e),i=this.entities[n];if(!i)return void this.logger.consoleWarn("fail to remove heartbeat because entity is not registered: ",{key:n});delete i.messages[t]},t.prototype.addMessage=function(e,t,n){var i=ec.keyOf(e),r=this.entities[i];if(!r)return void this.logger.consoleWarn("fail to add message because entity is not registered: ",{key:i});r.messages[t]=n},t.prototype.isEntityRegistered=function(e){var t=ec.keyOf(e);if(!this.entities[t])return!1;var n=this.entities[t],i=n.messages,r=n.heartbeats;return!!Object.keys(i||{}).length||!!Object.keys(r||{}).length},t.prototype.getChannelState=function(){return this.channel},t}(ec),eu=n(483574),el=n(873833),ep=n(628023),ef=n(720878),ed=n(429917),eg=n(626622),ey=n(864757),ev=n(164287),em=n(539397),eb=function(){function e(e,t,n){var i=this;this.pingable=e,this.options=t,this.logger=n,this.rxOp=new w,this.reset$=new f.x,this.pongTimedOut$=new f.x,this.pingCount=0,this.lastPongAt=0,this.firstPingAt=0,this.isReceivedPong=!1,this.reset$.pipe(this.rxOp.takeUntil()).subscribe(function(e){return i.resetImpl(e)})}return e.prototype.getPingCount=function(){return this.pingCount},e.prototype.reset=function(e){this.reset$.next(e)},e.prototype.resetImpl=function(e){this.pingCount=0,e&&this.pingLoop()},e.prototype.pingLoop=function(){return E(this,void 0,void 0,function(){var e;return I(this,function(t){switch(t.label){case 0:this.firstPingAt=Date.now(),t.label=1;case 1:return this.isReceivedPong&&(this.firstPingAt=Date.now()),this.pingable.ping()&&(this.pingCount+=1,this.isReceivedPong=!1),this.isPongTimedOut()&&this.pongTimedOut$.next(),e=(0,K.H)(this.options.pingInterval).pipe((0,v.R)(this.reset$)),[4,this.rxOp.toPromise(e)];case 2:return t.sent(),[3,1];case 3:return[2]}})})},e.prototype.isPongTimedOut=function(){return Date.now()-this.firstPingAt>this.options.pongTimeout},e.prototype.onPongMessage=function(){this.lastPongAt=Date.now(),this.isReceivedPong=!0,this.logger.logPingPongTime(this.lastPongAt-this.firstPingAt)},e.prototype.destroy=function(){this.reset$.complete(),this.pongTimedOut$.complete(),this.rxOp.destroy()},e}(),ek=function(){function e(t,n){this.options=t,this.logger=n,this.connectionId=e.genNextConnectionId(),this.rxOp=new w,this.ws=null,this.message$=new f.x,this.close$=new f.x,this.error$=new f.x}return e.genNextConnectionId=function(){var e=this.nextConnectionId;return this.nextConnectionId+=1,e},e.prototype.getIsDestroyed=function(){return this.rxOp.destroy$.isStopped},e.prototype.getReadyState=function(){return this.ws?this.ws.readyState:null},e.prototype.getEndPoint=function(){return this.options.endPoint},e.prototype.getDeviceId=function(){return this.options.deviceId},e.prototype.connect=function(){return E(this,void 0,void 0,function(){var e,t,n,i,r=this;return I(this,function(o){switch(o.label){case 0:return this.logger.logBeforeConnectTo(this.connectionId,this.options.endPoint),e=Date.now(),(t=new WebSocket(this.options.url,this.options.protocols)).binaryType=this.options.binaryType,n=(0,eu.T)((0,el.R)(t,"open").pipe((0,ep.h)("OPEN")),(0,K.H)(this.options.connectTimeout).pipe((0,ep.h)("TIMEOUT")),(0,el.R)(t,"error").pipe((0,ep.h)("ERROR"))).pipe((0,y.q)(1),(0,ef.B)()),this.logger.logConnecting(this.connectionId),n.subscribe(function(n){r.logConnectTime(n,e),r.getIsDestroyed()&&r.closeWebSocket(t)}),[4,this.rxOp.toPromise(n)];case 1:return i=o.sent(),this.logger.logConnectResult(this.connectionId,i,t.readyState),"OPEN"===i&&(this.ws=t,this.registerWebSocketEvents(t)),[2,i]}})})},e.prototype.logConnectTime=function(e,t){var n=Date.now();"OPEN"===e&&this.logger.logConnectTime(this.connectionId,n-t)},e.prototype.registerWebSocketEvents=function(e){(0,el.R)(e,"message").pipe(this.rxOp.takeUntil()).subscribe(this.message$),(0,el.R)(e,"close").pipe(this.rxOp.takeUntil()).subscribe(this.close$),(0,el.R)(e,"error").pipe(this.rxOp.takeUntil()).subscribe(this.error$)},e.prototype.send=function(e){return!!this.canSend(this.ws)&&(this.ws.send(e),!0)},e.prototype.canSend=function(e){return null!==e&&e.readyState===WebSocket.OPEN},e.prototype.destroy=function(){this.logger.logConnectionDestroy(this.connectionId,null!==this.ws),this.message$.complete(),this.close$.complete(),this.error$.complete(),this.rxOp.destroy(),this.closeWebSocket(this.ws),this.ws=null},e.prototype.closeWebSocket=function(e){null!==e&&e.close()},e.nextConnectionId=0,e}();function eE(e,t,n){try{if(!t||10*Math.random()>1)return;window.collectEvent&&window.collectEvent("dev_io_event",{event:e,cost_time:Date.now()-n,msg:t.getEndPoint()})}catch(e){}}var eI=function(){function e(e,t,n){this.factory=e,this.options=t,this.logger=n,this.stopRaceOp=new w,this.stopSwitchOp=new w,this.activeConnection$=new z.X(null),this.newActiveConnection$=this.activeConnection$.asObservable().pipe((0,ed.T)(1),(0,ef.B)()),this.ticketManager=this.factory.getTicketManager(),this.lastEndPoint=null,this.message$=new f.x,this.close$=new f.x,this.error$=new f.x}return e.prototype.getActiveConnection=function(){return this.activeConnection$.getValue()},e.prototype.switch=function(){return E(this,void 0,void 0,function(){var e;return I(this,function(t){switch(t.label){case 0:if(this.logger.logBeforeSwitch(this.options.endPoints.length),this.options.endPoints.length<=1)return[2,null];return this.stopRaceAndSwitch(),[4,this.switchImpl()];case 1:return e=t.sent(),this.logger.logAfterSwitch(null!==e),this.stopRaceAndSwitch(),null!==e&&this.setNewActiveConnection(e),[2,e]}})})},e.prototype.switchImpl=function(){return E(this,void 0,void 0,function(){var e,t,n,i,r,o,s,a=this;return I(this,function(c){switch(c.label){case 0:e=this.options.endPoints.filter(function(e){return e!==a.lastEndPoint}),null!==this.lastEndPoint&&e.unshift(this.lastEndPoint),t=0,n=e,c.label=1;case 1:if(!(t<n.length))return[3,4];return i=n[t],r=this.factory.createSwitchRetryController(),o=Date.now(),this.logger.logBeforeSwitchingToEndPoint(i),[4,this.tryCreatingConnectionWithRetry(i,r,this.stopSwitchOp)];case 2:if(s=c.sent(),this.logger.logAfterSwitchingToEndPoint(i,null!==s),null===s)return[3,3];return eE("ws_switch_result",s,o),[2,s];case 3:return t++,[3,1];case 4:return[2,null]}})})},e.prototype.race=function(){return E(this,void 0,void 0,function(){var e,t;return I(this,function(n){switch(n.label){case 0:return this.logger.logBeforeRace(),this.stopRaceAndSwitch(),e=Date.now(),[4,this.raceImpl()];case 1:return eE("ws_race_result",t=n.sent(),e),this.logger.logAfterRace(),this.stopRaceAndSwitch(),this.setNewActiveConnection(t),[2,t]}})})},e.prototype.raceImpl=function(){return E(this,void 0,void 0,function(){var e,t=this;return I(this,function(n){var i;return e=this.stopRaceOp.from(this.options.endPoints).pipe((0,eg.z)(function(e){var n=t.factory.createRaceRetryController();return t.tryCreatingConnectionWithRetry(e,n,t.stopRaceOp)}),(i=function(e){return null!==e},function(e){return e.pipe((0,g.h)(i),(0,y.q)(1))})),[2,this.stopRaceOp.toPromise(e)]})})},e.prototype.tryCreatingConnectionWithRetry=function(e,t,n){return E(this,void 0,void 0,function(){var i,r,o,s;return I(this,function(a){switch(a.label){case 0:n.destroy$.pipe((0,y.q)(1)).subscribe(function(){return t.destroy()}),a.label=1;case 1:if(!t.canRetry())return[3,5];return[4,n.toPromise(t.timeout())];case 2:return a.sent(),this.logger.logBeforeLoadingTicket(),[4,n.toPromise(this.ticketManager.loadTicket())];case 3:if(r=(i=a.sent()).ticket,o=i.isFromCache,this.logger.logAfterLoadingTicket(null!==r,o),null===r)return[3,1];return o||t.reset(),[4,n.toPromise(this.tryCreatingConnection(e,r,n))];case 4:if(null===(s=a.sent()))return[3,1];return[2,s];case 5:return[2,null]}})})},e.prototype.tryCreatingConnection=function(e,t,n){return E(this,void 0,void 0,function(){var i,r,o;return I(this,function(s){switch(s.label){case 0:return i=this.factory.createWebSocketConnection(e,t),r=n.destroy$.pipe((0,ep.h)(null)),[4,(0,eu.T)(i.connect(),r).pipe((0,y.q)(1)).toPromise()];case 1:if("OPEN"===(o=s.sent()))return[2,i];return null===o&&this.logger.logConnectionDestroyedByStopOp(i.connectionId),i.destroy(),[2,null]}})})},e.prototype.refresh=function(){return E(this,void 0,void 0,function(){return I(this,function(e){switch(e.label){case 0:return this.destroyActiveConnection(),[4,this.switch()];case 1:if(null!==e.sent())return[3,3];return[4,this.race()];case 2:e.sent(),e.label=3;case 3:return[2]}})})},e.prototype.destroyActiveConnection=function(){var e=this.getActiveConnection();null!==e&&(e.destroy(),this.activeConnection$.next(null))},e.prototype.setNewActiveConnection=function(e){var t=this,n=this.getActiveConnection();null!==n&&n.destroy(),this.activeConnection$.next(e),this.lastEndPoint=e.getEndPoint(),e.message$.pipe((0,v.R)(this.newActiveConnection$)).subscribe(function(e){return t.message$.next(e)}),e.error$.pipe((0,v.R)(this.newActiveConnection$)).subscribe(function(e){return t.error$.next(e)}),e.close$.pipe((0,v.R)(this.newActiveConnection$)).subscribe(function(e){t.destroyActiveConnection(),t.close$.next(e)})},e.prototype.stopRaceAndSwitch=function(){this.stopRaceOp.destroy$.next(),this.stopSwitchOp.destroy$.next()},e.prototype.reset=function(){this.destroyActiveConnection(),this.stopRaceAndSwitch()},e.prototype.destroy=function(){this.destroyActiveConnection(),this.activeConnection$.complete(),this.message$.complete(),this.close$.complete(),this.error$.complete(),this.stopRaceOp.destroy(),this.stopSwitchOp.destroy()},e}(),eO=function(){function e(e){this.strategy=e,this.rxOp=new w,this.retryIndex=-1,this.timeoutPromise=null}return e.prototype.canRetry=function(){return this.retryIndex<this.strategy.maxRetryTimes},e.prototype.timeout=function(){return E(this,void 0,void 0,function(){var e;return I(this,function(t){return(e=this.strategy.getRetryInterval(this.retryIndex),this.retryIndex>=this.strategy.maxRetryTimes||null===e)?(this.retryIndex=this.strategy.maxRetryTimes,[2]):(null===this.timeoutPromise&&(this.timeoutPromise=this.timeoutImpl(e)),[2,this.timeoutPromise])})})},e.prototype.timeoutImpl=function(e){return E(this,void 0,void 0,function(){return I(this,function(t){switch(t.label){case 0:return[4,this.rxOp.toPromise((0,K.H)(e))];case 1:return t.sent(),this.timeoutPromise=null,this.retryIndex=(this.retryIndex+1)%this.strategy.maxRetryTimes,[2]}})})},e.prototype.reset=function(){this.rxOp.destroy$.next(),-1!==this.retryIndex&&(this.retryIndex=0),this.timeoutPromise=null},e.prototype.destroy=function(){this.reset(),this.rxOp.destroy()},e}(),e_={nested:{protocol:{nested:{Frame:{fields:{seqid:{rule:"required",type:"uint64",id:1},logid:{rule:"required",type:"uint64",id:2},service:{rule:"required",type:"int32",id:3},method:{rule:"required",type:"int32",id:4},headers:{rule:"repeated",type:"ExtendedEntry",id:5},payloadEncoding:{type:"string",id:6},payloadType:{type:"string",id:7},payload:{type:"bytes",id:8},LogIDNew:{type:"string",id:9}},nested:{ExtendedEntry:{fields:{key:{rule:"required",type:"string",id:1},value:{rule:"required",type:"string",id:2}}}}}}}}},ew=function(){function e(e){this.config=e,this.package=null,this.lookupType="protocol.Frame"}return e.prototype.encode=function(e){var t=this.getPackage(),n=t.verify(e);if(n)throw Error(n);var i=t.create(e);return t.encode(i).finish()},e.prototype.decode=function(e,t){var n=this.getPackage(),i=n.decode(new em.util.Array(e));return n.toObject(i,t)},e.prototype.getServiceId=function(){return this.config.serviceId},e.prototype.formatMessage=function(e,t,n){return void 0===t&&(t={}),void 0===n&&(n=""),{seqid:1,logid:1,service:this.getServiceId(),method:1,payloadType:"json",headers:Object.keys(t).map(function(e){return{key:e,value:t[e]}}),LogIDNew:n,payload:e}},e.prototype.getPackage=function(){var e=this.lookupType;return this.package||(this.package=em.Root.fromJSON(e_).root.lookupType(e)),this.package},e}(),eT=function(e){function t(t){return e.call(this,t)||this}return b(t,e),t.prototype.pack=function(e,t){var n=this.formatMessage(JSON.stringify(e),t.headers,t.LogIDNew),i=this.parseBytesFields(n,function(e){return ev.Base64.encode(String(e))});return this.encode(i)},t.prototype.unpack=function(e){var t=this.decode(e,{longs:String,enums:String,bytes:String});return this.parseBytesFields(t,function(e){var t=ev.Base64.decode(String(e));try{return JSON.parse(t)}catch(e){return t}})},t.prototype.parseBytesFields=function(e,t){var n=this.getPackage().fields,i={};for(var r in n)!0===n[r].bytes?i[r]=t(e[r]):i[r]=e[r];return i},t}(ew),eC=function(e){function t(t){return e.call(this,t)||this}return b(t,e),t.prototype.pack=function(e,t){var n=this.formatMessage((0,P.Z)(e,"data.payload"),t.headers,t.LogIDNew);return this.encode(n)},t.prototype.handlePayload=function(e){return{code:0,type:"",data:e.payload,headers:e.headers}},t.prototype.unpack=function(e){var t=this.decode(e,{longs:String,enums:String});return(0,H.Z)(t,"payload",this.handlePayload(t)),t},t}(ew),eS=function(){function e(e){this.commonDataPackager=new eT(e),this.pbDataPackager=new eC(e)}return e.prototype.getPackage=function(e){return e===a.PB?this.pbDataPackager:this.commonDataPackager},e.prototype.pack=function(e,t){var n=_((0,P.Z)(t,["headers",O],""));return this.getPackage(n).pack(e,t)},e.prototype.unpack=function(e){var t=this.commonDataPackager.unpack(e),n="";return((0,N.Z)((0,P.Z)(t,"headers"),function(e){if("downstream_encoding"===e.key)return n=e.value,!1}),_(n)===a.PB)?this.pbDataPackager.unpack(e):t},e}(),eN=function(){function e(e){this.retryIntervalAfterLastRetry=e,this.isFirstRetry=!0,this.maxRetryTimes=3}return e.prototype.getRetryInterval=function(e){return -1===e?this.retryIntervalAfterLastRetry?0:Math.floor(40*Math.random()*1e3):this.isFirstRetry||0!==e?(this.isFirstRetry=!1,Math.floor(10*Math.random()*1e3)+5e3*e):this.retryIntervalAfterLastRetry},e}(),eP=function(){function e(e,t,n,i){this.ticketManager=e,this.webSocketConfig=t,this.frontierConfig=n,this.logger=i}return e.prototype.createWebSocketConnection=function(e,t){return new ek(this.makeWebSocketOptions(e,t),this.logger)},e.prototype.getTicketManager=function(){return this.ticketManager},e.prototype.createRaceRetryController=function(){return new eO(new eN(12e4))},e.prototype.createSwitchRetryController=function(){return new eO(new eN(null))},e.prototype.makeWebSocketOptions=function(e,t){var n,i,r,o,s,a,c=this.makeFrontierQuery(this.frontierConfig,t),h=(i=(n={url:e,query:c}).url,r=n.query,o=n.path,s=S.parse(location.href,!0),a=S.parse(i,!0),/\/\//.test(i)||(a.href=s.protocol+"//"+i,a.hostname=i),a.protocol=a.protocol||("http:"===s.protocol?"ws:":"wss:"),a.query=Object.assign(a.query,r,{stamp:Date.now()}),a.query=Object.assign(a.query,r),a.path=void 0===o?null:o,S.format(a)),u=c.device_id,l=this.webSocketConfig;return{url:h,deviceId:u,endPoint:e,protocols:l.protocols,binaryType:l.binaryType,connectTimeout:l.connectTimeout}},e.prototype.makeFrontierQuery=function(e,t){var n=e.fpid,i=e.appKey,r=e.accessSalt,o=e.noteToken,s=e.query,a=s&&s.device_id||U(o);return k(k({},s),{device_id:a,access_key:this.makeAccessKey(n,i,a,r),session_ticket:t})},e.prototype.makeAccessKey=function(e,t,n,i){return C()(""+e+t+n+i)},e}(),eH=function(){function e(e,t,n,i,r,o){var s=this;this.ticketManager=e,this.webSocketConfig=t,this.wsManagerOptions=n,this.frontierConfig=i,this.pingPongOptions=r,this.logger=o,this.rxOp=new w,this.wsManager=new eI(new eP(this.ticketManager,this.webSocketConfig,this.frontierConfig,this.logger),this.wsManagerOptions,this.logger),this.message$=new f.x,this.close$=this.wsManager.close$.asObservable(),this.error$=this.wsManager.error$.asObservable(),this.newActiveConnection$=this.wsManager.newActiveConnection$,this.pingPongCtrl=new eb(this,this.pingPongOptions,this.logger),this.pongTimeout$=this.pingPongCtrl.pongTimedOut$.asObservable(),this.packager=new eS(this.frontierConfig),this.wsManager.message$.pipe((0,ey.U)(function(e){return e.data}),this.rxOp.takeUntil()).subscribe(function(e){return s.handleMessageData(e)}),this.wsManager.newActiveConnection$.pipe((0,ey.U)(function(e){return null!==e}),this.rxOp.takeUntil()).subscribe(function(e){return s.pingPongCtrl.reset(e)})}return e.prototype.handleMessageData=function(e){if(this.isPongMessage(e))return void this.pingPongCtrl.onPongMessage();var t=this.packager.unpack(e);this.logger.logOnMessageData(t),this.sendMessageAck(t),t&&"string"!=typeof t&&this.message$.next(t)},e.prototype.isPongMessage=function(e){return e===this.pingPongOptions.message},e.prototype.sendMessageAck=function(e){e.headers&&e.headers.find(function(e){return"need_ack"===e.key&&"1"===e.value})&&this.send({},{headers:{is_ack:"1",ack_code:"0"},LogIDNew:e.LogIDNew||""})},e.prototype.ping=function(){var e=this.wsManager.getActiveConnection();if(null===e)return!1;var t=e.send(this.pingPongOptions.message);if(t){var n=this.pingPongCtrl.getPingCount();this.logger.logPingSuccess(n+1)}else this.logger.logPingFailure();return t},e.prototype.send=function(e,t){var n=this.wsManager.getActiveConnection();return null!==n&&n.send(this.packager.pack(e,t))},e.prototype.connect=function(){return this.wsManager.race()},e.prototype.refresh=function(){this.wsManager.refresh()},e.prototype.reset=function(){this.wsManager.reset()},e.prototype.destroy=function(){this.message$.complete(),this.wsManager.destroy(),this.pingPongCtrl.destroy(),this.rxOp.destroy()},e}(),ex=function(e){function t(t){return e.call(this,t)||this}return b(t,e),t.prototype.loadFrontierClient=function(){return Promise.resolve(eH)},t}(eh)},582436:function(e,t,n){"use strict";n.d(t,{mj:()=>c,wK:()=>s}),(i=o||(o={})).MESSENGER="messager",i.CCM="ccm",i.CALENDAR="calendar",i.EMAIL="email",i.OPENPLATFORM="openPlatform",i.VC="vc",(r=s||(s={})).MESSENGER_CHAT="messenger_chat",r.MESSENGER_CHAT_SHARED_LINK_CARD="messenger_chat_shared_link_card",r.MESSENGER_SEARCH_LINK="messenger_search_link",r.MESSENGER_INCHAT_SEARCH_LINK="messenger_inchat_search_link",r.MESSENGER_PROFILE="messenger_profile",r.MESSENGER_SITE="messenger_site",r.MESSENGER_FAVORITE="messenger_favorite",r.MESSENGER_PIN="messenger_pin",r.MESSENGER_FILE="messenger_file",r.EVENT_DESCRIPTION="event_description",r.EVENT_ATTACHMENT_PREVIEW="event_attachment_preview",r.EMAIL_BODY="email_body",r.EMAIL_ATTACHMENT_PREVIEW="email_attachment_preview",r.CCM_DOCS="ccm_docs",r.CCM_SHEET="ccm_sheet",r.CCM_SLIDES="ccm_slides",r.CCM_BITABLE="ccm_bitable",r.CCM_MINDNOTE="ccm_mindnote",r.CCM_DRIVE="ccm_drive",r.DRIVESDK_CREATION="drivesdk_creation",r.DOCS_SDK_COMMENT="docs_sdk_comment",r.BITABLE_SDK_APPBUILDER="bitable_sdk_appbuilder",r.MESSENGER_GROUP_ANNOUNCEMENT="messenger_group_announcement",r.OPENDOC_CONFERENCE_RECORDS="opendoc_conference_records",r.OP_GADGET="op_gadget",r.OP_MESSAGE_CARD="op_message_card",r.OP_H5="op_H5",r.CCM_DEFAULT="ccm_default";var i,r,o,s,a={enable:!0,whiteList:[],baseUrl:"",interceptors:[]};function c(e,t){return void 0===t&&(t={}),function(e,t){void 0===t&&(t={});var n,i,r=(a.interceptors||[]).reduce(function(t,n){return t||n(e)},"");if(r)return{secure:!0,targetUrl:r};var s=(i=e,!a.enable||"string"==typeof i&&!!i&&(!!/^(mailto|tel):/.test(i)||(/^(?:(\w+)\:)?\/\//.test(i)||(i="http://"+i),n=function(e){try{return new URL(e).hostname}catch(n){var t=/^((\w+):)?(\/\/((\w+)?(:(\w+))?@)?([^\/\?:]+)(:(\d+))?)?(\/?([^\/\?#][^\?#]*)?)?(\?([^#]+))?(#(\w*))?/.exec(e);return t&&t[8]||""}}(i),a.whiteList.some(function(e){return e instanceof RegExp?e.test(n):"string"==typeof e?new RegExp(e).test(n):"function"!=typeof e||e(n)})))),c=s?e:function(e,t){var n=t.baseUrl||a.baseUrl;if(!n)return e;var i=t.scene||o.CCM,r=function(e){if(e.lang)return e.lang;try{return navigator.language||""}catch(e){return""}}(t);return n+"?target="+encodeURIComponent(e)+"&scene="+i+"&logParams="+encodeURIComponent(JSON.stringify(t.logParams||{}))+"&lang="+r}(e,t);return{secure:s,targetUrl:c}}(e,t).targetUrl}},724091:function(e){e.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t||4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,(function(t){return e[t]}).bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){"use strict";function i(e){var t=e.indexOf(":");if(t>-1&&(e=e.slice(0,t)),e.split(":")[0].split(".").every(function(e){return isFinite(parseInt(e))})||"localhost"===e)return"";var n=e.split(".");return n.length>2?n.slice(-2).join("."):e}t.__esModule=!0,t.noop=t.generateOneId=t.once=t.warn=t.error=t.getMainDomain=t.getMainDomainFromUrl=t.isSSR=t.isProd=void 0,t.isProd=!0,t.isSSR="undefined"==typeof window,t.getMainDomainFromUrl=function(e){var t=e.indexOf("://");t>-1&&(e=e.slice(t+3));var n=e.lastIndexOf(":");n>-1&&(e=e.slice(0,n));var r=e.indexOf("/");return r>-1&&(e=e.slice(0,r)),i(e)},t.getMainDomain=i,t.error=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.isProd||console.error.apply(console,e)},t.warn=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];t.isProd||console.warn.apply(console,e)},t.once=function(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];e.apply(void 0,t)}},t.generateOneId=function(){var e=Math.floor(1e6*Math.random()).toString(),t=Date.now().toString().slice(-13);if(e.length<6){var n=6-e.length,i=Math.floor(Math.random()*(12-n));e+=t.substr(i,n)}return""+e+t},t.noop=function(){}},function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||i(t,e,n)};t.__esModule=!0,t.UniUUID=void 0,r(n(3),t),r(n(0),t);var o=n(0);function s(e,t,n){return Array.isArray(t)?t.forEach(function(t){return e[t]=n}):e[t]=n,e}t.UniUUID=function(){function e(e){this.uuid="",this.teaCookie=null,this.teaCookieParsed=!1;var t=e.teaAppID,n=e.cookieStore,i=e.checkTeaCookieTimeout,r=e.fromTeaCookieKey,o=e.toTeaConfigKey;this.teaAppID=t,this.cookieStore=n,this.checkTeaCookieTimeout=i||6e4,this.fromTeaCookieKey=void 0===r?"web_id":r,this.toTeaConfigKey=void 0===o?"one_id":o}return e.prototype.execute=function(e,t){t=o.once(t||o.noop);var n=this.getClientUUIDCookie();return n?this.haveUUIDCookie(n,t):this.noUUIDCookie(e,t),this.uuid},e.prototype.haveUUIDCookie=function(e,t){this.uuid=e,t(s({},this.toTeaConfigKey,e))},e.prototype.noUUIDCookie=function(e,t){var n=o.getMainDomainFromUrl(e.url),i=this.getClientTeaCookie(!0),r=i&&i[this.fromTeaCookieKey]||o.generateOneId();this.setUUIDCookie(r,n),t(s({},this.toTeaConfigKey,r))},e.prototype.getUUID=function(){return this.uuid},e.prototype.getClientUUIDCookie=function(){return this.cookieStore.get(e.COOKIE_KEY)},e.prototype.getTeaCookieName=function(){return"__tea_cookie_tokens_"+this.teaAppID},e.prototype.getClientTeaCookie=function(e){if(!e&&this.teaCookieParsed)return this.teaCookie;this.teaCookieParsed=!0;var t=this.getTeaCookieName(),n=this.cookieStore.get(t);if(n){var i=decodeURIComponent(decodeURIComponent(n));try{this.teaCookie=JSON.parse(i)}catch(e){o.error("failed to parse cookie "+t+" ["+n+"]: "+e)}}else if("undefined"!=typeof localStorage){var r="__tea_cache_tokens_"+this.teaAppID;try{var s=localStorage.getItem(r);s&&(this.teaCookie=JSON.parse(s))}catch(e){o.error("failed to parse localStorage "+r+": "+e)}}return this.teaCookie},e.prototype.setUUIDCookie=function(t,n){this.uuid=t,this.cookieStore.set(e.COOKIE_KEY,t,{domain:n,maxAge:e.COOKIE_MAX_AGE})},e.COOKIE_KEY="__tea__ug__uid",e.COOKIE_MAX_AGE=7776e3,e}()},function(e,t,n){"use strict";var i,r=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},s=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||t.hasOwnProperty(n)||s(t,e,n)};t.__esModule=!0,t.getUUID=t.init=t.BrowserUniUUID=void 0,a(n(1),t);var c=n(1),h=n(0),u=n(4),l=function(e){function t(t){return e.call(this,o(o({},t),{cookieStore:u.cookie}))||this}return r(t,e),t.prototype.handle=function(t){if(h.isSSR)return h.warn("uni-ug-uuid: will not config tea in ssr"),"";var n={url:location.href};return e.prototype.execute.call(this,n,function(e){e&&delete e.timestamp,(t||h.noop)(e)})},t.TIMEOUT=1e4,t}(c.UniUUID);t.BrowserUniUUID=l;var p=null;t.init=function(e,t){return(p=new l(e)).handle(t)},t.getUUID=function(){return null!==p?p.getUUID():(h.error("UniUUID not init, please invoke function 'init' first"),"")}},function(e,t,n){"use strict";t.__esModule=!0},function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};t.__esModule=!0,t.cookie=t.parseCookie=t.serializeCookie=t.DEFAULT_COOKIE_MAX_AGE=void 0;var r=n(0);function o(e,n,o){if(n=function(e){if(["string","number","boolean","undefined"].indexOf(typeof e)>-1)return e;try{var t=JSON.stringify(e);if(/^[{[]/.test(t))return t}catch(e){r.error(e)}return e}(n),(o=i({path:"/",maxAge:t.DEFAULT_COOKIE_MAX_AGE},o)).maxAge){var s=o.maxAge-0;if(isNaN(s)||!isFinite(s))throw Error("invalid maxAge: "+o.maxAge);o.maxAge=Math.floor(s)}var a=[];for(var c in o){var h=o[c];if(null!=h){var u="maxAge"===c?"max-age":c;a.push("; "+u),!0!==h&&("string"!=typeof h?a.push("="+o[c]):a.push("="+o[c].split(";")[0]))}}return e+"="+n+a.join("")}function s(e,t){for(var n=e?e.split("; "):[],i=t+"=",r=null,o=0;o<n.length;o++){var s=n[o];0===s.indexOf(i)&&(r=s)}return r?r.substring(i.length,r.length):""}t.DEFAULT_COOKIE_MAX_AGE=172800,t.serializeCookie=o,t.parseCookie=s,t.cookie={set:function(e,t,n){document.cookie=o(e,t,n)},get:function(e){return s(document.cookie,e)},remove:function(e,t){document.cookie=o(e,"",{maxAge:-1,domain:t})}}}])},356896:function(e,t,n){"use strict";n.d(t,{lv:()=>i});var i="FOLLOW_CLICK_THROUGH_AREA_SIZE"}}]);